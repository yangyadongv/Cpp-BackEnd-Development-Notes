written by 杨亚东  yangyadongv@hust.edu.cn

[TOC]

# 计网——韩立刚版网课个人笔记

## 1.概述

### 1.1计算机网络在信息时代的作用

- 21 世纪的一些重要特征就是**数字化、网络化和信息化**，它是一个以网络为核心的信息时代。
- **网络是指“三网”，即电信网络、有线电视网络和计算机网络。**
  - 计算机网络又分为因特网和其他网络
- **计算机网络的重要功能**
  - **连通性**：彼此连通，交换信息
  - **共享**：信息共享、软硬件共享

### 1.2因特网概述

####  1.2.1网络的网络(network of networks，互联网)

* 起源于美国的因特网现已发展成为世界上最大的国际性计算机互联网 
* 网络(network)由若干结点(node)和连接这些结点的链路(link)组成。 
* 互联网是“网络的网络”(network of networks)。 
* 连接在因特网上的计算机都称为主机(host)。 
* 网络与因特网
  * 网络:	许多计算机连接在一起。
    * ![image.png](https://i.loli.net/2020/10/10/q7a4SsRcbt5vGPM.png)
  * 互联网：许多网络连接在一起。
  * 因特网：全球最大的一个互联网。
    * 因特网把许多网络连接在一起。
    * ![image.png](https://i.loli.net/2020/10/10/4cofq96w8Nn5AyZ.png)

#### 1.2.2因特网发展的三个阶段

- 第一阶段是从单个网络 ARPANET 向互联网发展的过程。
  - 1983 年 TCP/IP 协议成为 ARPANET 上的标准协议。
  - 人们把 1983 年作为因特网的诞生时间。
- 第二阶段的特点是建成了三级结构的因特网。	
  - 三级计算机网络，分为主干网、地区网和校园网（或企业网）。 
- 第三阶段的特点是逐渐形成了多层次 ISP 结构的因特网。
  - 出现了**因特网服务提供者 ISP (Internet Service Provider)**。
    - ![image.png](https://i.loli.net/2020/10/10/nKtudsRwQeoWgkC.png)
    - ![image.png](https://i.loli.net/2020/10/10/SHz8xnj3qMObVWP.png)
  - 根据提供服务的覆盖面积大小以及所拥有的IP 地址数目的不同，ISP 也分成为不同的层次。
    - ![image.png](https://i.loli.net/2020/10/10/pPYAeZTgOIQNqjH.png)

#### 1.2.3因特网的标准化工作

因特网协会 ISOC来定义标准。

* RFC: Request For Comments，请求评议。是一种在线的技术报告，任何人都可以下载
  * 所有的互联网标准都是以RFC的形式在互联网上发表的。所有的RFC文档都可以从互联网上免费下载。并非所有的RFC文档都是互联网标准，只有很少的RFC文档最后变成了互联网标准。
* 制订因特网的正式标准要经过以下的四个阶段 
  * 因特网草案(Internet Draft) ——在这个阶段还不是 RFC 文档。
  * 建议标准(Proposed Standard) ——从这个阶段开始就成为 RFC 文档。
  * 草案标准(Draft Standard)
  * 因特网标准(Internet Standard) 
* 各种RFC之间的关系
  * ![image.png](https://i.loli.net/2020/10/10/X8ftVWDcISaEO94.png)

### 1.3因特网的组成

![image.png](https://i.loli.net/2020/10/10/OwlUXk7p3DSVrYo.png)

![image.png](https://i.loli.net/2020/10/10/WMjd3EJyloCQrst.png)

#### 1.3.1因特网的边缘部分（服务器、计算机等）

**简介：**

由所有连接在因特网上的主机组成。这部分是用户直接使用的，用来进行通信（传送数据、音频或视频）和资源共享。

* 处在因特网边缘的部分就是连接在因特网上的所有的主机。这些主机又称为端系统(end system)。
* “主机 A 和主机 B 进行通信”，实际上是指：“运行在主机 A 上的某个程序和运行在主机 B 上的另一个程序进行通信”。
* 即“主机 A 的某个进程和主机 B 上的另一个进程进行通信”。或简称为“计算机之间通信” 

**因特网的边缘部分的通信方式：**

- 客户服务器方式(Client/Server方式 --C/S)
  - 比如，通过浏览器访问网站。客户A向服务器B发出请求服务，而服务器B向客户A提供服务。
  - ![image.png](https://i.loli.net/2020/10/10/ItZXKEVWhCUeYMR.png)
- 对等(Peer-to-Peer方式--P2P)方式
  - 每个用户机，又可以变为服务器，也就是用户越多，可供下载源越多

#### 1.3.2因特网的核心部分（网络、路由器）

**简介：**

由大量网络和连接这些网络的路由器组成。这部分是为边缘部分提供服务的（提供连通性和交换）

* 网络核心部分是因特网中最复杂的部分。
* 网络中的核心部分要向网络边缘中的大量主机提供连通性，使边缘部分中的任何一个主机都能够向其他主机通信（即传送或接收各种形式的数据）。
* 在网络核心部分起特殊作用的是路由器(router)。
  * 路由器是实现分组交换(packet switching)的关键构件，其任务是存储转发收到的分组，这是网络核心部分最重要的功能。
    * 在路由器中的输入和输出端口之间没有直接连线。
    * 路由器处理分组的过程是：
      * 把收到的分组先放入缓存（暂时存储）；
      * 查找转发表，找出到某个目的地址应从哪个端口转发；
      * 把分组送到适当的端口转发出去。 
* **路由器**是实现分组交换(packet switching)的关键构件，**其任务是存储转发收到的分组（Packet）**，这是网络核心部分最重要的功能。 
  * 路由器可以暂存数据，但不能存太多。主要功能还是转发。
  * 暂存的目的是Packet可能需要在该路由器排队，所以先接受下来存起来排队，等着路由器转发完前一个再转发新的Packet

**因特网核心部分的通信方式：**

数据交换方式:

- 电路交换(Circuit Switching)
  - 需要在通信之前先建立连接。建立连接以后这条线路就被占用了，别人不可以用
  - 例如：两个电话机的通信。
  - 电路交换适合于数据量很大的实时性传输：
  -  核心路由器之间有可能（非必要）使用电路交换。（可以，但是可能没必要）
- 报文交换(Message Switching)
  - 与分组交换的区别是不分组。数据直接整个加上发送地址目标地址，然后就发送。
  - 报文一般比分组的单个数据长的多，因为它不分段
  - 报文交换的时延较长
- **分组交换**(Packet Switching)
  - ![image.png](https://i.loli.net/2020/10/10/2Z4vnQlKhMxbUiE.png)
  - 每一个分组（Packet）可能从发送端到接收端走的路径都不一样
  - 所以分组交换里，不需要提前建立连接，线路谁都可以用
  - 优点：高效、灵活、迅速、可靠
  - 缺点：时延、开销

### 1.4计算机网络在我国的发展

中国在1994年4月20日正式接入互联网

到现在网民已经9亿

![image.png](https://i.loli.net/2020/10/10/nKtudsRwQeoWgkC.png)

这就是每个因特网服务提供者 ISP。每个ISP会获得不同的IP地址段。

### 1.5计算机网络的类别

计算机网络最简单的定义：一些互相连接的、自治的计算机的集合

* 不同作用范围的网络 
  * 广域网 WAN (Wide Area Network)
    * 比如ADSL拨号上网
    * 花钱买服务，花钱买带宽
  * 局域网 LAN (Local Area Network) 
    * 小于100M的，自己连起来的
    * 自己购买设备，自己维护，带宽固定，距离100米以内
  * 城域网 MAN (Metropolitan Area Network)
  * 个人区域网 PAN (Personal Area Network) 
* 从网络的使用者进行分类 
  * 公用网 (public network) 
  * 专用网 (private network) 
* 从拓扑结构分类
  * 总线型
  * 环型
  * 星型
    * 比如说各个电脑接到交换机
  * 树型
    * 根交换机、分支交换机、分支交换机
  * 网状
    * 用路由器连的网就是网状
* 从交换方式分类
  * 电路交换网
  * 报文交换网
  * 分组交换网
    * 应该没有前边两类，一般都是分组交换的网
* 从工作方式分类
  * 资源子网
  * 通信子网
  * 接入网

### 1.6计算机网络的性能

* **速率**
  * 含义：**连接在计算机网络上的主机在数字信道（某一个服务器到你的某个应用，比如在线看电影就是一个信道；下载资料，又是另一个信道）上传送数据位数的速度，也称为data rate或bit rate**
  * **速率的单位是 b/s，或kb/s, Mb/s, Gb/s 等**
  * 比特（bit）是计算机中数据量的单位，也是信息论中使用的信息量的单位。
  * Bit 来源于 binary digit，意思是一个“二进制数字”，因此一个比特就是二进制数字中的一个 1 或 0。
  * 速率即数据率(data rate)或比特率(bit rate)是计算机网络中最重要的一个性能指标。
  * 速率往往是指额定速率或标称速率。  
* **带宽** 
  * 含义：**网卡或者网络设备这个接口所能传送的最高速率，例如我的网卡就是100Mb/s，这就是上限。**
  * “带宽”(bandwidth)本来是指信号具有的频带宽度，单位是赫（或千赫、兆赫、吉赫等）。
    * 所以，信号具有的频带宽度越长，速率也越高，但是没有直接的换算关系。比如ADSL里，上行使用20KhZ到138KhZ的频段，速率约为640Kb/s。而下行使用138KhZ到1.1MHZ的频段，速率约为8Mb/s。
    * 
  * 现在“带宽”是数字信道所能传送的“最高数据率”的同义语，单位是“比特每秒”，或 b/s (bit/s)。 
  * 常用的带宽单位
    * 更常用的带宽单位是
    * 千比每秒，即 kb/s （103 b/s）
    * 兆比每秒，即 Mb/s（106 b/s）
    * 吉比每秒，即 Gb/s（109 b/s）
    * 太比每秒，即 Tb/s（1012 b/s）
    * 请注意：在计算机界，K = 2^10 = 1024
    * M = 2^20, G = 2^30, T = 2^40。
  * 数字信号流随时间的变化
    * 在时间轴上信号的宽度随带宽的增大而变窄。
* **吞吐量**
  * **含义：所有信道加起来同时通过网卡或者网络设备的速率，它理论上不会大于带宽。**
  * 吞吐量(throughput)表示在单位时间内通过某个网络（或信道、接口）的数据量。
  * 吞吐量更经常地用于对现实世界中的网络的一种测量，以便知道实际上到底有多少数据量能够通过网络。
  * 吞吐量受网络的带宽或网络的额定速率的限制。  
* **时延(delay 或 latency)**
  * 传输时延（发送时延 ）：发送这个数据包需要多少时间
    * 发送数据时，数据块从结点进入到传输媒体所需要的时间。
    * 也就是从发送数据帧的第一个比特算起，到该帧的最后一个比特发送完毕所需的时间。 
  * 传播时延    电磁波在信道中需要传播一定的距离而花费的时间。 
    * 信号传输速率（即发送速率）和信号在信道上的传播速率是完全不同的概念。 
  * 处理时延    交换结点（路由器）为存储转发而进行一些必要的处理所花费的时间。 
    * 数据包到了得处理，不是直接转发
  * 排队时延    结点缓存队列中分组排队所经历的时延。（比如，你发送的数据在路由器上得排队；你的网卡接受数据，那也有不同应用接收的先后，也得排队）
    * 排队时延的长短往往取决于网络中当时的通信量。
    * 数据经历的总时延就是发送时延、传播时延、处理时延和排队时延之和： 
* **时延带宽积**
  * 含义是：这个数据链路上，能够承载的，**数据量的大小。**（链路上充满数据时，有多少数据）
  * 链路的时延带宽积又称为以比特为单位的链路长度。 
* **往返时间**
  * RTT：Round-Trip Time
  * **从发送方发送数据开始，到发送方收到接收方确认的时间**，即Ping命令
  * 局域网一般小于1ms
* **利用率**
  * **含义：有数据通过的时间除以（有+无）数据通过的时间。**
  * **信道或网络利用率过高产生非常大的时延**
  * 信道利用率指出某信道有百分之几的时间是被利用的（有数据通过）。完全空闲的信道的利用率是零。
  * 网络利用率则是全网络的信道利用率的加权平均值。
  * 信道利用率并非越高越好。 
  * 时延与网络利用率的关系
    * 根据排队论的理论，当某信道的利用率增大时，该信道引起的时延也就迅速增加。 
    * 若令 D0 表示网络空闲时的时延，D 表示网络当前的时延，则在适当的假定条件下，可以用下面的简单公式表示 D 和 D0之间的关系：
      * U 是网络的利用率，数值在 0 到 1 之间。 

### 1.7计算机网络的体系结构

#### 1.7.1OSI七层（理解为7个步骤）

程序开发人员需要考虑应用层、表示层、会话层

网络管理员负责传输层、网络层、数据链路层

物理层有标准化设备，不用人管理。

**OSI七层**

- 应用层：能够产生网络流量，能够和用户交互的应用程序
  - qq
- 表示层：加密、压缩。开发人员需要考虑的问题
  - 压缩视频，再解压缩
  - 再比如，IE浏览器查看网页，用了不同的编码方式来查看，变成乱码了，拿过来数据，理解出现错误，这就是表示层出现了问题
- 会话层：服务端和客户端建立的会话
  - 病毒是消耗资源破坏系统，木马程序是盗窃信息，远程控制，监视机器。
  - 可以通过netstat -nb查木马。
    - 一开机，不建立任何其他网络流量。就看看谁还建立了会话，谁有会话谁就可能是木马程序。
    - 木马程序肯定是要跟外界通信的，它要是不跟外界建立通信，那就是卧槽马，没办法造成危害。
- 传输层：可靠传输、不可靠传输、流量控制
  - 可靠传输（建立会话）
    - 网上下载电影，500M分成一个个数据包分组交换。中间要是丢了俩包，就得重传。
  - 不可靠传输（不建立会话）
    - 举例，qq聊天，输入你好，回车发送。后边还不指定第二句话什么时候发送，所以没必要建立会话一直保持连接
    - 对方收不到怎么办，qq替你尝试多次发送，试了5s钟还不通，弹个框告诉你消息发送失败
    - 域名解析：域名要变成IP地址才能上网，这时候就需要需要解析。丢个包问百度的IP地址是多少，某个平台自动给你反馈是多少，然后拿到IP你就能访问百度了
  - 流量控制
    - 比如服务器和客户在通信，客户端处理不过来了，告诉一下服务端，你先暂停一下，等会儿再传
- 网络层：IP地址编址、选择最佳路径
  - 选择最佳路径：用动态路由协议，这一堆路由器会自动选择最佳路径
- 数据链路层：
  - 传输数据形式：帧
  - 规定了数据如何封装，添加物理层地址MAC
- 物理层：
  - 传输数据形式：比特流，010101
  - 规定了电压标准、接口标准
  - 多少伏代表0，多少伏代表1
  - 网线接口，也得统一

**分层的好处：**

1. 有利于标准化
2. 每一层的变化不会影响其它层

**网络排错：**

1.看看网线插好了没（物理层）

2.IP地址设对了没（网络层）

3.IE浏览器是不是中了恶意插件（应用层）



**网络安全和OSI参考模型：**

- 1.物理层安全：
  - 不是你们单位的电脑，不应该有机会接入交换机
- 2.数据链路层安全：
  - ADSL拨号上网。
  - 无线网络密码。
- 3.网络层安全
  - 同一个路由器出来的网络，设置一下，某些网段不可以访问internet，某些网段可以
- 4.应用层安全
  - SQL注入漏洞、上传漏洞

#### 1.7.2 TCP/IP四层或者五层模型

![image.png](https://i.loli.net/2020/10/12/au5Q6kJhKcHpoCY.png)



TCP/IP 是四层的体系结构：应用层、运输层、网络层和网络接口层。



![image.png](https://i.loli.net/2020/10/12/m2Kw8rJzs9xEW5l.png)

**五层协议对应的数据单元**

- 1.应用层
  - 里的内容：传输数据单元PDU
  - 比如一整个电影
- 2.运输层
  - 里的内容：运输层报文
  - 将上一层的数据分段并编号
  - 使用TCP、UDP协议
- 3.网络层
  - 里的内容：IP数据报（IP分组）
  - 将上一层的数据段加上IP地址，即表明从哪到哪
  - 所以数据报（包）里包括IP地址
- 4.数据链路层
  - 里的内容：数据帧
  - 在上一层基础上再加上MAC地址，即物理层地址
- 5.物理层
  - 里的内容：bit，01011110000
  - 在上一层基础上加上帧头帧尾，就可以传输了

![image.png](https://i.loli.net/2020/10/12/zj98pbE6JveF5wf.png)



#### 1.7.3开放系统信息交换涉及的几个概念

- 实体：交换信息的硬件或软件进程
- 协议：控制两个对等实体通信的规则
- 服务：下层为上层提供服务，上层需要使用下层提供的服务来实现本层的功能
- 服务访问点（SAP）：相邻两层实体间交换信息的地方

### 1.8OSI七层模型详解（第二次笔记）

#### 应用层

- 提供用户接口，特指能够发起网络通信的应用程序
  - 客户端程序：QQ，MSN，浏览器等
  - 服务器程序：Web服务器、邮件服务器、流媒体服务器等等。
- 根据互联网中需要通信的应用程序的功能，定义客户端和服务端程序通信的规范，应用层向表示层发出请求。

#### 表示层

- 使用何种编码方式。比如要传输的数据使用ASClI编码，Unicode编码还是二进制文件，是否要加密和压缩。发送端和接收端程序必须使用相同的编码方式，才能正确显示，否则就产生乱码。
- **定义编码格式、是否加密或压缩**。例如，FTP允许你选择以二进制或ASCII格式传输。如果选择二进制，那么发送方和接收方不改变文件的内容。如果选择ASCII格式，发送方将把文本从发送方的字符集转换成标准的ASCII后发送数据。在接收方将标准的ASCII转换成接收方计算机的字符集。
- 例如：
  - 压缩：QQ视频聊天，每一帧图像其实是很大的，QQ开发者采用了最先进的无损压缩算法。发送方在发送时先压缩了，等接收方收到数据到表示层时，再无损解压恢复出来，这样即节省了流量带宽，又保证了图像无损。
  - 加密：例如QQ聊天内容，传输时候聊天内容是加密的，传到接收方时，再解密出来。中间数据即使被黑客捕获了，黑客也无法得知俩人在聊什么，因为黑客不知道腾讯公司用的内容加密解密的秘钥。
  - 编码格式：文件在传的时候，要想正确显示文本（字符）内容，就得使用正确的编码格式，否则就是乱码。
    - 美国的ASCII，一个字符8位，即一个字节。
    - UTF8，既能显示汉字，又能显示英文。
    - web服务器把网页通过utf8字符集进行编码，编成二进制。客户端收到二进制，再通过utf8字符集，恢复成汉字、英文。
    - 一头用utf8编码，另一头用ascii解码，那绝对恢复出来是乱码。
    - 乱码就是表示层出了问题。
    - 源文件里一般写了编码格式。接收方也应该按照这个格式进行表示层的恢复。
    - ![image-20210113170410823](http://pichost.yangyadong.site/img/image-20210113170410823.png)
    - ![image-20210113170245893](http://pichost.yangyadong.site/img/image-20210113170245893.png)
    - ![image-20210113172317135](http://pichost.yangyadong.site/img/image-20210113172317135.png)
    - 可以看到，同样的文本“韩立刚”，用不同的编码方式，编出来16进制内容不一样。接收方拿到的都是二进制流，因此解码也得使用与编码时相同的编码格式，才能恢复出正确的文本“韩立刚”。
- 有的文件没有字符，不需要字符编码，比如 图片、exe文件，那就是二进制文件，打开它就是010101。

#### 会话层

- 通信的应用程序之间建立、维护和释放**面向用户的连接**。通信的应用程序之间建立会话，需要传输层建立1个或多个连接。
- 它定义了如何开始、控制和结束一个会话，包括对多个双向消息的控制和管理，以便在只完成连续消息的一部分时可以通知应用，从而使表示层看到的数据是连续的。
- 注意 会话层的连接与传输层的连接不一样：
  - 会话层面向用户。
  - 传输层面向数据报文或者是字节流。
  - **会话层连接面向用户，就一个。**
  - **但是会话层可以使用多个传输层连接，或者一个传输层连接。**
  - ![image-20210113174536935](http://pichost.yangyadong.site/img/image-20210113174536935.png)
  - 可以看到，访问https://yangyadong.site，会话层上来看，是我的浏览器要跟服务器建立一个会话层连接。但是实际上**一个会话层连接建立了一堆传输层连接。**

#### 传输层

- 负责在通信的两个计算机之间建立连接。实现可靠的或不可靠的数据通信，能够实现发送端和接收端的丢包重传，流量控制。
- 常规数据递送，面向连接或无连接。面向连接实现可靠传输，比如TCP协议；面向无连接，提供不可靠传输，比如UDP协议。
- 数据类型：
  - UDP面向报文。TCP面向字节流，加上传输层首部（源端口，目标端口等），封装成一组一组，或者叫段。

#### 网络层

- 路由器查看数据包目标IP地址，根据路由表为数据包选择路径。路由表中的条自可政人工添加(静态路由）也可以动态生成（动态路由）。
- **路由器根据网络IP地址为数据包选择转发路径**。网络层为传输层提供服务，只是尽力转发数据包，不保证不丢包，也不保证按顺序到达接收端。
- 路由器上的动态路由协议，RIP协议认为跳数最少的路径最优，OSPF认为带宽最高的链路最优
- 数据类型：
  - 将TCP的段加上IP首部（源IP，目标IP等），封装成数据包

#### 数据链路层

- 数据链路层常简称链路层，两台主机之间的数据传输，总是在一段一段的链路上传送的，这就需要专门的链路层的协议。
- 不同的网络类型，发送数据的机制不同，**数据链路层就是将数据包封装成能够在不同网络间（路由器隔开就是不同的网络）传输的帧**。能够进行差错检查，但不纠错，检测出错误丢掉该帧。
- ![image-20210113211247169](http://pichost.yangyadong.site/img/image-20210113211247169.png)
- 不同的数据链路还使用不同的数据链路层协议。
- 数据类型：
  - 将网络层的数据报加上MAC帧首帧尾（源MAC，目标MAC等），封装成数据帧。

#### 物理层

- 在物理层上所传输的数据单位是比特。发送方发送1（或0）时，接收方应该收到1（或0），而不是0（或1）。因此物理层要考虑用多大电压代表“1”或“0”，以及接收方如何识别出发送方所代表的比特。物理层还要确定连接电缆的的插头应当有多少根引脚以及各条引脚应如何连接。
- 该层规定了网络设备接口标准,电压标准。尽可能的通过频分复用、时分复用技术在通信链路上更快的传输数据。
- 比如：以太网网线有8根线。广域网接口有多少根线。
- 数据类型：
  - 比特流。可能是电信号、可能是光信号。

## 2.物理层

### 2.0物理层的基本概念

物理层解决如何在连接各种计算机的传输媒体上传输数据比特流，而不是指具体的传输媒体。

 物理层的主要任务描述为:确定与传输媒体的接口的一些特性，即： 

- 机械特性:  例接口形状，大小，引线数目
- 电气特性：例规定电压范围(-5V到+5V)
- 功能特性：例规定-5V表示0，＋5V表示1
- 过程特性：也称规程特性，规定建立连接时各个相关部件的工作步骤

### 2.1奈氏准则和香农公式

- ![image.png](https://i.loli.net/2020/11/17/2XWMNTivFzDL8Oh.png)

- 奈氏准则（不考虑噪声，从数据层面上，一旦比它大，就会出现码间串扰）：

  - 理想低通信道的最高码元传输速率=2W Baud
    - W是理想低通信道的带宽，单位为HZ。
    - Baud是波特，是码元传输速率的单位

- 香农公式（考虑上信道噪声，这个极限速率肯定要比那个奈氏准则约束的速率更低一点）：

  - 信道的极限信息传输速率 C 可表达为        C = W log2(1+S/N)  b/s 
    - W 为信道的带宽（以 Hz 为单位）
    - S 为信道内所传信号的平均功率
    - N 为信道内部的高斯噪声功率

- 结论就是：信道的频段（带宽）越宽，极限速率（带宽）越快

  - 现在的带宽都混为一谈了，本来应该指频段，但在计算机上都指速率了
  - 比如方案A是0.5GHz到1.5GHz的频段，共1GHz。方案B是10GHz到10.1GHz，共0.1GHz
  - 那么方案A肯定比方案B的传输速率快，因为它的频段更宽（与0.5还是10这种载波频率的绝对值没有关系，只与宽度有关），那么到底是多少bit/s呢，没有直接的换算公式。

  ### 2.2物理层下面的传输媒体

分为两类：引导型传输媒体和非引导型传输媒体

#### 2.2.1引导型传输媒体

- 双绞线
  - 无屏蔽双绞线
  - 屏蔽双绞线（就是普通的双绞线加了一层金属屏蔽层，抗干扰能力强）
- 同轴电缆
  - 有线电视
- 光缆

#### 2.2.2非引导型传输媒体（电磁波、无线电）

短波通信：靠大气中电离层的反射

微波通信：在空气中直线传播，靠接收塔往前传输

#### 2.2.3集线器（hub，现在已经被交换机替代了）

它在网络中只起到信号放大和重发作用，其目的是扩大网络的传输范围，而不具备信号的定向传送能力

最大传输距离：100m

集线器是一个大的冲突域：因为在某一个时间里只允许一个信道通信。并且它不安全，它会给所有连接设备发送一样的数据。

#### 2.2.3码分复用（手机里用的就是这个）

![image.png](https://i.loli.net/2020/10/13/wV2d1lMFzypShEB.png)

R是所有信号的叠加。传到每个人手机上，自动开始跟手机自带的码片内积，结果是0则没有你的消息。结果是1，那就是给你发了1，结果是-1，那就是给你发了0.

### 2.3宽带接入技术（如何让网民接入到internet上去）

#### 2.3.1铜线接入（使用电话线接入internet）

- 铜线宽带接入技术也就是xDSL（各种类型DSL（Digital Subscriber Line）数字用户线路的总称）技术，就是用数字技术对现有的模拟电话用户线进行改造，使它能够承载宽带业务
- ADSL属于DSL技术的一种，全程 Asymmetric Digital Subscriber Line（非对称数字用户线路）。使用数字技术对现有的模拟电话用户线进行改造，使其能够承载带宽数字业务。
- ADSL的非对称体现在，上行和下行带宽不一样。上行指从用户到ISP，下行指从ISP到用户。
- ![image.png](https://i.loli.net/2020/11/16/JGiRBqcMTWdmkuh.png)
- 可用频段越长（并不是频段的绝对值，而是看它的范围），那传输速率越快。但是没有直接的换算关系。
  - ADSL里，上行使用20KhZ到138KhZ的频段。速率约为640Kb/s
  - 下行使用138KhZ到1.1MHZ的频段。速率约为8Mb/s
  - 电话使用0-4Khz频段
- 对于家庭个人用户来说，使用非对称的DSL即ADSL比较好。因为下载远多于上传。
- 但是对于公司等，上传下载同样重要，那么就得使用对称的DSL

#### 2.3.2光纤同轴混合网（HFC网）（使用有线电视的同轴电缆接入internet）

- 改造原有模拟电视信道，保留电视信号的同时，实现上网功能
- ![image.png](https://i.loli.net/2020/11/16/MoYycErjgKU8s92.png)
- 头端是一个设备，接受卫星信号，然后先通过光纤传输，再通过同轴电缆接到家家户户
  - 现在头端在调制上Internet信号，一起传输
- ![image.png](https://i.loli.net/2020/11/16/XBzd2xYaNMgQpfP.png)

#### 2.3.3光纤接入技术（专门为小区居民等架设光缆，这种技术在城市里比较普及，农村里还是电话线或者有线电视同轴电缆比较普遍）

- 从技术上讲，光纤到户FTTH（Fiber To The Home）是最好的选择。光纤入户，就是把光纤一直铺设到用户家庭，在用户的家中才把光信号转换成电信号，这样用户可以得到更高的上网速录
- 光电调制解调器：即猫modulation

#### 2.3.4移动互联网接入技术（手机的3G、4G、5G等，这种是手机通过4G技术与基站相连，基站提供到internet的连接）

- 移动互联网，就是将移动通信和互联网二者结合起来，成为一体
- 4G全IP网络
  - 一个基站一个网段，从一个基站移动到另一个基站需要更改IP地址
  - ![image.png](https://i.loli.net/2020/11/16/2HzN5ITOu3byjPw.png)
- 基于子网的4G IP网络
  - ![image.png](https://i.loli.net/2020/11/16/t2NQD8u6RoPlB1T.png)
  - 跟4G全IP网络的区别是，现在是很多个基站组成一个同一个网段的子网，在这个子网内移动，切换基站，不需要更改IP地址。
  - 而4G全IP网是一个基站就是一个子网，切换基站必定会更改IP

### 2.4总结

- 奈氏准则（不考虑噪声，从数据层面上，一旦比它大，就会出现码间串扰）：
  - 理想低通信道的最高码元传输速率=2W Baud
    - W是理想低通信道的带宽，单位为HZ。
    - Baud是波特，是码元传输速率的单位
- 香农公式（考虑上信道噪声，这个极限速率肯定要比那个奈氏准则约束的速率更低一点）：
  - 信道的极限信息传输速率 C 可表达为        C = W log2(1+S/N)  b/s 
    - W 为信道的带宽（以 Hz 为单位）
    - S 为信道内所传信号的平均功率
    - N 为信道内部的高斯噪声功率
- 结论就是：**信道的频段（带宽）越宽，极限速率（带宽）越快**
  - **现在的带宽都混为一谈了，本来应该指频段，但在计算机上都指速率了**
  - 比如方案A是0.5GHz到1.5GHz的频段，共1GHz。方案B是10GHz到10.1GHz，共0.1GHz
  - 那么方案A肯定比方案B的传输速率快，因为它的频段更宽（与0.5还是10这种载波频率的绝对值没有关系，只与宽度有关），那么到底是多少bit/s呢，没有直接的换算公式。
- 信道复用
  - 频分复用：数字信号转成模拟信号（电信号），多个模拟信号占用不同频段
  - 时分复用：这就是直接的数字信号传输，均匀分配时间片去传输
  - 波分复用：数字信号转成光信号，多个光信号占用不同频段，即光信号的频分复用
  - 码分复用：即手机与基站之间的连接方式，每个手机有一个自己的唯一的码片。基站发送的信号是给每个手机的信号的叠加。手机自己通过码片去解调。

## 3.数据链路层

### 3.0数据发送模型

![image.png](https://i.loli.net/2020/10/21/PV3SluQeXKsiFyT.png)

### 3.1数据链路层基本概念及基本问题

数据链路层传送的是帧，加入了帧头帧尾。也就是说判断帧的开始和结束，是

![image.png](https://i.loli.net/2020/10/13/69gCEyvafLx4pbw.png)

**数据链路层三个基本问题：**

- 1.**封装成帧**
  - 封装成帧(framing)就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。确定帧的界限。
  - 首部和尾部的一个重要作用就是进行帧定界。
  - ![image.png](https://i.loli.net/2020/10/13/t2n1oeVRwXYxhO4.png)
  - 帧还未发送完，发送端出了问题，只能重发该帧。接收端却收到了前面的“半截子帧”，那会抛弃这半截的帧。必须有帧头帧尾。
- 2.**透明传输**（传的过程中，在数据链路层往里边加了转义字符，其它层并没有知觉，并不知道你加了）
  - 帧头帧尾说白了就是特殊的一些字符，假如你传输的数据中刚好包含了该字符，那会被误认为是帧尾结束
  - ![image.png](https://i.loli.net/2020/10/13/XhuSefTBvl7od2R.png)
  - **解决方法：**发送端的数据链路层在**数据中出现控制字符“SOH”或“EOT”的前面插入一个转义字符“ESC”**(其十六进制编码是 1B)。
    - 即，将数据中偶然出现的刚好等于帧头帧尾字符的数据之前加上一个ESC限定标签
    - 字节填充(byte stuffing)或字符填充(character stuffing)——接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。
    - **如果转义字符也出现数据当中，那么应在转义字符前插入一个转义字符**。当接收端收到连续的两个转义字符时，就删除其中前面的一个。
    - ![image.png](https://i.loli.net/2020/10/13/I5hwOLfdgVuS6oA.png)
    - 接收者需要再删去该ESC转义字符
- 3.**差错控制**
  - 传输过程中可能会产生比特差错：1 可能会变成 0 而 0 也可能变成 1。
  - 在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率 BER (Bit Error Rate)。（误码率与信噪比有很大的关系。）
  - 为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测措施。
  - **解决方法：**循环冗余检验 CRC
    - 在数据链路层传送的帧中，广泛使用了循环冗余检验 CRC 的检错技术。
    - 算出来的那个余数可以是叫做帧检验序列FCS的一种
    - 在数据后面添加上的冗余码称为帧检验序列 FCS (Frame Check Sequence)。
    - 循环冗余检验 CRC 和帧检验序列 FCS并不等同。
      - CRC 是一种常用的检错方法，而 FCS 是添加在数据后面的冗余码。
      - FCS 可以用 CRC 这种方法得出，但 CRC 并非用来获得 FCS 的唯一方法。
  - **CRC只保证了接收端近乎100%的无差错的接收。**
    - 要是一算余数不为0，那我接收端就丢掉
    - 那丢包了？那是让发送端重传，数据链路层不管你怎么重新传，它只管检查传过来的序列对不对。序列对（余数为0），接受；序列不对（余数不为0），丢掉。
    - 除数的位数越高，则越接近100%

### 3.2两种情况下的数据链路层（两种数据链路层）

#### 3.2.1使用点对点信道的数据链路层（PPP，拨号上网的那种链路）

在通信线路质量较差的年代，高级数据链路控制HDLC是当时的流行数据链路层协议。

到当下时代，已经被PPP替代。

##### 1.PPP（Point-to-Point Protocol）协议

IETF认为，PPP协议需要满足这些需求:

- 简单
- **封装成帧**
- **透明性**
- 支持多种网络层协议
  - 也就是PPP协议不仅支持，还可以标识网络层是TCPIP协议还是IPX协议。
  - 比如声音是链路层，那么可以承载中文，也可以承载英文，就是要标识一下。让接收端按中文理解还是英文理解。
  - 例如同时支持网络控制协议NCP中的IPCP、CDPCP协议。
- 支持多种类型链路
  - 电话线、双绞线、同轴电缆、光纤
- **差错检测**
- 检测链接状态
  - 欠费、电话线没接好、账号密码没输对，会提示不同的错误信息
- 最大传送单元 
  - 1500Byte
- 网络层地址协商
  - PPP拨号拨通之后，ISP给我们分配一个网络层地址
- 数据压缩协商

##### 2.PPP协议的组成

![image.png](https://i.loli.net/2020/10/14/MsqnLAHhZCT1XS8.png)



- NCP。（网络控制协议）允许在点到点连接上使用多种网络层协议
  - LCP通过了，NCP才能使用。
  - 举例：IPCP、CDPCP协议。
- LCP。（链路控制协议）建立并维护数据链路连接。
  - 它负责实名验证。它通过之后，网络层控制协议NCP就能用了。协商IP地址
- HDLC。（数据链路层协议）可以用于异步串行或同步串行介质。
  - 在现代internet中HDLC已经被PPP替代，HDLC仅出现在传统的电信网络设备上了。
  - 换句话说，也可以理解为，PPP是HDLC的高阶版本，又多了很多东西（LCP、NCP）。
  - 当然PPP的最下层，也可以不是HDLC，可以是别的将IP数据报封装到串行链路的方法。

##### 3.PPP协议的帧格式(PPP帧是PPP帧，它是点对点，所以目标地址没有用，与MAC帧完全不同)

![image.png](https://i.loli.net/2020/10/14/sHz7xjicpNn8q4u.png)

- F：
  - 帧头开始标识
  - 1个字节
  - 值：0x7E
- A：
  - 目标地址。
  - 1个字节
  - 由于在点对点这种链路里，目标地址没有用。
  - 所以固定设为值:0xFF
- C：
  - 控制字段，其实没啥用
  - 1个字节
  - 值：固定为0x03
- 协议：
  - 用来标识信息部分中的内容是什么类型
    - 例如：是数据、还是网络控制数据、还是安全认证数据等
  - 2个字节
  - 值：8种取值，代表8种类型的信息部分数据
    - 0x0021 — PPP 帧的信息字段就是IP 数据报。
      0xC021 — 信息字段是 PPP 链路控制数据。
      0x8021 — 表示这是网络控制数据。
      0xC023 — 信息字段是安全性认证PAP。（实名认证方式）
      0xC025 — 信息字段是LQR。
      0xC223 — 信息字段是安全性认证CHAP。（实名认证方式）  
- 信息部分：
  - 最大不超过MTU即1500Byte
  - 没有最短限制
  - 但是对PPP不同的以太网里，就规定了最短得是46Byte，最大也是1500Byte
- FCS：
  - 帧检验序列（比如使用CRC循环冗余检验产生）
  - 2个字节
  - 值：比如CRC让信息部分数据除以除数得到的余数
- F：
  - 帧尾结束标识
  - 1个字节
  - 值：0x7E

##### 4.PPP协议的两种填充方法

##### 4.1字节填充（数据按字节传的，那么填充转义字符）

**PPP中透明传输这一特性里，转义字符怎么定义的（或者说字节填充怎么实现的）**

信息字段中出现了标志字段的值，可能会被误认为是“标志”，怎么办？

（与之前的那个总述里加ESC思路相同，实现起来略有不同）

- 将信息字段中出现的每个 0x7E 字节转变成为 2 字节序列(0x7D, 0x5E)。 
  - **0x7E即帧头开始标识和帧尾结束标识**
  - 思路上对应SOH和EOT前边插ESC，但实际上不是简单插一个ESC，而是插入ESC后，开始结束标识符0x7E也变成5E了
  - **0x7D可以理解为ESC**
- 若信息字段中出现一个 0x7D 的字节, 则将其转变成为 2 字节序列(0x7D, 0x5D)。
  - 思路上对应ESC前加ESC，也不是简单前插一个ESC，而是前插一个ESC 0x7D后，原来的ESC 0x7D要变成5D
- 若信息字段中出现 ASCII 码的控制字符（即数值小于 0x20 的字符），则在该字符前面要加入一个 0x7D 字节，同时将该字符的编码加以改变。
  - 没有对应的

##### 4.2零bit填充（只有bit流的传输方式，才可以这样做。如果是按字节传输的，那只能用上边的字节填充）

帧开始标识和帧结束标识是0x7E

0x7E=0111 1110

这种填充法是在发送端，先扫描整个信息字段。只要有5个连续的1，我就插一个0，来打破有可能出现的0111 1110的情形。所以这样做的话，数据中绝不会出现0x7E这种干扰项。

![image.png](https://i.loli.net/2020/10/14/HzFYJtiIRaWdSDG.png)

##### 5.PPP中不使用序号和确认机制、重传机制

PPP 协议之所以不使用序号和确认机制是出于以下的考虑：

- 在因特网环境下，PPP 的信息字段放入的数据是 IP 数据报。数据链路层的可靠传输并不能够保证网络层的传输也是可靠的。
- 帧检验序列 FCS 字段可保证无差错接受。

简言之：**数据链路层协议**一般**不使用确认和重传机制**，改正差错的任务由上层协议（比如运输层的TCP协议）来完成。

##### 6.PPP协议的工作状态

![image.png](https://i.loli.net/2020/10/14/E9ceoGZlvpPUIsJ.png)



#### 3.2.2使用广播信道的数据链路层（以太网，一对多通信）

广播信道可以进行一对多的通信，局域网使用的就是广播信道

##### 1.局域网的特点与优点

- 局域网最主要的特点是：

  - 网络为一个单位所拥有，且地理范围和站点数目均有限。

- 局域网具有如下的一些主要优点：

  - 具有广播功能，从一个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源。

  - 
    便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变。
  - 提高了系统的可靠性、可用性和生存性。

##### 2.局域网里共享信道的方式

- 静态划分信道（这用在局域网里成本太高，不合适）
  - 频分复用
  - 时分复用
  - 波分复用
  - 码分复用 
- 动态媒体接入控制（多点接入）
  - **随机接入**（主要被以太网采用！）
    - 特点是所有的用户可以随机地发送信息，如果恰巧有两个或更多的用户在同一时刻发送信息，那么在共享媒体上交产生碰撞，使得这些用户的发送都失败
  - 受控接入 ，如多点线路探询(polling)，或轮询。（目前已不被采用）

##### 3.以太网使用CSMA/CD协议来实现多台计算机共享信道

CSMA/CD 表示 Carrier Sense Multiple Access with Collision Detection。

- Multiple Access，“多点接入”
  - 表示许多计算机以多点接入的方式连接在一根总线上。
-  Carrier Sense ，“载波监听”
  - 是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞。
  - “载波监听”就是用电子技术检测总线上有没有其他计算机发送的数据信号。
- Collision Detection，碰撞检测
  - 就是计算机边发送数据边检测信道上的信号电压大小。
    - 当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）。
    - 当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞。
    - 所谓“碰撞”就是发生了冲突。因此“碰撞检测”也称为“冲突检测”。
  - 检测到碰撞后
    - 在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。
    - 每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送。

**重要特性：**

- **使用 CSMA/CD 协议的以太网**不能进行全双工通信而只能进行双向交替通信（**半双工通信**）。
  - 因为，只要A正在给B发，C就不能给D发，一发就检测到冲突。A在给B发时，B也不能给A 发，一发也会冲突。因此一个电脑，不可能同时进行发送和接收（但必须边发边监听信道），因此这种以太网一定是半双工的
- 每个站在发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。 
- 这种发送的不确定性使整个以太网的平均通信量远小于以太网的最高数据率。

##### 4.争用期

最先发送数据帧的站，在发送数据帧后至多经过时间 2τ （两倍的端到端往返时延）就可知道发送的数据帧是否遭受了碰撞。

经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞。

- **以太网的争用期**
  - 以太网的端到端往返时延 2τ  称为争用期，或碰撞窗口。协议规定51.2 us 为争用期的长度。
  - 对于 **10 Mb/s** 以太网，在争用期内可发送512 bit，即 64 字节。
    - 51.2us * 10Mb/s=51.2*10 b=512 bit=64Byte
    - 即51.2 us可以发送64Byte，只有发够64Byte才敢确保没有冲突。之后发送也就不会有冲突，因为是你先建立的。
  - 以太网在发送数据时，若前 64 字节未发生冲突，则后续的数据就不会发生冲突。
- **最短有效帧长**
  - 如果发生冲突，就一定是在发送的前 64 字节之内。 
  - 由于一检测到冲突就立即中止发送，这时已经发送出去的数据一定小于 64 字节。 
  - **以太网规定了最短有效帧长为 64 字节，凡长度小于 64 字节的帧都是由于冲突而异常中止的无效帧。**
    - 只要收到了这种无效帧，就应当立即丢弃
    - 我要发的帧就是很短，没有64字节怎么办？自动补0发送

##### 5.检测到了冲突怎么解决：二进制指数类型退避算法

发生碰撞的站在停止发送数据后，要推迟（退避）一个随机时间才能再发送数据。

- 确定基本退避时间，一般是取为争用期 2τ。
- 定义参数 k ，
                   k = Min[重传次数, 10]
- 从整数集合[0,1,…, (2^k -1)]中随机地取出一个数，记为 r。重传所需的时延就是 r 倍的基本退避时间。
- 当重传达 16 次仍不能成功时即丢弃该帧，并向高层报告。

### 3.3以太局域网（即以太网，其中各电脑的适配器执行CSMA/CD协议）

#### 3.3.1概述

**以太网的两个标准**

- DIX Ethernet V2 是世界上第一个局域网产品（以太网）的规约。
- IEEE 的 802.3 标准。
  - DIX Ethernet V2 标准与 IEEE 的 802.3 标准只有很小的差别，因此可以将 802.3 局域网简称为“以太网”。
  - 严格说来，“以太网”应当是指符合 DIX Ethernet V2 标准的局域网  

**以太网提供的服务**

- 以太网提供的服务是不可靠的交付，即尽最大努力的交付。
- 当接收站（接收端的电脑）收到有差错的数据帧时就丢弃此帧，其他什么也不做。差错的纠正由高层来决定。
- 如果高层发现丢失了一些数据而进行重传，但以太网并不知道这是一个重传的帧，而是当作一个新的数据帧来发送

#### 3.3.2拓扑

总线型的拓扑被淘汰了，后来是使用集线器的星形拓扑，后来集线器也淘汰了，现在都是交换机

集线器是个没有智商的设备，只管收发，工作在物理层

#### 3.3.3CSMA/CD协议

CSMA/CD:载波监听多点接入/碰撞检测（Carrier Sense Multiple Access with Collision Detection）

- 1.准备发送：适配器从网络层获得一个分组，加上以太网的首部和尾部，组成以太网帧，放入适配器的缓存中。但在发送之前，必须**先检测信道**
- 2.检测信道：若检测到信道忙，则应不停地检测，一直等待信道转为空闲。若检测到信道空闲，并在96比特时间内信道保持空闲（保证了帧间最小间隔），就发送这个帧
- 3.在发送过程中仍不停地检测信道，即网络适配器要边发送边监听。

**什么时候使用CSMA/CD协议**

- **使用集线器的以太网在**逻辑上仍是一个总线网，各站共享逻辑上的总线，**使用的仍是CSMA/CD协议。**
  - 网络中的各站必须竞争对传输媒体的控制，并且在同一时刻至多只允许一个站发送数据。
- 使用**网桥、10BASE-T（铜线）以太网、交换式以太网**，所有接入设备使用的也是CSMA/CD
- **100BASE-T**又称为快速以太网，在半双工方式工作时一定使用CSMA/CD协议。在全双工方式时，不需要使用CSMA/CD协议
  - 可以铜缆，可以光纤。铜缆只有100m距离，光纤可以2000m距离
- 1000BASE-T称为吉比特以太网，在半双工方式工作时一定使用CSMA/CD协议。在全双工方式时，不需要使用CSMA/CD协议
  - 可以铜缆，可以光纤。铜缆只有100m距离，光纤可以最多5000m距离

#### 3.3.4信道利用率

- 以太网的连线长度越短（100m以内），利用率越高。它短了 单程端到端时延τ就小
- 以太网的帧长越长(最短64字节，小于64字节的都视为碰撞无效帧)，利用率越高。它长了，帧的发送时间T0就大

#### 3.3.5MAC层

**MAC地址**

- 在局域网中，硬件地址又称为物理地址，或 MAC 地址。 
- 802 标准所说的“地址”严格地讲应当是每一个站的“名字”或标识符。 
- 但鉴于大家都早已习惯了将这种 48 位的“名字”称为“地址”，所以本书也采用这种习惯用法，尽管这种说法并不太严格。
  - IEEE 的注册管理机构 RA 负责向厂家分配地址字段的前三个字节(即高位 24 位)。
  - 地址字段中的后三个字节(即低位 24 位)由厂家自行指派，称为扩展标识符，必须保证生产出的适配器没有重复地址。
  - 一个地址块可以生成2^24个不同的地址。这种 48 位地址称为 MAC-48，它的通用名称是EUI-48。
  - “MAC地址”实际上就是适配器地址或适配器标识符EUI-48。
  - **MAC一共48位，前24位代表厂商（24bit/4bit=6个十六进制数），后24位代表网卡编号，全球唯一。**
    - 其实全球不唯一...虽然网卡上烧了一个固定的，但是这个MAC还可以手动改，让计算机不去识别那个网卡上烧制的MAC，使用人工指定的。**只要保证同一个局域网里面没有重复的MAC就可以了。**
  - 例如我的网卡，30-9C-23-D4-A1-8F。根据 30-9C-23就能知道，这是微星公司生产的。

**网卡如何检查MAC**

- 适配器（网卡）从网络上每收到一个 MAC 帧就首先用硬件检查 MAC 帧中的 MAC 地址
  - 如果是发往本站的帧则收下，然后再进行其他的处理。
  - 否则就将此帧丢弃，不再进行其他的处理。
- “发往本站的帧”包括以下三种帧： 
  - 单播(unicast)帧（一对一）
    - 网卡收到的帧的MAC地址与本站的硬件地址相同
  - 广播(broadcast)帧（一对全体）
    - 发送给本局域网上所有站点的帧（MAC是全1）
  - 多播(multicast)帧（一对多）
    - 发送给本局域网上一部分站点的帧

#### 3.3.6MAC帧格式（MAC帧是MAC帧，与PPP帧完全不同）

**MAC帧格式**

常用的以太网MAC帧格式有两种标准 ：

- DIX Ethernet V2 标准**(比较常用)**
- IEEE 的 802.3 标准

![image.png](https://i.loli.net/2020/11/12/c8rVdWlo7ivMmNO.png)





- 目的地址
  - 6byte=48bit=12位十六进制
  - 即目标MAC地址
- 源地址
  - 发送端的MAC地址
- 类型
  - 标志上一层使用的是什么协议，以便把收到的MAC帧的数据上交给上一层的这个协议
- 数据
  - 以太网的帧即MAC帧，最短要求64字节，减去目的地址6，源地址6，类型2，FCS4，即得到最短的数据长度得是46
  - 注意，PPP的帧没有最短限制，因为PPP不会发生碰撞。所以PPP里的IP数据报没有下限，只有上限1500Byte
- FCS
  - 帧检验序列，例如用CRC获得
- 帧头
  - 前同步码+帧开始定界符
  - 注意：MAC帧里，只有帧头，没有帧尾。因为以太网用的是曼彻斯特编码。这种编码方式，只需要知道头就行了。后边没信号了就是结束了，即到帧尾了，本帧结束了。

**无效的MAC帧**

- 帧的长度不是整数个字节；
- 用收到的帧检验序列 FCS 查出有差错；
- 数据字段的长度不在 46 ~ 1500 字节之间。
- 有效的 MAC 帧长度为 64 ~ 1518 字节之间。
  - 即6+6+2+ （46~1500）+4 =（64 ~ 1518）
- 对于检查出的无效 MAC 帧就简单地丢弃。以太网不负责重传丢弃的帧。 

**帧间最小间隔** 	

- 帧间最小间隔为 9.6 us，相当于 96 bit 的发送时间。
  - 争用期是51.2us，即512bit=64byte的时间。争用期可以算出帧的最短长度即64Byte（因为，10Mb/s的带宽下,10Mb/s * 51.2us=512bit=64byte）
  - 帧间最小间隔是指，检测到空闲后，还得等一会儿才能再发，不能马上发送。
- 一个站在检测到总线开始空闲后，还要等待 9.6 us 才能再次发送数据。
- 这样做是为了使刚刚收到数据帧的站的接收缓存来得及清理，做好接收下一帧的准备。 

### 3.4扩展以太网（集线器、网桥、交换机）

**1.集线器（已淘汰）：任何两台计算机之间的通信，都会给所有集线器上的电脑发送一遍**

​	

- 集线器是个没有智商的设备，就是直接转发。
- ![image.png](https://i.loli.net/2020/11/12/oH1WF5aknPbfeim.png)
- 如果3个小集线器没有连到主干集线器的时候，那有三个独立碰撞域。 
  - 也就是说 A在给B传数据时候，只有三系里的ABCD之间不可以再通信了。但是其他系里可以通信，比如A在给B发时，E可以给F 。
- 一旦把它们都接到主干集线器上，那么这12台电脑就全部连接起来了。一旦A正在给B发，其他12台谁也不能给谁发，一发就碰撞。
  - 因为这种局域网设备下，A给B发数据，是同时给其他11台一起发的。只是除了B的其他的10台，一看不是给自己的MAC地址的，就不接收。只有B一看是给自己的，就收下。
- 因此，一旦集线器上连接的设备多了，那么会增大碰撞域，信道利用率大大降低。因为设备多了，那碰撞率就大多了。所以集线器连的设备，一般不超过30台。

- 用**集线器扩展局域网优点**
  - 使原来属于不同碰撞域的局域网上的计算机能够进行跨碰撞域的通信。
  - 扩大了局域网覆盖的地理范围。
- 用**集线器扩展局域网缺点**
  - 碰撞域增大了，但总的吞吐量并未提高。
  - 如果不同的碰撞域使用不同的数据率，那么就不能用集线器将它们互连起来。

**2.网桥（已淘汰）：网桥的每个端口会自动记录MAC，端口内部（左右）的通信，不转发到端口外部（右左）**

- 集线器这个设备问题太大，所以发明了网桥来扩大局域网覆盖范围
- 网桥是个有智商的设备，会自动的记录下经过它的MAC地址，并区分出是否在同侧
- ![image.png](https://i.loli.net/2020/11/12/j4kLGzYUaB8mC2M.png)
- 使用网桥扩展以太网的优点
  - 隔离了碰撞域
  - 可互连不同物理层、不同 MAC 子层和不同速率（如10 Mb/s 和 100 Mb/s 以太网）的局域网。
- 使用网桥扩展以太网的缺点
  - 网桥室友存储转发的功能的，因此存储转发增加了时延。 
  - 网桥只适合于用户数不太多(不超过几百个)和通信量不太大的局域网，否则有时还会因传播过多的广播信息而产生网络拥塞。这就是所谓的广播风暴。
- **透明网桥**：叫透明是因为，比如A和C通信，它俩通信其实过了网桥，但是它俩并不知道，有网桥和没网桥对他俩来说一样。所以网桥也叫透明网桥。
- 透明网桥里还使用了**生成树算法**，目的是避免产生转发的帧在网络中不断地兜圈子
  - 使用生成树算法后，整个连通的网络中不存在回路，即在任何两个电脑之间只有一条路径
  - 使用生成树算法后的效果是，有的交换机的口就被阻断了，无法转发数据。只有阻断掉一些口，才能保证唯一路径，避免环
- 网桥的自学习算法：
  - 网桥里有个转发表（MAC地址表）。
  - **如果该网桥的MAC地址表里，没有存这个MAC地址，不知道这个MAC地址该往哪个口输出，那就会把这个数据帧转发到所有口上，然后会记下源MAC地址对应的口。这样就记在MAC地址表里了。**
  - **端口MAC地址表里记的都是每次通过这个网桥时，源MAC所在的口。**
    - 如果有表里没有见过的MAC，那就给所有的口都转发
    - 这个口，就可以理解为上边图上的左右口。当接的口多了，就不再是单纯的左右了，得编上号1、2、3、4。。

**3.交换机（端口很多的网桥，电脑直接接到每个端口上。每两个端口之间的通信，都不会传到别的端口去。）**

- **足够多的口的网桥，就是现在的交换机。**
  - 之前的网桥接的都是子集线器，子集线器上接计算机。
  - 现在让计算机直接接到网桥（即交换机）上。
  - 如果**每个计算机都直接连到交换机上**，相当于交换机的每个端口只记录一个MAC地址。
    - 即每个碰撞域里只有一个电脑。
  - 假如AB电脑通信，网桥一隔断，就不给CDEF发送，更加安全。CDEF想抓包都抓不到，因为网桥就不给它转发。
  - 假如A在给B发，D其实也可以给B发，因为不是一个碰撞域，但是B正在接受怎么办。其实网桥那儿也有缓存和排队机制，等A给B发完了，D才能给B发
  - 所以，交换机的每一个口就是一个独立的碰撞域，两两端口之间通信可以同时进行，互不干扰。比如A在给B发，C也可以给D发，F也可以给B发，只是要排队等待A给B发完。
- ![image.png](https://i.loli.net/2020/11/12/URPYJyESH2l3czf.png)
- ![image.png](https://i.loli.net/2020/11/12/KcfWX1tebDFCHh5.png)
  - 这个图是交换机整个MAC表，里边就是存了每个端口对应的MAC。与上边的网桥示意图是一致的。

### 3.5虚拟局域网VLAN

- 交换机的使用使得VLAN的创建成为可能
- 虚拟局域网 VLAN 是由一些局域网网段构成的与物理位置无关的逻辑组。
  - 这些网段具有某些共同的需求。
  - 每一个 VLAN 的帧都有一个明确的标识符，指明发送这个帧的工作站是属于哪一个 VLAN。
- 虚拟局域网其实只是局域网给用户提供的一种服务，而并不是一种新型局域网。
- **将一个交换机划分了两个VLAN，你就可以想象成将交换机逻辑上分成了两个交换机，这两个不同的VLAN之间通信必须通过路由器转发，同时这两个VLAN的IP地址必须在不同的网段。**
  - ![image.png](https://i.loli.net/2020/11/13/CzKSXyZOWrVcvjx.png)
- **VLAN可以跨交换机，多台交换机上的一些接口，组成一个虚拟VLAN1，别的一些接口还可以组成VLAN2、VLAN3等等。这个VLAN内的通信，不会转发到其他端口上。**
- 一个VLAN=一个广播域=逻辑网段（子网）
- **实例：**
  - ![image.png](https://i.loli.net/2020/11/13/5e62VscLjRKQH4y.png)
  - 如图所示，接入层交换机SwitchA、SwitchB、SwitchC、SwitchD于汇聚层交换机SwitchE链接。
  - 市场部计算机都连接到SwitchA，属于VLAN 4
  - 销售部和研发部以及财务部的计算机分别属于VLAN1、VLAn2和VLAN3，这三个VLAN跨SwitchB、SwitchC、SwitchD三个交换机。
  - 总结：交换机组建的网络，如果需要多个VLAN通过的链路就需要配置为干道链路。如果链路上只需要单一VLAN的数据通过就可以配置为访问链路。
  - **VLAN之间想通信，需要借助路由**
  - 虚拟局域网协议允许在以太网的帧格式中插入一个 4 字节的标识符，称为 VLAN 标记(tag)，用来指明发送该帧的工作站属于哪一个虚拟局域网。 
    - ![image.png](https://i.loli.net/2020/11/14/YFwBRVUDHKtTom9.png)
    - 相比LAN的MAC帧，多一个4字节的VLAN标记。

### 3.6高速以太网

- 速率达到或超过 100 Mb/s 的以太网称为高速以太网。
- 在双绞线上传送 100 Mb/s 基带信号的星型拓扑以太网，仍使用 IEEE 802.3 的CSMA/CD 协议。100BASE-T 以太网又称为快速以太网(Fast Ethernet)。 
- 100Base-T特点
  - 可以光缆，也可以铜缆，用光缆的话距离长，可以2000m，用铜缆就100m
  - 可在全双工方式下工作而无冲突发生。不需要冲突检测，可以同时收发。
    - 交换的口是存储转发的，
  - 保持最短帧长（64byte）不变，但将一个网段的最大电缆长度减小到 100 m。帧间时间间隔从原来的 9.6 us 改为现在的 0.96 us。    
- 1000Base-T就是吉比特以太网
  - 吉比特以太网一般是光缆或者铜缆，用光缆最长距离支持5000m，铜缆就100m以内
  - 允许在 1 Gb/s 下全双工和半双工两种方式工作。
  - 与 10BASE-T 和 100BASE-T 技术向后兼容。
  - 当吉比特以太网工作在全双工方式时（即通信双方可同时进行发送和接收数据），不使用载波延伸和分组突发。
  - 吉比特以太网的出现，以太网的工作范围已经从局域网（校园网、企业网）扩大到城域网和广域网，从而实现了端到端的以太网传输。
  - 也就是说吉比特以太网不再仅仅是局域网了，广域网也可以用

### 3.7数据链路层安全

可以在交换机上做文章

- 比如说，交换机的一个端口，只让接一台计算机上网，一旦检测到第二个MAC地址，那个端口直接shutdown掉

### 3.8网卡的作用

![image.png](https://i.loli.net/2020/11/22/nyIlFDRzcw2pOYo.png)

**比如发信息出去：**

- 计算机的CPU将网络层的内容并行通信给网卡
- 网络层的内容，先存放在网卡的存储芯片里。
- 然后进行帧的封装，也就是加上目标MAC，源MAC，标记上网络层使用的协议，然后加上帧校验序列。
  - MAC其实就是数据链路层的地址
- 封好以后，还要检测要发的时候，网线上有没有冲突。如果冲突了就尝试第二次、第三次...发。也就是CAMA/CS就是在这里使用的
  - 以上都是数据链路层的工作
- 所有搞完以后，数字信号同步，数据进行编码（比如曼彻斯特编码）并串行发送到网线上
  - 只有这里是物理层工作

**接收信息**

- 串行接受网线上的信息，数字信号同步，并进行数据解码（比如解码曼彻斯特）
  - 只有这里是物理层工作，之下都是数据链路层的工作
- 先把接受到的内容，放在网卡存储芯片里
- 然后进行帧的拆封。
  - 到网卡这儿的时候，理论上应该已经可以没有MAC地址了，因为交换机现在是指谁发给谁，不会乱发。但是交换机对于没有见过的MAC，会往所有口全发一遍。所以实际上到网卡这儿还是有MAC的
  - **（即交换机比集线器好在，避免了很多不是自己的MAC地址的数据包传过来。但是没有完全避免，只是避免掉了大部分，对于交换机没有见过的MAC或者说第一次见时，要给所有的口转发一遍）**
- 拆封过程即，看看目标MAC是不是自己，不是自己的就扔掉。是自己的，就拆掉目标MAC和源MAC，然后开始帧的差错检验。一验，没有差错，那就留下。有差错，直接扔掉
- 然后把数据包解码，并行通信给计算机的CPU

### 3.9广播风暴

**先了解一下广播包**

- 广播包：目标MAC是全1，交换机会给所有的口上分发，也就是所有的电脑都会接收
- ![image.png](https://i.loli.net/2020/11/22/lNg8cyqeaLW1PJb.png)
- ![image.png](https://i.loli.net/2020/11/22/kcnwDZ1tTgjJ2FI.png)

**广播风暴**

- 传播过多的广播信息而产生网络拥塞

**只要有环路就能形成广播风暴，而交换机连接起来往往都有环路，所以交换机必须加上生成树协议来避免广播风暴**

- 比如说医院里，某根网线坏了，你不能直接全面停网吧。所以这种核心的交换机一般都会有环路，这就是有备无患。一旦之前的转发端口坏了，那么生成树协议立马启用之前的阻断端口来转发数据。
- 举例1
  - ![image.png](https://i.loli.net/2020/11/23/CtXSbkH1NQ8Yrgs.png)
- 举例2
  - 左图，交换机俩端口直接连接到一起，这样就有环路
  - ![image.png](https://i.loli.net/2020/11/23/BxhaSwINpYeiH85.png)
- 如果没有生成树协议，那么一旦一台计算机发送广播包，那么完蛋，这个包永远不会消失。你在任意一台计算机上去抓包，会发现这个广播包会被抓到无数次，永不停息
- 生成树协议即有了优先级，隔断环路。即两点之间仅一条通路
  - **生成树协议的具体操作：把交换机的某些口自动阻断掉，虽然都插上了网线，但是只有某些口可以转发数据包，阻断的端口就不能转发，但是可以接收。**
  - 要注意，**这里的阻断端口，一定是交换机与交换机连接的端口，交换机与电脑连接的端口永远不能被阻断（因为交换机与计算机之间，就这一条通路，没有环。）。**
  - 生成树还有什么好处呢，用来有备无患。环路的形成其实就是为了保证，万一某根网线坏了，还有其他通路去上网传送数据。比如以前的某个可以转发的端口给坏掉了，那么生成树协议立马就把之前的阻断的另个端口启用。这样就可以保证出现小故障，依然不影响设备上网。
    - 比如说医院里，某根网线坏了，你不能直接全面停网吧。所以这种核心的交换机一般都会有环路，这就是有备无患。一旦之前的转发端口坏了，那么生成树协议立马启用之前的阻断端口来转发数据。
- ![image.png](https://i.loli.net/2020/11/23/qeCEvxyOFfdNpYP.png)
  - 交换机里必有生成树协议，黄灯就是交换机与交换机直接被阻断的端口，绿灯就是转发端口
  - 交换机上可以设置vlan，每个vlan里都有一个生成树。默认所有端口都在vlan1，可以修改。



### 3.10重点总结

- **1.数据链路层协议**一般**不使用确认和重传机制**，改正差错的任务由上层协议（比如运输层的TCP协议）来完成。
- 2.数据链路层只保证了接收端近乎100%的无差错的接收。
  - 因为有CRC循环冗余检验，要是一算余数不为0，那我接收端就丢掉。丢掉不就丢包了吗？发生丢包，那是让发送端重传，数据链路层不管你怎么重新传，它只管检查传过来的序列对不对。序列对（余数为0），接受；序列不对（余数不为0），丢掉。
- 3.数据链路层的协议
  - 比如点对点信道里的（PPP、HDLC、帧中继协议）等等，得在路由器上设置，两个设备的协议要一致，相当于要有共同语言
  - 广播信道里的数据链路层协议：CSMA/CD
- 4.PPP（用于ADSL拨号上网）：
- 点对点信道的数据链路层协议：PPP
  - 它解决了数据链路层的三个基本问题：封装成帧、透明传输、差错检测
  - PPP协议的组成
    - NCP。（网络控制协议）允许在点到点连接上使用多种网络层协议
    - LCP。（链路控制协议）建立并维护数据链路连接。
    - 将IP数据报封装到串行链路的方法。（例如HDLC，其实HDLC本身也是一种数据链路层的协议，跟PPP地位等同，只是它现在仅适用于传统的电信网络设备上了，不在网络设备上使用了）
  - PPP协议的帧格式
    - PPP帧是PPP帧，它是点对点，所以目标地址没有用，与MAC帧完全不同
    - ![image.png](https://i.loli.net/2020/10/14/sHz7xjicpNn8q4u.png)
- 5.以太网（局域网）：
  - 一对多通信。
  - 广播信道的数据链路层协议：CSMA/CD协议
    - 协议要点：发送前先监听，边发送边监听，一旦发现总线上出现了碰撞，就立即停止发送。然后按照退避算法等待一段随机时间后再次发送。因此，每一个站在自己发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。以太网上各站点都平等地争用以太网信道
  - 它解决了数据链路层的三个基本问题：封装成帧、透明传输、差错检测
  - 信道利用率：
    - 以太网的连线长度越短（100m以内），利用率越高。它短了 单程端到端时延τ就小
    - 以太网的帧长越长，利用率越高。它长了，帧的发送时间T0就大
      - 以太网的帧长最短 （6+6+2+46+4=64）字节，小于64字节的都视为碰撞无效帧
  - MAC地址：
    - MAC一共48位，前24位代表厂商（24bit/4bit=6个十六进制数），后24位代表网卡编号，理论上这个编号全球唯一。
    - 其实全球不唯一...虽然网卡上烧了一个固定的，但是这个MAC还可以手动改，让计算机不去识别那个网卡上烧制的MAC，使用人工指定的。**只要保证同一个局域网里面没有重复的MAC就可以了。**
    - 例如我的网卡，30-9C-23-D4-A1-8F。根据 30-9C-23就能知道，这是微星公司生产的。
    - 适配器（网卡）从网络上每收到一个 MAC 帧就首先用硬件检查 MAC 帧中的 MAC 地址。如果是发往本站的帧则收下，然后再进行其他的处理。否则就将此帧丢弃，不再进行其他的处理。
      - 局域网里，就是给每个主机都发一遍，然后接收端网卡自己去看看是不是给自己的。
  - MAC帧格式
    - MAC帧里必须得填目标地址源地址，PPP是点到点，所以目标地址没啥用，直接写死
    - ![image.png](https://i.loli.net/2020/11/12/c8rVdWlo7ivMmNO.png)
    - MAC帧里的数据字段的长度在 46 ~ 1500 字节之间。
    - 有效的 MAC 帧长度为 6+6+2+ （46 ~ 1500）+4= 64 ~ 1518 字节之间。
      - 这个长度没有包含帧头。
    - 对于检查出的无效 MAC 帧就简单地丢弃。以太网不负责重传丢弃的帧。 
    - MAC帧采用曼彻斯特编码，只需要帧头，不需要帧尾。后边没信号了就是结束了，即到帧尾了，本帧结束了。
  - MAC帧里的几个时间(10Mb/s的以太网)
    - 争用期 ：2τ=51.2us，在10Mb/s的以太网里，足够传512bit即64byte。这个时间使用了换算出最短的帧长=64byte，所以IP数据报最短46byte
    - 帧间最小间隔时间：9.6 us，在10Mb/s的以太网里，即96bit的发送时间。帧间最小间隔是指，检测到总线开始空闲后，即上一个MAC帧发完了（例如是A给B发的），我此时C给D发的包，还得等一会儿才能再发，不能马上发送。这样做是为了使刚刚收到数据帧的站的接收缓存来得及清理，做好接收下一帧的准备。 
  - 扩展以太网的设备
    - 集线器：
      - 在集线器上连接的所有电脑，A给B发的信息，其他所有电脑也能收到。只是一看MAC地址不是它，就不处理。
      - 也就意味着，一旦A在给B发，那么C不能给D发，B也不能给A发。一个在通信，别的通信是会碰撞的。所以其他的不让发
      - **使用集线器的以太网在**逻辑上仍是一个总线网，各站共享逻辑上的总线，**使用的仍是CSMA/CD协议。**
        - 网络中的各站必须竞争对传输媒体的控制，并且在同一时刻至多只允许一个站发送数据。
    - 网桥
      - 网桥会记录一个MAC地址表，都在网桥某个端口同侧的电脑通信，就不转发给网桥的其他端口。比较安全
      - 地址表里记录了每个MAC所在的端口
      - 透明网桥里还有生成树算法，避免产生转发的帧在网络中不断地兜圈子。 
      - 使用**网桥的以太网**，所有接入设备使用的也是CSMA/CD
    - 交换机
      - 交换机每个端口与每个端口的通信独立，不转发给其他端口。交换机的每个端口就相当于一个网桥。
      - 假如AB电脑通信，交换机的网桥一隔断，就不给CDEF发送，更加安全。CDEF想抓包都抓不到，因为网桥就不给它转发。
      - 假如A在给B发，D其实也可以给B发，因为不是一个碰撞域，但是B正在接受怎么办。其实网桥那儿也有缓存和排队机制，等A给B发完了，D才能给B发
      - 所以，交换机的每一个口就是一个独立的碰撞域，两两端口之间通信可以同时进行，互不干扰。比如A在给B发，C也可以给D发，F也可以给B发，只是要排队等待A给B发完。
      - **10BASE-T（铜线）以太网、交换式以太网**，所有接入设备使用的也是CSMA/CD
      - **100BASE-T**又称为快速以太网（它肯定用的也是交换机），在半双工方式工作时一定使用CSMA/CD协议。在全双工方式时，不需要使用CSMA/CD协议
        - 可以铜缆，可以光纤。铜缆只有100m距离，光纤可以2000m距离
        - **全双工模式是凭什么呢？凭交换机的每个端口上都有个负责存储的东西，你这个计算机在发信息的时候，有人想发给你，那就在端口存下来，等我发送完，再把要传给我的传进来。**
        - **为什么不用检测冲突了呢？因为有存储，就是只管发过去，发过去存下来慢慢排队等待发送。**
      - 1000BASE-T称为吉比特以太网（它肯定用的也是交换机），在半双工方式工作时一定使用CSMA/CD协议。在全双工方式时，不需要使用CSMA/CD协议
        - 可以铜缆，可以光纤。铜缆只有100m距离，光纤可以最多5000m距离
    - 总结一下：**交换机:端口独享带宽；比集线器安全；接口到计算机是全双工的；全双工模式不再使用CSMA/CD协议；接口可以工作在不同速率；广播帧会转发到全部端口**
    - 交换机里必须得加上生成树协议，避免环路产生广播风暴，即一直转发某个广播包，永不停歇
    - ![image.png](https://i.loli.net/2020/11/22/5iTFsVteCRz2BSc.png)
  - VLAN
    - **VLAN可以跨交换机，多台交换机上的一些接口，组成一个虚拟VLAN1，别的一些接口还可以组成VLAN2、VLAN3等等。这个VLAN内的通信，不会转发到其他端口上。**
  - 高速以太网
    - 即100BASE-T、1000BASE-T等
  - 网卡的作用
    - 数据链路层的工作：所有的比如说以太网帧的封装解封、帧的差错校验、CSMA/CD里的检测网线碰撞等待重发等等，都是网卡完成的。
    - 物理层的工作：比如说物理连接和数字信号同步、数据的编码和解码
  - 以太网帧发送时需要封装上目标MAC和源MAC
    - **电脑只知道源MAC（就是自己的网卡），那么发数据时的目标MAC怎么知道的呢？**
    - TCP/IP协议里有一个arp协议，当A计算机ping B计算机时，A计算机会在网上发一个广播帧，**广播帧的目标MAC是全F，即FF-FF-FF-FF-FF-FF**，48位的1。这个广播就是用于解析对方的MAC地址的。解析到以后就会缓存到本机上。
      - 不论哪台计算机，一旦收到一个目标MAC地址是FFFFFFFFFF的以太网帧时，都应该视为是给自己的。应当接收并处理。
    - cmd里输入 arp -a就可以看到，计算机每个网卡缓存的其他计算机（即某个IP地址）的MAC地址
      - 缓存的就证明之前通信过
    - ![image.png](https://i.loli.net/2020/11/22/F2r4EjYBobsinwP.png)

## 4.IP地址和子网划分

### 4.1MAC地址和IP地址

- **数据包的目标IP地址决定了数据包最终到达哪一个计算机**
- 而**目标MAC地址决定了该数据包下一跳由哪个设备接收，不一定是终点（很有可能是路由器）**

<img src="https://i.loli.net/2020/11/23/KLjP3vxUJBZrWh5.png" alt="image.png" style="zoom:150%;" />

- 想从IP地址为10.0.0.2发送到IP地址为12.0.0.2的计算机。
  - 因为这个IP是唯一的，所以可以精准定位到目标地址
- 那要MAC地址干嘛？
  - MAC地址其实是用于短程托运工作，相当于暂时停靠的驿站
- 网络层里数据包，从来都不修改。从上图可以看到
  - 第一个步骤是，从发出信息的计算机MAC为MA，到路由器1的左口MAC地址M1
  - 然后到达路由器1后，路由器1一看，你想去地址12.0.0.2，属于12.0.0.0/24网段是吧，那我路由表里存了，想去这个网段，那得从路由器1的右口去路由器2的左口，所以
  - 第二个步骤是，从路由器1的右口MAC地址M2发送到路由器2的左口MAC地址M3
  - 然后到达路由器2后，路由器2一看，你想去地址12.0.0.2，数据12.0.0.0/24网段是吧，那我路由表里存了，想去这个网段，那得从路由器2的右口直接到达目标MAC，所以
  - 第三个步骤是，从路由器2的右口MAC地址M4发送到接收端电脑MAC地址MF

### 4.2IP地址的组成

#### 4.2.1路由器的作用

路由器的作用:在不同网段转发数据包

![image.png](https://i.loli.net/2020/11/23/fAkvGFzMo4nNO5H.png)

#### 4.2.2IP地址的格式(共32位，网络号+主机号组成)

- IP地址有32位二进制表示，也就是32bit，即4个字节
  - 255.255.255.255
  - 1111 1111.1111 1111.1111 1111.1111 1111
- 子网掩码：又叫网络掩码、地址掩码
  - 作用：告诉计算机，IP地址里，哪部分是网络部分，哪部分是主机部分
  - 分配的主机号不能是0，0用来代表网络号的。主机号也不能全是1，全是1是广播地址。



#### 4.2.3数据的发送过程（arp广播，分同一网段下和不同网段下）

- 电脑发送数据包前，都要arp一下发送广播包，问一下目标IP地址的MAC是多少呀
  
  - 只要发送成功了一次，本机其实会存下来arp缓存，下次还给它发的时候，就不用发广播包了，直接查表
  
- **如果目标IP跟发送的电脑不在同一个网段（不在同一局域网）**，那就得发广播包，问我要去目标IP，负责转发的路由器的MAC是多少呀，然后路由器给它返回一个消息，我负责替你转发，我的MAC是...

  - 比如10.0.02想给12.0.0.2发送消息，那10.0.0.2就会发送广播包给各个局域网设备，路由器收到广播包以后，告诉发送PC，我负责替你转发，我的MAC是...
  - 参照底下的图片例子。

- **如果目标IP跟发送机是在同一个网段的**（即局域网内），那就发广播包，询问目标IP的MAC，然后目标电脑接到这个指令，给它返回一个信息，告诉发送机我的MAC是...
  
  - 比如，10.0.0.2想给10.0.0.3发送信息，那10.0.0.2就会发送广播包给各个局域网设备，10.0.0.3这台电脑收到10.0.0.2发的广播包以后，就返回给它一个消息，我的MAC是..
  - 参照底下的图片例子。
  
  

#### 4.2.4为什么子网掩码很重要？

- 因为它**决定了每个计算机处于哪个网段**。路由器是负责网段之间的转发通信的，一旦修改了子网掩码，那么所处网段就变了，路由器就不知道这个新的网段该怎么转发。
- **同一个网段里的计算机，他们的子网掩码肯定都一样。并且网络号也都一样，但是主机号必须不一样**
- 比如：
  - 一台设备IP是131.107.12.53，子网掩码255.255.255.0，那么它处于131.107.12.0网段，主机号53
  - 还是这台设备，IP不变131.107.12.53，把子网掩码换成了255.255.0.0，那就处于131.107.0.0网段，主机号12*256+53=3125
  - 比如这台设备是接收端，以前别人传过来一个数据，路由器知道，怎么给131.107.12.0网段怎么转发数据。现在子网掩码一换，这台设备就处于131.107.0.0网段了，路由器没有定义过怎么给这个网段转发数据，所以就不通了。
- 再举个例子：
  - ![1111.png](https://i.loli.net/2020/11/25/4H3Xzyxv7pKjcYh.png)
  - 左边计算机叫A，右边计算机叫B
  - 假如A想给B发信息。正常情况下（计算机A准确判断出来，他跟计算机B不在同一网段，需要路由）
    - 第一步，看看自己（计算机A）的IP 131.107.12.4，自己（计算机A）的子网掩码255.255.255.0，判断出来，自己（计算机A）处于网段131.107.12.0/24
    - 接着看看目标地址（计算机B）的IP 131.107.13.4，用自己（计算机A）的子网掩码255.255.255.0（重点注意，对方的子网掩码，你是不可能知道的，只能用自己的），判断出来，目标地址（计算机B）处于网段131.107.13.0/24
    - 然后一看，A在网段131.107.12.0/24，B在网段131.107.13.0/24。两台计算机不在同一网段，那就发arp广播包问网关的MAC地址是多少，得到反馈后，把数据包用网关（R1）的MAC地址的来封装，然后让路由器R1收到之后再转发。最后到达B
  - 假如A想给B发信息。假如计算机A的子网掩码写错了，写成了255.255.0.0，会发生什么呢？(计算机A误以为计算机B跟它在同一网段，不需要路由)
    - 第一步，看看自己（计算机A）的IP 131.107.12.4，自己（计算机A）的子网掩码255.255.0.0，判断出来，自己（计算机A）处于网段131.107.0.0/16
    - 接着看看目标地址（计算机B）的IP 131.107.13.4，用自己（计算机A）的子网掩码255.255.0.0（重点注意，对方的子网掩码，你是不可能知道的，只能用自己的），判断出来，目标地址（计算机B）处于网段131.107.0.0/16
    - 然后一看，A在网段131.107.0.0/16，B在网段131.107.0.0/16。计算机A认为两台计算机在同一网段，然后发arp广播包问， 131.107.13.4你的MAC地址是多少，结果网络中（局域网内）其实就没有这个IP地址，无人响应。那么通信就失败了。

### 4.3IP地址分类（ABCDE）

255.255.255.255

第一部分   |  第二部分 | 第三部分  |  第四部分|

1111 1111. 1111 1111. 1111 1111. 1111 1111

- A类地址
  - 网络地址的最高位（也就是32位ip里的第一位）是0的地址为A类地址。**网络ID是0不能用**，**127作为保留网段**，因此A类地址的第一部分取值范围0-127删去0和127即1-126
    - 即 0xxx xxxx,xxxx xxxx,xxxx xxxx,xxxx xxxx，共32位，这里的每个x代表0或1
    - 即0000 0001,xxxx xxxx,xxxx xxxx,xxxx xxxx
    - 到0111 1110,xxxx xxxx,xxxx xxxx,xxxx xxxx
    - 即1~126.x.x.x，这里的每个x代表0~255
    - A类网络的网络号有126个（本来有128个，但是0和127不能用）。举例1.0.0.0/8，2.0.0.0/8.......126.0.0.0/8
  - A类网络默认子网掩码为255.0.0.0。
  - 主机ID由第2部分、第3部分和第4部分组成，每部分的取值范围0-255，共256种取值，你要是学过排列组合就知道，一个A类网络（一个A类网络号）主机数量是256×256×256=166777216，这里还需减去2，因为主机号全0的地址为网络地址，而主机号全部为1的地址为广播地址，
  - <img src="https://i.loli.net/2020/11/25/DTkrw8jPoHdp3Fe.png" alt="image.png" style="zoom:150%;" />
- B类地址
  - 网络地址的最高位是10的地址为B类地址。IP地址第1部分的取值范围为128-191。
  - B类网络默认子网掩码为255.255.0.0。主机ID由第3部分和第4部分组成，每个（是指每一个网络号）B类网络可以各纳的最大主机数量256×256-2=65023。（同样，主机号全0和全1都不能用，所以减了2）
  - <img src="https://i.loli.net/2020/11/25/cNOivyWzj4Z8tGI.png" alt="image.png" style="zoom: 80%;" />
- C类地址
  - 网络地址的最高位是110的地址为C类地址。IP地址第1部分的取值范围为192-223。
  - C类网络默认子网掩码为255.255.255.0。主机ID由第4部分组成，每个C类网络可以容纳的最大主机数量256-2=254。 
  - <img src="https://i.loli.net/2020/11/25/Usx3qZ7GR9r6Mkj.png" alt="image.png" style="zoom:80%;" />
- D类
  - 网络地址的最高位是1110的地址为D类地址。D类地址第1部分的取值范围为224-239。用于多播（也称为组播）的地址，**组播地址没有子网掩码。**
  - **这种地址不能给计算机使用**，它没有子网掩码。**它只能用作数据包的目标地址**
  - ![image.png](https://i.loli.net/2020/11/25/YFGfz2LQ4TaOq3A.png)
- E类
  - 网络地址的最高位是11110的地址为E类地址。第一部分取值范围240-254，保留为今后使用，在本书中并不讨论这些类型的地址（并且你也不要求了解这些内容）。
  - **几乎没有人使用这个IP地址，没见过**
  - ![image.png](https://i.loli.net/2020/11/25/3mdNAB7yYQInSMO.png)
- 总结：
  - 判断一个地址属于哪一类，就看ip的第一部分，即前8位。
  - <img src="https://i.loli.net/2020/11/25/YQrcb41gmBL5ajR.png" alt="image.png" style="zoom:50%;" />
  - A类地址，第一部分为：1-126   （0不能用，127有特殊用途）
  - B类地址，第一部分为：128-191
  - C类地址，第一部分为：192-223
  - D类地址，第一部分为：224-239
  - E类地址，第一部分为：240-254  （255不能用）

### 4.4保留的IP地址(代表网段的地址、代表广播的地址、代表本地环回的地址、代表没有DHCP服务器时windows系统给计算机临时分配的地址、全0地址（冲突地址）)

- **主机ID全为0的地址**：特指某个网段，比如192.168.10.0/255.255.255.0，指192.168.10.0网段。
- **主机ID全为1的地址**：特指该网段的全部主机，如果你的计算机发送数据包使用**主机ID全是1的IP地址**，**数据链层地址用广播地址即MAC FF-FF-FF-FF-FF-FF**。
  - 比如我的IP地址：115.156.215.180/22
    - ![image.png](https://i.loli.net/2020/11/25/lVrUsd4GczjJnHh.png)
  - ping我这个网段的广播地址 115.156.215.255
  - ![image.png](https://i.loli.net/2020/11/25/EzJq3K9YsflUOje.png)
  - 可以看到，所有该网段的在线计算机都给我回了信息
- **127.0.0.1地址**：是本地环回地址，指本机地址，一般用来测试使用。回送地址(127.x.x.x)是本机回送地址(Loopback Address)，即主机IP堆栈内部的IP地址。
  - ping127开头的IP地址都能ping通，比如ping 127.13.50.123，随便输，只要开头是127就能通
    - 甚至没有网卡，都能ping通。127开头的IP不需要物理网卡。要是这个都ping不通，说明计算机该重装了，因为TCP/IP协议工作都不正常了
  - 但是想看本地的共享资源的话，只能`\\127.0.0.1`才行
- **169.254.0.0网段**：169.254.0.0-169.254.255.255  实际上是自动私有IP地址。
  - 只要windows操作系统，把地址设置成了自动获得。它就会向网络中的DHCP服务器发送请求，请求得到一个合法的地址。如果网络中没有DHCP服务器给他分配地址，那么该windows计算机就会给自己分配一个169.254.0.0这个网段的地址
  - 这是干啥用的？用于不懂网络的网管，给每个计算机设置自动获得IP，又没有设置DHCP服务器。那么该局域网下的这一堆windows计算机也会自动地协调IP，不让他们IP发生冲突，就协调在了169.254.0.0这个网段，每台windows会有个不冲突的IP
  - 得到169.254.0.0网段的计算机呢，就算有了这个地址，还是会不甘心，每隔几分钟就发个广播包请求DHCP服务器分配IP。一旦DHCP服务器给他们分配了IP，这个169.254开头的IP立马作废，就换成DHCP分配的IP
- **0.0.0.0地址**：如果计算机的IP地址和网络中的其他计算机地址冲突（或者是计算机在等待DHCP分配IP这段时间内，看计算机的IP也会是0.0.0.0），使用ipconfig命令看到的就是0.0.0.0，子网掩码也是0.0.0.0
  - 在win7下IP重复了，会把它的IP设置到169.254上，不是0.0.0.0了
  - windows xp下IP重复了，会确实分配成0.0.0.0

### 4.5公网IP地址和私网IP地址

- 公网地址
  - 公有地址分配和管理由Inter NIC（Internet Network Information Center 因特网信息中心）负责。各级ISP使用的公网地址都需要向Inter NIC提出申请，由Inter NIC统一发放，这样就能确保地址块不冲突。
  - 公网地址全球统一规划，网段不能冲突和叠加。
- **私网地址**
  - 创建IP寻址方案的人也创建了私网IP地址。这些地址可以被用于私有网络，在Internet没有这些IP地址，没有任何一个网站使用这些私有地址，这是提前规划好的。Internet上的路由器也没有到私有网络的路由表。
  - A类：10.0.0.0/255.0.0.0，保留了1个A类网络
    - （从总共的126个A类网络号里留了**1个A类网络号用做私网**）。
    - 每一个网络号的主机数=256x256x256 -2=16777214    
    -  （减去的2是一个全0的主机号，和一个全1的主机号）
  - B类：172.16.0.0/255.255.0.0～172.31.0.0/255.255.0.0，保留了16个B类网络号
    - （从总共的64x256=16384个B类网络号里留了**16个B类网络号用做私网**）。
    - 每一个网络号的主机数=256x256-2=65534
    - （减去的2是一个全0的主机号，和一个全1的主机号）
  - C类：192.168.0.0/255.255.255.0～192.168.255.0/255.255.255.0，保留了256个C类网络。
    - （从总共的32x256x256=2097152个C类网络号里，留了**256个C类网络号用做私网**）
    - 每一个网络号的主机数=256-2=254
    - （减去的2是一个全0的主机号，和一个全1的主机号）

### 4.6私网地址想访问Internet需要进行网络地址转换NAT和端口地址转换

问题：反正私网地址你都会在网关那儿进行网络地址转换，那么私网地址何必非得用那些专属的保留网段的IP呢？

- 答案。假如你的局域网使用的IP不是保留网段192.168这种了，用了个115.123....等等的公网IP。那你去访问百度182.61.200.6等，都不会有问题。问题就在，一旦你要访问115.123...的公网的时候，你的电脑一解析，认为是局域网IP了，就不再去网关那儿转发了，就在局域网内寻找。结果就是找不到，访问失败。
- 所以，私网地址，避免麻烦，还是使用保留的那些专用的私网地址。因为，互联网上没有任何一台计算机把这些保留的专用的私网地址用作公网IP
- ![image-20210113152314358](http://pichost.yangyadong.site/img/image-20210113152314358.png)
- 所以一个公网IP最多可以支撑多少台电脑上网呢？
  - 这不一定，但是有一点可以确定的是，一个公网IP在同一时刻最多支持65536个TCP连接（或者说是65536个端口可用）。
  - 而一般来说，一台电脑某一时刻使用的TCP连接也就100来个。（大数据统计的）
  - 所以理论上，一个公网ip可以带600到900台这样的电脑同时上网，实际使用中不会所有主机同时上网，所以1个公网IP带1千多台是没问题的。
  - 当然，一个公网ip能带多少内部主机，不能一概而论，要根据内部主机的应用情况，只要同一时刻的总连接数小于一个公网ip的总连接数（65536）就可以了。
  - 换句话说，端口地址转换表，这个表项同一时刻最多维系65536条映射数据。因为公网IP的端口就65536这么多。

### 4.7子网划分

#### 4.7.1为什么要划分子网

因为公网地址不够用了，充分利用公网的手段，避免公网地址浪费

#### 4.7.2地址浪费的例子

- 按着IP地址传统的分类方法，**如果一个网段有200台计算机，分配一个C类网络，可以容纳254台主机**，212.2.3.0 255.255.255.0，可用的地址范围212.2.3.1—212.2.3.254，虽然没有全部用完，**这种情况还不算是极大浪费**。
- **如果一个网络中有400台计算机，如果分配一个C类网络，只能容纳254台主机，地址就不够用**了。那就**分配一个B类网络**，比如131.107.0.0 255.255.0.0，该B类网络可用的地址范围131.107.0.1—131.107.255.254，**一共有65534个地址可用，这就造成了极大浪费。**

#### 4.7.3一个C类网络等长子网划分为两个子网

- 子网划分，就是借用现有网段的主机位做子网位，划分出多个子网。子网划分的任务包括两部分：
  - 确定子网掩码的长度。
  - 确定子网中第一个可用的IP地址和最后一个可用的IP地址。
- 等长子网划分就是将一个网段等分成多个网段，也就是等分成多个子网。
- 举例：
  - 将网段 192.168.0.0/255.255.255.0 等长划分成2个子网
  - ![image.png](https://i.loli.net/2020/11/26/PYFSu5yekEmpaT4.png)
  - A子网
    - 网络号：192.168.0.0    子网掩码：255.255.255.128
    - IP取值范围：192.168.0.1~192.168.0.126（支持126台设备）
    - 广播地址：192.168.0.127（主机位全为1）
  - B子网
    - 网络号：192.168.0.128  子网掩码: 255.255.255.128
    - IP取值范围：192.168.0.129~192.168.0.254（支持126台设备）
    - 广播地址：192.168.0.255（主机位全为1）
  - A和B两个子网的子网掩码都为255.255.255.128。
  - 这样的话AB子网不能直接通信，想通信需要借助路由
  - ![image.png](https://i.loli.net/2020/11/26/MnfhZjsHzUELBGa.png)

#### 4.7.4一个C类网络等长子网划分为4个子网

子网掩码26位，即255.255.255.192

![image.png](https://i.loli.net/2020/12/05/AlTuxVSe2nsBQ9I.png)

**数轴上的都是子网络号**

#### 4.7.8一个C类网络等长子网划分为8个子网

子网掩码24+3=27位，即255.255.255.224

![image.png](https://i.loli.net/2020/12/05/d5tZ4uPVMKloLFD.png)

- A：子网段192.168.0.0/27
- B：子网段192.168.0.32/27
- C：子网段192.168.0.64/27
- D：子网段192.168.0.96/27
- E：子网段192.168.0.128/27
- F：子网段192.168.0.160/27
- G：子网段192.168.0.192/27
- H：子网段192.168.0.224/27

把子网络号先算出来，剩下的就好算了。

比如算一下A子网，那它的广播地址就是B子网号-1即192.168.0.31

那么A子网的可用IP范围，即192.168.0.1~192.168.0.30

#### 4.7.9变长子网划分

比如给你一个C类网络：

192.168.0.0  255.255.255.0   易知一个C类网络最多容纳254台主机

要求划分成3个子网，一个子网容纳100台，一个子网容纳50台，一个子网容纳20台电脑。三个子网要用路由器隔开

![image.png](https://i.loli.net/2020/12/05/LEFSiRegzH7xB35.png)

- 网段C:
  - 子网号：192.168.0.128=192.168.0.1000 0000
  - 子网掩码：                   255.255.255.1000 0000=255.255.255.128（子网掩码决定了只有128个主机号）
  - 可用IP：192.168.0.129~192.168.0.254（其实就126个主机号可用）
  - 广播地址：192.168.0.255
- 网段B:
  - 子网号：192.168.0.64=192.168.0.0100 0000
  - 子网掩码：                 255.255.255.1100 0000=255.255.255.192（子网掩码决定了只有64个主机号）
  - 可用IP：192.168.0.65~192.168.0.126（其实就62个主机号可用）
  - 广播地址：192.168.0.127
- 网段A：
  - 子网号：192.168.0.32=192.168.0.0010 0000
  - 子网掩码：                 255.255.255.1110 0000=255.255.255.224（子网掩码决定了只有32个主机号）
  - 可用IP：192.168.0.33~192.168.0.62（其实就30个主机号可用）
  - 广播地址：192.168.0.63

#### 4.7.10点到点网络的子网掩码（点到点网络只有两个可用IP,子网掩码是255.255.255.252）

按上节这样分配完以后，还剩了192.168.0.0~192.168.0.31还没使用。

接下来把这32个地址划分划分，给路由器之间的网段使用，即D和E

网段D只需要俩地址。网段E也只需要俩地址。即这俩网段都是点到点的网络

下图所示即：192.168.0.XXX

![image.png](https://i.loli.net/2020/12/05/ng58fyla46TIWQP.png)

- 网段D：
  - 子网号：192.168.0.0
  - 子网掩码：255.255.255.1111 1100=255.255.255.252（子网掩码决定了这个网段只有4个主机号）
  - 可用IP:192.168.0.1~192.168.0.2（其实就2个主机号可用）
  - 广播地址：192.168.0.3
- 网段E：
  - 子网号：192.168.0.4
  - 子网掩码：255.255.255.1111 1100=255.255.255.252（子网掩码决定了这个网段只有4个主机号）
  - 可用IP:192.168.0.5~192.168.0.6（其实就2个主机号可用）
  - 广播地址：192.168.0.7
- 最终合理划分后，还保留了192.168.0.8~192.168.0.31未用

### 4.8子网掩码的另外一种表示方法-CIDR

- IP地址有“类”的概念，A类地址默认子网掩码255.0.0.0、B类地址默认子网掩码255.255.0.0、C类地址默认子网掩码255.255.255.0。等长子网划分和变长子网划分，打破了IP地址“类”的概念，子网掩码也打破了字节的限制，这种子网掩码被称为VLSM（Variable Length Subnet Masking，可变长子网掩码）

  - 即如果没有子网划分的话，子网掩码只有3种：255.0.0.0、255.255.0.0、255.255.255.0。有了子网划分后，打破了这个类别限制

- 这种方式的也可以使得Internet上的路由器路由表大大精简，被称为CIDR（无类域间路由，Classless Inter-Domain Routing），子网掩码中1的个数被称为CIDR值。

- ```
              二进制子网掩码               十进制子网掩码    CIDR值
  11111111. 00000000. 00000000.00000000  255.0.0.0        /8
  11111111. 10000000. 00000000.00000000  255.128.0.0      /9
  11111111. 11000000. 00000000.00000000  255.192.0.0      /10
  11111111. 11100000. 00000000.00000000  255.224.0.0      /11
  11111111. 11110000. 00000000.00000000  255.240.0.0      /12
  11111111. 11111000. 00000000.00000000  255.248.0.0      /13
  11111111. 11111100. 00000000.00000000  255.252.0.0      /14
  11111111. 11111110. 00000000.00000000  255.254.0.0      /15
  11111111. 11111111. 00000000.00000000  255.255.0.0      /16
  11111111. 11111111. 10000000.00000000  255.255.128.0    /17
  11111111. 11111111. 11000000.00000000  255.255.192.0    /18
  11111111. 11111111. 11100000.00000000  255.255.224.0    /19
  11111111. 11111111. 11110000.00000000  255.255.240.0    /20
  11111111. 11111111. 11111000.00000000  255.255.248.0    /21
  11111111. 11111111. 11111100.00000000  255.255.252.0    /22
  11111111. 11111111. 11111110.00000000  255.255.254.0    /23
  11111111. 11111111. 11111111.00000000  255.255.255.0    /24
  11111111. 11111111. 11111111.10000000  255.255.255.128  /25
  11111111. 11111111. 11111111.11000000  255.255.255.192  /26
  11111111. 11111111. 11111111.11100000  255.255.255.224  /27
  11111111. 11111111. 11111111.11110000  255.255.255.240  /28
  11111111. 11111111. 11111111.11111000  255.255.255.248  /29
  11111111. 11111111. 11111111.11111100  255.255.255.252  /30     点到点网络只有两个可用IP
  ```

### 4.9判断一个IP地址所属的网段

- IP地址中主机位归0就是该主机所在的网段。
- 判断192.168.0.101/26所属的子网。
  - IP地址：	     192.168.0.101
  - IP地址：         192.168.0.01100101
  - 子网掩码：255.255.255.11000000
  - 子网网络号：192.168.0.01000000
  - 子网网络号：192.168.0.64

### 4.10子网划分需要注意的几个问题

- 将一个网络等分成2个子网，每个子网肯定是原来的一半。（一定要均匀分）
  - ![image.png](https://i.loli.net/2020/12/06/UfRCdWyGbFzc63p.png)
- 子网地址范围不可重叠
  - ![image.png](https://i.loli.net/2020/12/06/GAraFgdky5Re8UH.png)
- 比如一个个C类网段，共256个主机号
  - 你想划分成一个200台，一个30台
  - 这绝对做不到。你必须得再给一个网段。
  - 因为就算是变长子网划分，切开以后，最长是128....就不可能有200这种
  - 想容纳200台，就必须得是一个完整地256 C类网段
  - 想容纳50台，那也起码是一个完整地64 长度的网段。

### 4.11使用超网合并网段（跟划分子网相反，把多个网段合并成一个网段）

![image.png](https://i.loli.net/2020/12/06/VcZXivl8kK2Fzy1.png)

- 背景介绍
  - 某企业有一个网段，该网段有200台计算机，使用192.168.0.0 255.255.255.0网段，就是B计算机所在的。相当于有200台B，接在了交换机上
  - 后来，企业又添置了200台计算机，使用192.168.1.0 255.255.255.0网段，就是A计算机所在。相当于有200台A，接在了交换机上
  - 这两个交换机又是直接相连的。
  - 其实物理上，上边200台和下边200台可以直接通信。但是逻辑上，认为不在同一网段。通信时，会发送给网关。
  - 比如，A计算机IP 192.192.1.2/24，要发数据给B计算机192.168.0.2/24。一比较网络号，不在同一网段。那数据包就发给网关了，网关上可以设置两个IP。网关一看，要发的数据是给B计算机，网关再转发过去。
  - 这样是可以通的，但是呢，多次一举了。因为AB物理上是相连的，何必多走一遭网关呢
- 解决方案
  - 超网合并
  - 我把他们的子网掩码不设置为255.255.255.0。全部设置为255.255.254.0。这样一算，他们就处于同一网段了。
  - 原则就是往前移动子网掩码，让它们网络号一样就行了。

### 4.12判断一个网段是子网还是超网

- 通过左移子网掩码合并多个网段，右移子网掩码将一个网段划分成多个子网，使得IP地址打破了传统的A类、B类、C类的界限。
- 判断一个网段到底是子网还是超网，就要看该网段是A类网络、还是B类网络、还是C类网络，默认A类子网掩码/8，B类子网掩码是/16，C类子网掩码是/24。
- **如果该网段的子网掩码比默认子网掩码长，就是子网，如果该网段的子网掩码比默认子网掩码短，则是超网。**
- 举例
  - 192.168.0.0/16是什么
    - 192开头，属于C类网络。它本来呢应该是24位子网掩码的，现在只有16了，所以是个超网。
  - 92.168.0.0/16是什么
    - 92开头，属于A类网络。它本来呢应该是8位子网掩码的，现在是16了，所以是个子网。
  - 128.167.0.0/16是什么
    - 128开头，属于B类网络。本来就是16位子网掩码，现在还是16，是个标准B类网络。不是子网也不是超网。

### 4.13总结

- MAC与IP的区别

  - **数据包的目标IP地址决定了数据包最终到达哪一个计算机**
  - 而**目标MAC地址决定了该数据包下一跳由哪个设备接收，不一定是终点（很有可能是路由器）**

- 路由器的作用:

  - 在不同网段转发数据包

- IP地址的格式

  - IP地址共32位，网络号+主机号组成

- 子网掩码：又叫网络掩码、地址掩码

  - 作用：告诉计算机，IP地址里，哪部分是网络号，哪部分是主机号

- 数据发送的过程

  - 假如A要给B发数据。
  - 计算机A怎么知道和计算机B在不在同一网段下呢，计算机A就用**A的子网掩码**，**跟A的IP地址**算一算，得到A所在的网段。计算机A用**A的子网掩码**（只能用A的子网掩码，因为B的你不知道）跟**B的IP地址**算一算，得到B所在的网段。然后比较这俩网段是不是一样的。
  - **假如A和B处于同一网段下（相当于俩计算机在一个局域网下，用交换机连的，根本不用过路由器）**：那计算机A就发arp广播包，询问局域网上所有机器，我需要知道目标（即计算机B）IP的MAC，然后目标电脑B接到这个指令，给它返回一个信息，告诉发送机A我的MAC是...然后A就可以封装以太网帧发送了
  - **假如A和B不在同一网段下（相当于俩计算机不在在一个局域网下，必须要用路由器来转发）**：那计算机A就发arp广播包，询问局域网上所有机器，询问网关（即路由器）你的MAC是多少，我需要你替我转达一个包，然后网关接到这个指令，给他返回一个信息，告诉计算机A，本网关的MAC是....然后A就可以封装以太网帧发送给网关了，靠路由器继续传送，最后抵达计算机B

- 子网掩码设置错误，很可能让本处于两个网段的计算机，误以为它俩其实在同一个网段下，就不通过网关代理了。那样网络肯定是通不了的。

- IP地址分类

  - 255.255.255.255

    第一部分   |  第二部分 | 第三部分  |  第四部分|

    1111 1111. 1111 1111. 1111 1111. 1111 1111

  - 判断一个地址属于哪一类，就**看ip的第一部分，即前8位**。

  - 另一种方法，通常我们判断一个ip地址是A类还是B类C类，几乎都是看子网掩码255.255.255.0，明摆着前三位网络位，第四位主机位，很显然是C类。

  - <img src="https://i.loli.net/2020/11/25/YQrcb41gmBL5ajR.png" alt="image.png" style="zoom:50%;" />

  - A类地址，第一部分为：1-126   （0不能用，127有特殊用途）

    - 默认子网掩码：255.0.0.0
    - 网络.节点.节点.节点，8位表示网络，24位表示主机位
    - 共有(126-1+1)=126个网络，每个网络可以容纳主机数256x256x256-2=16777214=1600多万台设备
    - （减去的2是一个全0的主机号，和一个全1的主机号）

  - B类地址，第一部分为：128-191

    - 默认子网掩码：255.255.0.0
    - 网络.网络.节点.节点，16位表示网络，16位表示主机位
    - 共有(191-128+1)x256=16384个网络，每个网络可以容纳主机数256x256-2=65534台设备

  - C类地址，第一部分为：192-223

    - 默认子网掩码：255.255.255.0
    - 网络.网络.网络.节点，24位表示网络，8位表示主机位
    - 共有(223-192+1)x256x256=2097152个网络，每个网络可以容纳主机数256-2=254台设备
    - 适用于小规模的局域网络

  - D类地址，第一部分为：224-239

    - 用于多播（也称为组播）的地址，组播地址没有子网掩码。
    - **这种地址不能给计算机使用**，它没有子网掩码。**它只能用作数据包的目标地址**

  - E类地址，第一部分为：240-254  （255不能用）

    - 保留为今后使用，也从未见过有人使用

- 保留的IP地址

  - 主机ID全为0的地址（代表网段的地址）
  - 主机ID全为1的地址（代表广播包的地址）
  - 127.0.0.1地址 以及127.0.0.0/8网段
    - 本地环回地址 和 本地网段
  - 169.254.0.0网段
    - 代表没有DHCP服务器时windows系统给计算机临时分配的网段
  - 0.0.0.0地址
    - 说明刚才设置的IP有冲突，已经有设备用了这个IP了

- 公网IP和私网IP

  - 公网地址
    - 公有地址分配和管理由Inter NIC（Internet Network Information Center 因特网信息中心）负责。各级ISP使用的公网地址都需要向Inter NIC提出申请，由Inter NIC统一发放，这样就能确保地址块不冲突。
    - 公网地址全球统一规划，网段不能冲突和叠加。
  - 私网地址
    - A类网络号1个：10.0.0.0/255.0.0.0
      - 总共126个里留了这1个做私网网络号，每个网络号支持16777214   台主机
    - B类网络号16个：172.16.0.0/255.255.0.0～172.31.0.0/255.255.0.0
      - 总共16384个里留了这16个做私网网络号，每个网络号支持65534  台主机
    - C类网络号256个：192.168.0.0/255.255.255.0～192.168.255.0/255.255.255.0
      - 总共2097152个里留了这256个做私网网络号，每个网络号支持256-2=254 台主机

- 子网划分

  - 就是本来ABCDE类网络，划分的很好了。但是会有浪费
  - 比如本来的一个C类网络 192.168.0.0/24。我有两个100台电脑，想把这一个网段划分成俩，让它们不能直接通信，用路由器隔开。
  - 那就一个占网段192.168.0.0/25。可以容纳126台电脑
  - 另一个占网段192.168.0.128/25。也可一个容纳126台电脑
  - **原则就是往后移动子网掩码，让它们处于不同的网络号上。（往后移动是相对默认掩码）**
  - 子网划分时，你说让我划分个正好只容纳200台主机的网段。那不可能，只能是起码254台主机。
  - 正好划分个值容纳50台主机的网段。那也不可能，只能是起码62台主机。

- 超网合并

  - 有200台电脑，占据了192.168.0.0/24
  - 有另外200台电脑，占据了192.168.1.0/24网段
  - 它们其实是两个交换机直接相连的，物理上可以通信，但是逻辑上处于俩网段。通信起来要走网关多此一举。
  - 那这400台电脑，IP不用动。子网掩码都设置成23。这样逻辑上就处于一起了。
  - **原则就是往前移动子网掩码，让它们网络号一样就行了。（往前移动是相对默认掩码）**

- 判断一个网段是子网还是超网

  - 判断一个网段到底是子网还是超网，就要看该网段是A类网络、还是B类网络、还是C类网络，默认A类子网掩码/8，B类子网掩码是/16，C类子网掩码是/24。
  - **如果该网段的子网掩码比默认子网掩码长，就是子网，如果该网段的子网掩码比默认子网掩码短，则是超网。**
  - 举例
    - 192.168.0.0/16是什么
      - 192开头，属于C类网络。它本来呢应该是24位子网掩码的，现在只有16了，所以是个超网。
    - 92.168.0.0/16是什么
      - 92开头，属于A类网络。它本来呢应该是8位子网掩码的，现在是16了，所以是个子网。
    - 128.167.0.0/16是什么
      - 128开头，属于B类网络。本来就是16位子网掩码，现在还是16，是个标准B类网络。不是子网也不是超网。

## 5.静态路由和动态路由

### 5.1IP路由-网络层实现的功能

- 网络层功能就是给传输层协议提供简单灵活的、无连接的、尽最大努力交付的数据包服务。
- 通俗一点来讲，网络中的路由器**为每一个数据包单独的选择转发路径**（也就是网络层的功能），网络层不提供服务质量的承诺。
  - 也就是说网络层**不提供可靠传输**，可以丢包
  - **路由器直接丢弃传输过程中出错的数据包。**
  - **如果网络中待发的数据包太多，路由器处理不了就直接丢弃。**
  - **路由器不判断数据包是否重复，也不确保数据包按发送顺序到达终点。（数据包按序排列是传输层做的）**
    - 发的时候肯定是按顺序发的，但是路由器转发的时候，有的数据包走那一个路径，有的数据包走另一个路径，不一定谁先到达呢。所以先发的可不一定先到，因为不同数据包路径可能不一样，路由器为每一个数据包单独的选择转发路径。
- 传输层提供可靠传输，也就是说发送过去的东西，对方在传输层必须回复响应说已经收到了
- ![image.png](https://i.loli.net/2020/12/08/D7EATNlBpyUc4en.png)

### 5.2网络畅通的条件

- 数据包有去有回，这个网就通了
  - 有去很好理解，就是发送的内容能送达
  - 有回是指，目标主机收到了，回复一个信号给发送端说收到了
- ![image.png](https://i.loli.net/2020/12/08/uf8vaS7DdWAbOwe.png)
- 数据包可以从A发到B
  - R1 R2 R3都得有路由表，知道怎么前往192.168.1.0/24网段
  - 假如R2不知道怎么前往192.168.1.0/24网段。那么A发给R1，R1发给R2后，R2不知道怎么转发就把这个数据包扔掉了，并且产生一个新的ICMP响应数据包告诉A计算机不知道目标网段怎么走
- 数据包可以从B发到A
  - R1 R2 R3都得有路由表，知道怎么前往192.168.0.2/24网段

**所以有两种情况**

- 1.目标主机不可到达。即不能去，数据包没到目的地

  - ```powershell
    C:\Users\杨亚东>ping 192.168.10.10 -S 192.168.10.1
    
    正在 Ping 192.168.10.10 从 192.168.10.1 具有 32 字节的数据:
    来自 192.168.10.1 的回复: 无法访问目标主机。##这就是某个路由器不知道怎么转发这个数据包，扔掉了，并产生一个ICMP响应回复
    来自 192.168.10.1 的回复: 无法访问目标主机。
    来自 192.168.10.1 的回复: 无法访问目标主机。
    来自 192.168.10.1 的回复: 无法访问目标主机。
    
    192.168.10.10 的 Ping 统计信息:
        数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，
    
    C:\Users\杨亚东>
    ```

  - 一般是，这个主机不在线

  - 反正肯定是无法到达

- 2.请求超时。即不能回，数据包到了目的地，返不回来

  - ```powershell
    C:\Users\杨亚东>ping www.google.com
    
    正在 Ping www.google.com [2404:6800:4012::2004] 具有 32 字节的数据:
    请求超时。
    请求超时。
    请求超时。
    请求超时。
    
    2404:6800:4012::2004 的 Ping 统计信息:
        数据包: 已发送 = 4，已接收 = 0，丢失 = 4 (100% 丢失)，
    ```

  - 可能是目标主机在线，但没办法返回来。

  - （也有可能是第一个路由器能转发出去，但是之后的路由器转发失败了。无法判断主机在不在线）

  - 反正肯定是无法返回

**网络排错**

- 明白了网络畅通的条件，网络排错就变得简单了。
- 先检查数据包是否能够到达目标网络
- 再检查数据包是否能够返回来。
- 如果网络不通，您就要检查计算机是否配置了正确的IP地址子网掩码以及网关，再逐一检查沿途路由器上的路由表，查看是否有到达目标网络的路由；
  - 也就是排查能否顺利到达
- 然后逐一检查沿途路由器上的路由表，检查是否有数据包返回所需的路由。
  - 也就是排查能否顺利返回

### 5.3静态路由

路由器一开始接到网上，它并不知道这个网络中都有哪些网段。它只知道它直连的有哪些网段。没有直连的它都不知道。

- 路由器直连的网段，无需添加，路由器自己知道怎么走
- 管理员需要在路由器上添加路由器没有直连的网段，下一跳怎么走
- 要想实现全网畅通，网络中的路由器必须知道到所有网段如何转发

![image.png](https://i.loli.net/2020/12/09/NHk2EXQBWTqJP97.png)

- 按上图这样搭建之后，从PC1 ping PC2可以通
  - 但是PC1 ping 172.16.1.1或者 ping 172.16.1.2都通不了。因为R1路由表不知道怎么去172.16.1.0/24网段，它只知道怎么去192.168.1.0/24网段（静态路由添加的）和172.16.0.0/24网段（路由器直连）和192.168.0.0/24网段（路由器直连）
  - 因此PC1 ping 172.16.1.1时，发给了R1路由器，路由器一查表，不知道怎么去172.16.1.0/24网段。就把该数据包扔掉，并返回一个ICMP告诉PC1，这个不通，目标主机不可到达。
  - 所以想PC1 ping通172.16.1.0/24网段，必须得在R1路由器上`ip route 172.16.1.0 255.255.255.0 172.16.0.2`添加这样的路由表
- 同理PC2 pingPC1可以通。
  - 但是PC2 ping 172.16.0.2或者ping 172.16.0.1也都通不了。因为R3路由表不知道怎么去172.16.0.0/24网段。

所以啊，PC1和PC2这两个最远端通了，不一定PC1到中间节点可以通。因为有的网段，路由器不知道怎么去，你没告诉它。

### 5.4静态路由扩展与总结

- 添加静态路由的命令
  - 去指定网段：
    - ip route 网络号 子网掩码 下一跳地址
    - `R1(config)#ip route 192.168.1.0 255.255.255.0 172.16.0.2`
  - 也可以去指定IP：
    - `R1(config)#ip route 192.168.1.2 255.255.255.255 172.16.0.2`
    - 子网掩码全是1，那就认为是指定IP了
    - （很少有人这样添加静态路由）
  - 对于**点到点路由器链路**，比如R1到R2
    - `R1(config)#ip route 192.168.1.0 255.255.255.0 172.16.0.2`
      - ​                                        网络号              子网掩码            下一跳
    - 等价于
    - `R1(config)#ip route 192.168.1.0 255.255.255.0 serial 2/0`
      - ​                                           网络号             子网掩码           R1的出口
    - **只有点到点路由器链路才可以，因为出口和接收口是唯一的，下一跳别无选择，只能走这儿。**
    - 如果不是点到点链路，出口唯一，接收口可能有交换机有路由器，必须得写下一跳地址（肯定是路由器的地址）
    - 举个例子，下图就不是点到点链路
    - ![image.png](https://i.loli.net/2020/12/09/kRGjoMmAdgYyFNL.png)
    - 像这个情况，R4的路由表配置时，必须得写下一跳是R5的f1/1的地址。而不能写R4的 fastEthernet1/1出口。因为从这口出去，不知道分到哪儿去了

### 5.5路由汇总

每个路由器的路由表，也不能一个一个添加上前往所有的internet网段的下一跳吧。所以路由器上通过路由汇总和默认路由来简化路由表。

![image-20201219160655073](https://i.loli.net/2020/12/19/jS23pt1ByQJlOnW.png)

如果没有路由汇总，那R1路由器，就得一个一个网段添加，添加256条，从北京到石家庄每个网段怎么走。虽然下一跳都一样。

路由汇总： 

- 从北京到石家庄的总路由器R1，原来的256条路由表可以写成一条
  -  R1(config)#ip route 172.16.0.0 255.255.0.0 10.0.0.2
  - 子网合并成标准B类网段
- 从石家庄到北京的总路由器R2，原来的256条路由表可以写成一条
  - R2(config)#ip route 192.168.0.0 255.255.0.0 10.0.1
  - 每个标准C类网段，进行超网合并

**可以路由汇总的条件**

- 某一个地址块给了物理地址连续的网段。在其他地区的路由器上才能够汇总成1条

### 5.6路由汇总例外和精确汇总

- 针对例外的网段需要单独添加路由
  - ![image-20201219161640651](https://i.loli.net/2020/12/19/CWekVuJNBTxRnKH.png)
  - 路由器转发判断时候，是肯定会先判断是否例外的。与添加顺序无关
- 无类域间路由（CIDR）
  - 无类域间路由（CIDR）采用13～27位可变网络ID，而不是A、B、C类网络ID所用的固定的8、16和24位。
  - 这样我们可以将子网掩码向左移动1位，合并两个网段；向左移动2位合并4个网段；向左移动3位合并8个网段；向左移动n位，就可以合并2n个网段。
  - 打破了原来的ABCDE类的概念。没有这个类了。
  - ![image-20201219164214228](https://i.loli.net/2020/12/19/U69WAasQOlI5uo7.png)

### 5.7全球最大的网段和默认路由

- 全球最大的网段即 0.0.0.0/0，包含了所有网段。

  - ip route 0.0.0.0 0.0.0.0 10.0.0.2
  - 上边这个意思就是默认路由。发往所有的网段的数据包下一跳都是10.0.0.2

- 假设路由表中有4条记录

  - ```
    ip route 172.16.1.0 255.255.255.0 10.0.0.1
    ip route 172.16.0.0 255.255.0.0 10.0.0.2
    ip route 172.0.0.0 255.0.0.0 10.0.0.3
    ip route 0.0.0.0 0.0.0.0 10.0.0.4    默认路由
    ```

  - 比如过来一个数据包说要发往172.16.5.7，它会从子网掩码最长的路由表记录开始比较

    - 第一次比较，它不属于172.16.1.0 255.255.255.0
    - 第二次比较，一看它属于172.16.0.0 255.255.0.0，所以下一跳转给10.0.0.2

  - 比如过来一个数据包说要发往173.16.5.7，也从子网掩码最长的路由表记录开始比较

    - 上边三条都不符合。所以按默认路由转发

### 5.8默认路由应用场景

#### 1.默认路由指向internet

与路由器直连的网段，路由器自己就知道怎么转发，不需要告诉它。

- 网络末端路由器B和D只需添加一条默认路由。
  - ![image-20201219191731517](https://i.loli.net/2020/12/19/lJLnj4EXaZRey5h.png)
- RA路由器上的路由表也可以精简。在A路由器上可以把内网看做是10.0.0.0  255.0.0.0这个网段。所以只需添加一条路由。
  - ![image-20201219191803673](https://i.loli.net/2020/12/19/TYQPr4lX3uWStzg.png)

### 5.9让默认路由代替大多数网段的路由

#### 让默认路由代替大多数网段的路由

- ![image-20201219192502456](https://i.loli.net/2020/12/19/zx7Ueh2SKCBGkvd.png)
- 一共有7个网段。
  -  对于A路由器。1、2网段它都会走，剩下的34567网段不会，恰巧都在同一侧。那么
    - 只需要再添加一个默认路由指向172.17.0.2就可以。（其实路由器还有两条路由条目，即前往它直接相连的网段）
  - 对于B路由器。2、3网段它会走。1、4、5、6、7网段它不会。
    - 去往1网段的，下一跳172.17.0.1
    - 剩下的，全部默认路由给172.18.0.2
  - 对于C路由器来说。3、4网段它会走。12和567网段它不会。
    - 方案①：去往1网段的，下一跳172.18.0.1
      			   去往2网段的，下一跳172.18.0.1
            			    剩下的，默认路由给172.19.0.2
    - 方案②：去往5网段的，下一跳给172.19.0.2
                      去往6网段的，下一跳给172.19.0.2
                     去往7网段的，下一跳给172.19.0.2
                      剩下的，默认路由给172.18.0.1
    - 对于C路由器来说，1和2两种方式都可以，但1这种方式路由条目更少。
  - D、E、F路由器同理
  - 原则就是尽量让默认路由代替较多的路由条目

#### 环状网络

![image-20201219194316952](https://i.loli.net/2020/12/19/UyIPjDWtAmZJhHg.png)

所有路由器都省事，就一条默认路由指向下一个，形成环。

这样做，反正各个计算机通是能通。合不合理另说。

#### 默认路由造成的往复转发

![image-20201219194441264](https://i.loli.net/2020/12/19/L4UDy3JtbNA1QSI.png)

- 这种情况下，A发数据包给B计算机或者是B发数据包给A计算机，都没有问题。能通。
- 但是问题在于：假如A或者B计算机要发给一个不在这三个网段里的地址，比如10.0.0.1。这样一来，就会造成两个路由器之间的往复转发了。
  - 好在数据包在网络层有一个字段是 TTL=Time To Live,生存时间值。每过一个路由器，TTL值就减1。减到0时，这个数据包就被扔掉了。
  - 所以好在具有TTL机制，这样的话不至于俩路由器无止境的来回往复转发

### 5.10全球internet上路由器的路由表

**使用默认路由和路由汇总简化路由表**

![image-20201219201449920](https://i.loli.net/2020/12/19/uTO3bRVigvk5EZz.png)

-  FGH这三个市级末端路由器
  - 添加一个默认路由给省级路由器C就行。
    - 比如F：ip route 0.0.0.0 0.0.0.0 40.2.0.1
    - G: ip route  0.0.0.0 0.0.0.0 40.2.0.5
    - H:ip route  0.0.0.0 0.0.0.0 40.2.0.9
- 省级C路由器
  - 到石家庄怎么走：ip route 40.2.1.0 255.255.255.0 40.2.0.2
  - 到秦皇岛怎么走：ip route 40.2.2.0 255.255.255.0 40.2.0.6
  - 到保定怎么走：ip route 40.2.3.0 255.255.255.0 40.2.0.10
  - 其余，默认路由给国家级的A路由器 ip route 0.0.0.0 0.0.0.0 40.0.0.13
- 国家级A路由器
  - 到河南省怎么走：ip route 40.1.0.0 255.255.0.0 40.0.0.30     管它去河南哪个市，反正都给它，这就是路由汇总（各个市汇集成省）。
  - 到河北省怎么走：ip route 40.2.0.0 255.255.0.0 40.0.0.14  管它去河北哪个市，反正都给它，这就是路由汇总（各个市汇集成省）。
  - 到英国怎么走：ip route 30.0.0.0 255.0.0.0 12.0.0.9              管它去英国哪个省，反正都给它。这也是路由汇总（各个省汇集成国）。
  - 到美国怎么走：ip route 20.0.0.0 255.0.0.0 12.0.0.2      管它去美国哪个省，反正都给它。这也是路由汇总（各个省汇集成国）。
- 河北省40.2.0.0/16，石家庄40.2.1.0/24，保定40.2.3.0/24.。。省级网段与市级网段的关系，就相当于是路由汇总。国家级网段与省级网段的关系，也相当于是路由汇总。
- ip route 0.0.0.0 0.0.0.0 .......  这就是默认路由
- 利用路由汇总和默认路由大大简化了路由表。每一级路由器上的路由条目都没有很多。

### 5.11windows上的路由表

-  这个默认网关，其实就是默认路由。即电脑默认下一跳都发给192.168.80.2。

  - ![image-20201219205346609](https://i.loli.net/2020/12/19/7vTiMleom2QPU9j.png)

  

- 如果遇到这种情况。web服务器默认路由是 ip route 0.0.0.0 0.0.0.0 132.108.10.1

- 但是web服务器又有时候需要发送包给内网SQL服务器。那就需要手动添加windows电脑路由表了

  - ![image-20201219205430416](https://i.loli.net/2020/12/19/2VIRftJYPLscd7p.png)
  - ![image-20201219210223544](https://i.loli.net/2020/12/19/CLXaD3HxqrkisAF.png)

### 5.12动态路由协议：RIP协议

#### 简介

这一节之前的都是静态路由，不管是路由汇总、默认路由，都是管理员通过ip route来添加路由表，告诉路由器到某一个网段下一跳发给谁。

静态路由的缺点：

- 它不会跟着网络的变化而自动变化，
- 并且仅适合于规模比较小的网络。

动态路由：

- 路由器自己来学习，自己判断到网络中每个网段下一跳怎么转。
- 并且一旦网络有变化，所有的路由器会自己调整。

#### 动态路由协议：RIP协议

- 路由信息协议RIP（Routing Information Protocol）是一个真正的距离矢量路由选择协议。
- 它每隔30秒就送出自己完整的路由表到所有激活的接口。
  - RIPv1版本。路由器通过广播 255.255.255.255 不带子网掩码。不支持变长子网，只支持等长子网
  - RIPv2版本。路由器通过多播 224.0.0.9，带子网掩码。支持变长子网和等长子网
  - 所以路由器是通过广播或者多播的方式，将自己完整的路由表发送到其他路由器。
- **RIP协议选择最佳路径的标准就是跳数，认为到达目标网络经过的路由器最少的路径就是最佳路径。**
  - 它只管跳数少。不管路由器与路由器之间的带宽。换言之，就算路径1有10跳，但是每一跳之间的带宽很高1Gbps。路径2有5跳，每一跳带宽只有1Kbps。RIP协议也会认为路径2更好。这显然不太合适。
- **默认它所允许的最大跳数为15跳，也就是说16跳的距离将被认为是不可达的。**
- 在小型网络中，RIP会运转良好，但是对于使用慢速WAN连接的大型网络或者安装有大量路由器的网络来说，它的效率就很低了。
- ![image-20201220163426787](https://i.loli.net/2020/12/20/hwXj87LOPStxvzW.png)

#### 实验环境

- ![image-20201220173521924](https://i.loli.net/2020/12/20/5hQTrCexUm2fsny.png)
- 网络中一共有5个路由器，0-6共7个网段。
- 5个路由器都配置成RIP协议以后。不需要手动ip route添加路由。路由器通过动态路由就学到了
  - 举例，怎么让R1路由器使用rip协议。需要把它直接相连的3个网段都network上。
    - R1(config)#router rip
      R1(config-router)#network 192.168.0.0
      R1(config-router)#network 192.168.1.0
      R1(config-router)#network 192.168.4.0
      R1(config-router)#version 1
  - 以R1路由器为例。网络中一共7个网段
    - ![image-20201220173645232](https://i.loli.net/2020/12/20/rwzBtqfacdo16GD.png)
    - 直连的三个网段，即C字母标识的。 192.168.0.0/24、192.168.1.0/24、192.168.4.0/24三个网段
    - 还有四个学到的网段，即R字母标识的。192.168.5.0/24、192.168.6.0/24、192.168.2.0/24、192.168.3.0/24四个网段，也知道怎么去了。
    - 所有网段都知道怎么去了，完全无需手动添加静态路由。
- RIP协议的健壮性
  - 当最佳路径没有的时候，路由器可以选择备用路径
  - 当最佳路径恢复了，路由器又可以很快的重新选择该最佳路径

#### RIP协议的格式

- ![image-20201220211120436](https://i.loli.net/2020/12/20/MiI2JrcdfYOnD6s.png)

### 5.13动态路由协议：OSPF协议

#### 简介

- OSPF：open shortest path first。开放最短路径优先协议。
- 每个路由器有3张表
  - 邻居表。通过hello包实现。
  - 所有路由器交换链路数据信息（即邻居信息）后。所有路由器都有了这个表叫链路状态数据库。
  - 然后每个路由器自己算，构造出自己的路由表。该路由表知道到所有网络的距离以及下一跳路由器，但不知道全网拓扑（只有到了下一跳路由器，才能知道再下一跳应当怎么走）
  - ![image-20201220213429042](https://i.loli.net/2020/12/20/f1yeYa4pWEqX9zJ.png)

#### OSPF术语

- Router-ID
  - 网络中运行OSPF协议的路由器都要有一个唯一的标识，这就是Router-ID，并且Router-ID在网络中绝对不可以有重复。
    - 即假如某个路由器有好几个接口，那么就有好几个IP，一个接口是172.16.0.1，一个接口是196.128.0.1。那么Router-ID就是196.128.0.1。选取开启的的并且较大的这个接口的IP作为Router-ID
- COST（开销）
  - **OSPF协议选择最佳路径的标准是带宽，带宽越高计算出来的开销越低。到达目标网络的各个链路累计开销最低的，就是最佳路径。**
    - RIP是以跳数最少作为最佳路径的。这是RIP与OSPF的一个区别
- 链路（Link）
  - 就是路由器上的接口，在这里，应该指运行在OSPF进程下的接口。
- 链路状态（Link-State）
  - 链路状态（LSA）就是OSPF接口上的描述信息，例如接口上的IP地址，子网掩码，网络类型，Cost值等等，OSPF路由器之间交换的并不是路由表，而是链路状态（LSA）。
- 邻居（Neighbor）
  - OSPF只有邻接状态才会交换LSA。

#### OSPF工作过程

![image-20201220215049879](https://i.loli.net/2020/12/20/xngufyRmoDlM3S2.png)

#### OSPF的5种报文

- 类型1，问候（Hello）数据包，发现并建立邻接关系。
  - 用来发现邻居关系的。
- 类型2，数据库描述（Database Description）数据包，向邻居给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
  - 摘要信息即本路由器自己链路数据里有哪些路由器，告诉邻居这些路由器的routerID
- 类型3，链路状态请求（Link State Request，LSR）数据包，向对方请求某些链路状态项目的完整信息。
  - 邻居收到摘要了，一看摘要里的名单，你链路数据库里的某个路由器，邻居他那儿没有。邻居向你请求完整信息。
- 类型4，链路状态更新（Link State Update，LSU）数据包，用洪泛法对全网更新链路状态。这种数据包是最复杂的，也是OSPF协议最核心的部分。路由器使用这种数据包将其链路状态通知给相邻路由器。在OSPF中，只有LSU需要显示确认。
- 类型5，链路状态确认（Link State Acknowledgement，LSAck）数据包，对LSU做确认。

#### OSPF支持多区域

比RIP更适合大规模。但是也不能太大规模。

所以必须得划分区域。交换链路状态这个路由器范围，可以控制在一个局部区域。

自制系统AS：

这一整个区域归一个运营商或者一个单位来维护。

![image-20201220221628292](https://i.loli.net/2020/12/20/4O8pTBdJbesXEjV.png)

- **动态路由OSPF协议的区域划分和区域邻居路由通告**与**静态路由的物理连续规划和路由汇总**是一致的。或者说思路一样。
- 稍有区别的是所有区域必须跟主干区域直接相连。不能子区域连普通区域再连主干区域。
- 即这种区域划分只有两层，主干区域和普通区域，主干区域跟普通区域必须直接相连。

#### OSPF实验

![image-20201220173521924](https://i.loli.net/2020/12/20/5hQTrCexUm2fsny.png)

- 举例，怎么让R1路由器使用OSPF协议。需要把它直接相连的3个网段都network上（即这3个直连网段，都参与OSPF的共享邻居路由）。
  - R1(config)#router ospf 1
    R1(config-router)#network 192.168.0.0 0.0.0.255 area 0 //mask要01颠倒着写
    R1(config-router)#network 192.168.1.0 0.0.0.255 area 0
    R1(config-router)#network 192.168.4.0 0.0.0.255 area 0
  - 其他路由器也添加到area0。那么这5个路由器就算是同一个区域自治。
- 查看R1的邻居表
  - ![image-20201221111722544](https://i.loli.net/2020/12/21/GiJda6rxFWcKzVQ.png)
    - 这是routerID。之前说过，每个路由器都有个唯一的routerID，比如R2路由器，它有两个端口，s2/1:192.168.1.2，s2/0:192.168.2.1。以IP大的这个端口的IP作为该路由器的routerID。所以R2的routerID是192.168.2.1。R4路由器同理
    - 所以这两个邻居就是R2和R4
- 查看R1上的链路数据库
  - ![image-20201221112046158](https://i.loli.net/2020/12/21/zTCPO3ZgdhGoQDs.png)
    - 可以看到，R1到R5，5个路由器都在这个数据库中。OSPF自动学到的。
- 查看R1上的路由表
  - 网络中一共7个网段
  - ![image-20201220223231987](https://i.loli.net/2020/12/20/YI56aWZXk3eAyNl.png)
  - 直连的三个网段，即C字母标识的。 192.168.0.0/24、192.168.1.0/24、192.168.4.0/24三个网段
  - 还有四个学到的网段，即O字母标识的代表OSPF学到的。192.168.5.0/24、192.168.6.0/24、192.168.2.0/24、192.168.3.0/24四个网段，也知道怎么去了。
  - 所有网段都知道怎么去了，完全无需手动添加静态路由。
- 

### 5.14路由器上可以同时支持RIP协议和OSPF协议，还可以再添加静态路由

- 路由器上可以同时支持RIP协议和OSPF协议，各自学各自的。路由器有个同量级的权衡，来选择哪个协议学到的路径更好。
- 甚至还可以添加静态路由。静态路由的优先级最高，因为静态路由是人指定的。如果有管理员指定的静态路由去哪个网段怎么走，那任何一个动态协议学到的去那个网段怎么走通通作废。以静态路由为准。

### 5.15总结

- 网络层的功能
  - 负责为每一个数据包单独的选择转发路径。不负责可靠传输，也不负责按顺序到达
    - 发的时候肯定是按顺序发的，但是路由器转发的时候，有的数据包走那一个路径，有的数据包走另一个路径，不一定谁先到达呢。所以先发的可不一定先到，因为不同数据包路径可能不一样，路由器是为每一个数据包单独的选择转发路径。
    - **路由器直接丢弃传输过程中出错的数据包。**
    - **如果网络中待发的数据包太多，路由器处理不了就直接丢弃。**
    - 路由器不知道怎么转发该数据包时，也直接丢弃，并反馈一个ICMP信息。
  
- 网络畅通的条件
  - 数据包有去有回，这个网就通了
    - 有去很好理解，就是发送的内容能送达
    - 有回是指，目标主机收到了，回复一个信号给发送端说收到了
  - 那很简单，网络不通的原因就俩。一个是不能去，一个是不能回。
  
- 静态路由
  - 与路由器直接相连的网段，它都知道
  - 在路由器上设置，到某一个与它不直接相连的网段，下一跳发给谁（发给与自己相接的网段的哪个IP地址）
  
- 路由汇总

  - 一条一条添加静态路由太累了。许多个可以类似子网合并或者超网合并的IP段，可以汇总成一条。

- 默认路由

  - ```
    ip route 172.16.1.0 255.255.255.0 10.0.0.1
    ip route 172.16.0.0 255.255.0.0 10.0.0.2
    ip route 172.0.0.0 255.0.0.0 10.0.0.3
    ip route 0.0.0.0 0.0.0.0 10.0.0.4    默认路由
    ```

  - 过来一个数据包，看它要前往的地址是哪。路由器从路由表中子网掩码最长的开始一条一条比较。如果路由表中没有匹配的，那么都发往默认路由。

  - 与路由器直连的网段优先级是最高的。虽然不在手动添加的路由表里。**即假如路由器收到一个包，要发往某个地址，刚好就在它直连的网段里，那一定会转发到直连网段（直连网段也在路由表里）上，而不会发给默认路由**

- 让默认路由代替大多数网段的路由

  - 即没必要在路由器上一条一条地添加到某个网段怎么走。能用默认路由简化就简化。反正都是发往某个路由端口。

- **以上都是静态路由**，不管是路由汇总、默认路由，都是管理员通过ip route来添加路由表，告诉路由器到某一个网段下一跳发给谁。

  - 静态路由的缺点：
    - 它不会跟着网络的变化而自动变化，
    - 并且仅适合于规模比较小的网络。

- **以下都是动态路由**

- 动态路由协议：RIP协议（它属于网络层协议）

  - 把每个路由器的每个直连网段，都network上（每个路由器直连网段都参与到RIP协议中）。并且每个路由器都使用RIP协议。
  - 这样的话，路由器上不需要添加任何静态路由即（ip route ...）。网络中各路由器自动地就知道往各个网段的最佳路径了。
    - 原理在于，每个路由器每隔30秒就送出自己完整的路由表到其相连路由器，告诉相连路由器，它知道往哪个网段怎么走。
    - RIP协议的最佳标准是，**跳数最少的路径优先。**
    - 最大跳数15，16跳就认为不可到达
  - RIP协议是周期性更新，每30秒不管网络状态有没有变化，那都得更新一次。
    - OSPF是触发更新，平时用hello包维持邻居关系。一旦联系不上邻居了，链路状态才更新。
  
- 动态路由协议：OSPF协议

  - 把每个路由器的每个直连网段，都network上（每个路由器直连网段都参与到OSPF协议中）。并且每个路由器都使用OSPF协议。
  - 这样的话，路由器上不需要添加任何静态路由即（ip route ...）。网络中各路由器自动地就知道往各个网段的最佳路径了。
    - 原理在于每个路由器有3张表
      - **邻居表**。通过hello包实现。
      - 所有路由器交换链路数据信息（即邻居信息）后。所有路由器都有了这个表叫**链路状态数据库**。
      - 然后每个路由器自己算，构造出自己的**路由表**。该路由表知道到所有网络的距离以及下一跳路由器，但不知道全网拓扑（只有到了下一跳路由器，才能知道再下一跳应当怎么走）
    - OSPF协议的最佳标准是**带宽，带宽越高计算出来的开销越低**。**到达目标网络的各个链路累计开销最低的，就是最佳路径。**

- RIP与OSPF的重要区别

  - RIP认为跳数最少的路径最优。OSPF认为带宽最高的链路最优
  - RIP是周期性更新，每30秒更新一次。OSPF是触发更新，当联系不上邻居时，才更新。
  - RIP仅适合小网络。OSPF比RIP更适合稍大规模的网络。但是OSPF也不能过大，因此OSPF还支持区域自治特性。
    - OSPF由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因此与整个互联网规模并无直接关系。所以OSPF比RIP支持更大规模的网络
  - RIP有个好消息传得快，坏消息传的慢的特性。OSPF没有坏消息传的慢的问题。
  - 不过他们都有健壮性。当最佳路径断开时，会启用其他备用路径。

- 路由器可以同时支持RIP协议和OSPF协议。路由器会有个同量级的权重，来判断这俩协议学到的路径，哪个更好。同时，路由器还可以再手动添加静态路由。静态路由的优先级最高。一旦到某个网段被人为指定了静态路由，那么动态学到的路径全部作废。

## 6.网络层协议

协议就是规定怎么往首部加字段的。

### 6.1网络层协议本章重点

![image-20201221163749803](https://i.loli.net/2020/12/21/C4E3cFVaQyhbZvS.png)

本章重点讲网络层四个协议

- ARP协议
  - 它为IP协议提供服务
- IP协议
  - 它为ICMP和IGMP协议提供服务
  - IP协议其实是个统称，所有的动态路由协议都称为IP协议。比如RIP、OSPF都属于IP协议
- ICMP协议
- IGMP协议
- 虽然4个同是网络层协议，但是4个之间也有层次关系，谁为谁提供服务

### 6.2网络层首部概要

- IP数据包首部的格式能够说明IP协议都具有什么功能。 
- IP数据包由首部和数据两部分组成。
  - 网络层首部的前一部分是固定长度，共20个字节，是所有IP数据包必须有的。在首部的固定部分的后面是一些可选字段，其长度是可变的。
  - 因此网络层首部不一定有多长。至少20字节，也可能比20多。

![image-20201221170335495](https://i.loli.net/2020/12/21/v82pk6S3tGaUTVB.png)

![image-20201221170148320](https://i.loli.net/2020/12/21/AuNDXEYZMeTw8W6.png)

### 6.3网络层首部详解

#### 版本（4bit）和首部长度(4bit)

- 版本（4bit）

  - 0110
    - 即IPv6

  - 0100
    - 即IPv4
  - ![image-20201221173658425](https://i.loli.net/2020/12/21/4iM9gBdTNp1tFQG.png)

- 首部长度(4bit)

  - 首部长度肯定是大于等于20字节的
  - 例子1：刚好是20字节。
    - 0101=5，不是5字节的意思。是5个32bit的意思，即`5*32bit=5*4byte=20byte`
    - ![image-20201221173828862](https://i.loli.net/2020/12/21/nqbkfAWQ6UXNHZa.png)
  - 例子2：大于20字节
    - 假如是1111=15，那就是`15*32bit=15*4byte=60byte`
    - 这意思是除了固定部分20字节，可变部分还占了40字节，所以一共60字节
  - 因为标识首部长度只有4个bit，所以网络层首部长度的范围是 `（0~15）*32bit=（0~15）*4byte=20字节~60字节`
  - 首部长度 占4位，可表示的最大十进制数值是15。请注意，这个字段所表示数的单位是32位二进制数（即4个字节），因此，当IP的首部长度为1111时（即十进制的15），首部长度就达到60字节。 

#### 区分服务（8bit）

- 区分服务　占8位**，配置计算机给特定应用程序的数据包添加一个标志，然后再配置网络中的路由器优先转发这些带标志的数据包**，在网络带宽比较紧张的情况下，也能确保这种应用的带宽有保障，这就是区分服务，为这种服务确保服务质量（Quality of Service，QoS）。
  - 简言之，目的是让某些包带上标记，优先传输
  - 区分服务是一个0~63的数。即虽然一共8位，仅6位有用。剩下的2位有别的用途。
- 1.配置计算机（电脑发包时，给包带上一个区分服务标记）
  - 给特定应用程序的数据包添加一个标志
  - 在windows的组策略里添加（gpedit.msc）
    - 添加一个任何应用程序访问网页时，即TCP80端口，都加上QoS标记区分服务，标记成8
    - ![image-20201221180717981](https://i.loli.net/2020/12/21/fvOS8mcwdp7th1K.png)
    - 可以看到，现在计算机发出去的TCP80的包，有这个QoS区分服务了，是8
    - ![image-20201221180813783](https://i.loli.net/2020/12/21/w6pay4fnOE8iVg2.png)
    - 抓包可以看到，真的变成了8
  - 当没有添加组策略时，默认是0
    - ![image-20201221180945212](https://i.loli.net/2020/12/21/FDn1NBb3rshE7AS.png)
- 2.配置网络中的路由器（路由器看到哪些区分服务标记时，优先转发）
  - 让路由器优先转发这些带标志的数据包
  - 你windows发送的时候，添加上标记了，路由器上也得配置上这样的规则才行。
    - 路由器不配置的话，白搭。因为你需要的是，路由器看见这个标志的时候，优先转发。

#### 总长度（16bit）

- 用来指明网络层首部加上数据部分，一共有多少字节
- 也就是说网络层首部加上数据部分总长度最大是2^16-1=65535 字节
  - 但是我们都知道，数据链路层以太网MTU是1500字节。
  - ![image-20201221194647142](https://i.loli.net/2020/12/21/ZhWpYiBnCUE7FDL.png)
  - 所以网络层到数据链路层的时候，可能还会进行分片，把这种大的比如65535字节的IP数据报分片，然后每片各自重新加上IP首部。然后数据链路层才对每片IP数据报进行数据链路层封装传输。
    - **那么你分片了，我以后怎么知道这些片是同一个IP数据报分片分出来的，还是多个iP数据报呢？**这就得**靠IP首部的8bit标识**（下一节）了。
      - 比如一个IP数据报太大了，4000多字节，被分成了3片。那么这3片的标识都是一样的。标识一样就代表是同一个IP数据报分片分出来的。
    - 再一个，**现在知道这3片属于同一个IP数据报了。它们3个顺序是怎样的呢？**
      - 这就得**靠3bit的标志和13位的片位移**了。
  - ![image-20201221195413893](https://i.loli.net/2020/12/21/SHoJWtEikq5fyND.png)
    - 总长度1464byte，头部20byte。所以传输层给网络层的数据部分占1444byte
  - 另外有一点注意啊
    - 虽然IP数据报最大支持65535Byte。但是很少这么干。因为你一旦是超过1500Byte，还得让数据链路层给你分片再传输，白白增加数据链路层工作量。
    - 因此，不如你产生IP数据报的时候，就控制在1500byte以内。省的数据链路层再替网络层擦屁股，也就是最好不让数据链路层进行分片工作。

#### 标识（16bit）

这个“标识”并不是序号，类似于一种ID的意思。

数据报被分片了，我以后怎么知道这些片是同一个IP数据报分片分出来的，还是多个iP数据报呢？

- 当数据报由于超过网络的MTU而必须分片时，这个标识字段的值就被复制到所有的数据报片的标识字段中。
- 相同的标识字段的值使分片后的各数据报片最后能正确地重装成为原来的数据报
- 比如一个IP数据报太大了，4000多字节，被分成了3片。那么这3片的标识都是一样的。标识一样就代表是同一个IP数据报分片分出来的。
- ![image-20201221200946864](https://i.loli.net/2020/12/21/2wKDJ6B5vitxoVP.png)

#### 标志（3bit）

- 只有后两bit有意义
  - DF：0代表允许数据链路层对IP数据报分片。1代表不允许分片
    - 如果你想发的IP数据报大于1500byte，你又不允许分片，这样的包会报错，不会进行传输。
  - MF：0代表后边没片了（即它是最后一片）。1代表后边还有片（它不是最后一片）。
- 比如一个IP数据报太大了，4000多字节，会被分成3片
  - `ping 127.0.0.1 -l 4000`
- 这三个就是分片的数据报
  - <img src="https://i.loli.net/2020/12/21/3p4shRngVOY1lSE.png" alt="image-20201221201748018" style="zoom:200%;" />
  - 第1片
    - ![image-20201221202052034](https://i.loli.net/2020/12/21/tn1sj736chG24xo.png)
  - 第2片
    - ![image-20201221202236880](https://i.loli.net/2020/12/21/ZR5wXiOFJLCKNoA.png)
  - 第3片
    - ![image-20201221202411608](https://i.loli.net/2020/12/21/zf1B5N4pQTihOl8.png)
- 特别注意：
  - **你又想发超过1500byte的包，比如4000byte。**
    - `ping lab1102.tk -l 4000`
  - **你又不允许它分片，即把DF设置成了1。**
    - 在ping命令里就是-f选项就可以
      - ![image-20201221203029227](https://i.loli.net/2020/12/21/AFY5rl9NbpRQGCj.png)
  - 即，你输入了`ping lab1102.tk -l 4000 -f`
    - ![image-20201221203228886](https://i.loli.net/2020/12/21/u7vUYCfipslJwhm.png)
    - **这显然是个非常大的矛盾。数据报根本就不发送，网络层直接矛盾，不进行传输并报错。**

#### 片偏移（13bit）

- 数据链路层把大的IP数据报拆分成多个片。
- 各个片的顺序，就是使用片偏移来确定的。
- 片偏移指出：较长的分组在分片后，某片在原分组中的相对位置。也就是说，相对于用户数据字段的起点，该片从何处开始。片偏移以8个字节为偏移单位。这就是说，**每个分片的长度一定是8字节（64位）的整数倍。**
- ![image-20201221203915230](https://i.loli.net/2020/12/21/iNUuZFBpVK29kWb.png)
  - ![image-20201221204002497](https://i.loli.net/2020/12/21/g6cUT1MfizkChmr.png)
  - 标识一样，就是同一个IP数据报的分片。根据片偏移来判断分片的顺序。
- 实例
  - `ping lab1102.tk -l 4000`
  - 4000byte肯定被分成3片。
    - ![image-20201221204316328](https://i.loli.net/2020/12/21/ueS4Ofi6EJ7NmaX.png)
  - 第一片
    - ![image-20201221204344568](https://i.loli.net/2020/12/21/zYQdVX7cFuy14DO.png)
    - 意思是第一片的第一个数据，是整个数据报的第0byte。一共不是4000byte嘛。
  - 第二片
    - ![image-20201221204419601](https://i.loli.net/2020/12/21/gp8x5CYZoVn2l7u.png)
    - 其实片偏移是185。这个1480是软件反算出来的，即`185*8=1480byte`。意思是第二片的第一个数据，是整个数据报的第1480byte。一共不是4000byte嘛。
  - 第三片
    - ![image-20201221204624924](https://i.loli.net/2020/12/21/aP5yKfBspGZITbX.png)
    - 其实片偏移是370.这个2960是软件反算出来的，即`370*8=2960byte`。意思是第三片的第一个数据，是整个数据报的第2960byte。一共不是4000byte嘛。
  - 1500-20+1500-20+1068-20=4008byte。
  - 第一片总长 - 第一片首部 + 第二片总长 - 第二片首部 + 第三片总长 - 第三片首部=总原传输层数据部分
    - 比4000byte多了8byte，不知道是什么

#### 生存时间（8bit）

- 代表这个数据包能够在网络中经过多少个路由器。
- 路由器每转发一个数据报，就把里边的TTL值减1。
- 一个路由器在转发数据包之前将该数据包的TTL减1，如果减1后TTL变为0，路由器就会丢弃该数据包，然后产生一个ICMP响应数据包给发送者，说明TTL耗尽。通过这种方式，你能够知道到达目标地址经过哪些路由器。
- TTL（Time To Live）
  - windows默认发出时是128
  - linux默认发出时是64
- ![image-20201221214736084](https://i.loli.net/2020/12/21/O8bLjzxVkpnyCBJ.png)
- 实例1
  - ping 虚拟机win7。从win7返回来的包TTL还剩128。
  - 因为这是交换机直连，没有过路由器，还是128。从返回来剩128就可以判定，192.168.80.130，是台windows
  - ![image-20201221210831902](https://i.loli.net/2020/12/21/KifYw4BElsoLaQy.png)
- 实例2
  - ping 虚拟机ubuntu。返回来的包还剩64。
  - 因为这是交换机直连，没有过路由器，还是64。从返回来剩64就可以判断， 192.168.80.131是台ubuntu
  - ![image-20201221211102049](https://i.loli.net/2020/12/21/6bsmUFWgCTGqSly.png)
- 实例3
  - ping 百度。百度发给我的包还剩49，从49就可以大概判断，百度服务器是台linux。并且从百度到我的电脑，经过了64-49=15台路由器。
  - 右边mtr显示的是16比15多了1，因为mtr显示的是我给百度发消息时，经过了多少路由器，它把目标主机即百度服务器也算了一次，不只是算路由器。
  - ![image-20201221212016304](https://i.loli.net/2020/12/21/aHTzSYrc7emgfG3.png)
- 实例4
  - ping 林运检
  - ![image-20201221213303383](https://i.loli.net/2020/12/21/rGUZTBSXIPyJkhR.png)
  - 可以看到，本机和林运检PC机是交换机直连的，没有经过路由器，TTL还是128。并且可以判断林运检是windows系统。
- **注意啊，ping里的TTL显示的是，对方给我发了个消息，中间途径了很多路由器后，还剩多少TTL。不是我发给对方的时候的值，而是对方回复给我的时候的值。所以可以从这个TTL判断的是对方主机是什么系统。**
- ![image-20201221214911658](https://i.loli.net/2020/12/21/z5Hpnjuq3gvEKar.png)

#### 协议（8bit）

- 协议字段指出此数据包携带的数据是使用何种协议，以便使目的主机的网络层知道应将数据部分上交给哪个处理过程。
  - 用来标明传输层给网络层的数据部分是什么协议，是TCP还是UDP （这俩是运输层协议），还是ICMP（它其实是网络层）
  - 也就是网络层的上一层（一般就是指运输层）是什么协议
- ![image-20201221221321882](https://i.loli.net/2020/12/21/voxZTGMr9LVXg6B.png)
  - 网络层的ICMP和IGMP。没问题，因为IP协议可以为它俩服务，也算IP协议的上层。
  - IP。这个就比较特别了，因为这个协议是指IP协议的上层用的什么协议，为什么这里还可以是IP协议呢？其实这个IP表示的是特殊的IP数据报，IP数据报再封装到IP数据报。
  - 运输层的TCP UDP。没问题，运输层是网络层的上层。
- ![image-20201221221938019](https://i.loli.net/2020/12/21/xjkrXlO3hnD5HNq.png)
- ![image-20201221221806052](https://i.loli.net/2020/12/21/JrBwFvCZXpOEYbm.png)
- ![image-20201221222038068](https://i.loli.net/2020/12/21/2mJrwEUpCPR4qsk.png)

#### 首部校验和（16bit）

- 这个字段只检验数据报的首部，但不包括数据部分。
- 这是因为数据报每经过一个路由器，路由器都要重新计算一下首部检验和（一些字段，如生存时间、标志、片偏移等都可能发生变化）。不检验数据部分可减少计算的工作量。
- 用来校验IP数据报的首部在传输过程中有没有错误。（类似于数据链路层的差错检验CRC检验码，但是比CRC简单的多）
- ![image-20201221222416616](https://i.loli.net/2020/12/21/Vxda5pec7DNMPfX.png)

#### 源IP地址（32bit）

![image-20201221222905490](https://i.loli.net/2020/12/21/h3IHw5opTyxnOgk.png)

#### 目标IP地址（32bit）

![image-20201221222802576](https://i.loli.net/2020/12/21/zxH9cpgCMD8rtjO.png)

### 6.4网络层协议-ICMP协议

#### 6.4.1 ICMP协议-Internet控制报文协议简介

- ICMP协议是TCP/IP协议栈中的网络层的一个协议，**ICMP**是（Internet Control Message Protocol）**Internet控制报文协议**，用于在IP主机、路由器之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。
  - 也就是用来测试网络通还是不通的
  - 包括具体的数据报类型有：**ICMP请求、ICMP响应、ICMP差错报告**
  - 所以ICMP可以报告通还是不通，还可以报告出现了什么差错
- ICMP报文是在IP数据报内部被传输的，它封装在IP数据报内。ICMP报文通常被IP层或更层协议（TCP或UDP）使用。一些ICMP报文把差错报文返回给用户进程。
- ICMP依赖于网络层的IP协议。ICMP想传输，得在前边加上网络层首部
- ![image-20201222155942462](https://i.loli.net/2020/12/22/68ufxhanRm45yCp.png)
- ![image-20201222160051299](https://i.loli.net/2020/12/22/9sX6ecpRMuJGHnk.png)

#### 6.4.2类型（8bit）和代码（8bit）

**类型和代码**共同**决定了**这个ICMP数据报是**ICMP请求**还是**ICMP响应**还是**ICMP差错报告**。

![image-20201222160351091](https://i.loli.net/2020/12/22/av6Mo4GFOURH52b.png)



- **ICMP请求数据报和ICMP响应数据报**
  - ![image-20201222155306049](https://i.loli.net/2020/12/22/YiXxKlu26p3FkfR.png)
  - 上边是**ICMP请求数据报**。从我的主机115.156.215.180  ping  百度主机 182.61.200.6
    - ![image-20201222160718040](https://i.loli.net/2020/12/22/P4c5lKkwoAzQyxm.png)
    - 类型是8，代码是0，表明这个ICMP数据报是个**ICMP请求数据报**。
      - 即我的主机发送ICMP请求数据报给百度。
  - 下边是**ICMP响应数据报**。从百度主机182.61.200.6  响应 我的主机115.156.215.180
    - ![image-20201222160741984](https://i.loli.net/2020/12/22/2od6C71WLtepbkZ.png)
    - 类型是0，代码是0，表明这个ICMP数据报是个**ICMP响应数据报**。
      - 即百度发一个ICMP响应数据报给我的主机
- **ICMP差错报告数据报**
  - ![image-20201222214305976](https://i.loli.net/2020/12/22/NL4e3AvfyXWE6KR.png)

#### 6.4.3ICMP差错报告数据报报文

##### 五大类12小细类

- 终点不可到达 
  - 当路由器或主机没有到达目标地址的路由时，就丢弃该数据包，给源点发送终点不可到达报文。
- 源点抑制  
  - 当路由器或主机由于拥塞而丢弃数据包时，就会向源点发送源点抑制报文，使源点知道应当降低数据包的发送速率。
- 时间超时 
  -  当路由器收到生存时间为零的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把己收到的数据报片都丢弃，并向源点发送时间超过报文。
- 参数问题  
  - 当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。
- 改变路由（重定向）
  -  路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由）。
- 5大类，可细分为12细类。
  - ![image-20201222211912238](https://i.loli.net/2020/12/22/IAyJQReKuDO3TCi.png)

##### TTL过期（耗尽）

- `PS C:\Users\admin> ping www.baidu.com -i 1`
- ![image-20201222203221192](https://i.loli.net/2020/12/22/8Vx5KpdkGoMqTDA.png)
- 从路由器115.156.215.254返回给我本机一个ICMP差错报告报文。
  - ![image-20201222205712093](https://i.loli.net/2020/12/22/f5WMHCD7hsUdBXo.png)
  - 我本来在ping 百度，结果路由器115.156.215.254给我本机发了个ICMP包。ICMP包的首部type是11，code是0。我就知道了，是传输期间生成时间（TTL）为0了。
    - 其中出错的IP数据报，即本机发给百度的那个IP数据报。

##### 目标主机不可达

- 比如说，某个路由器上的路由表里，不知道目标网段怎么去，那就丢掉原IP包，并反馈一个ICMP差错数据报。说目标主机不可到达。
- <img src="https://i.loli.net/2020/12/22/jLT2XxMlJBZ7U45.png" alt="image-20201222211541252" style="zoom:200%;" />

##### 路由重定向

- 这个其实不算是错误，而是路由路径的优化。
- 这种ICMP数据报是路由器告诉计算机，你发的这个包，不应该发给我，发给我就绕弯了。你以后应该直接发给谁谁谁。

##### 给应用程序返回差错报告

- 除了ping命令可以产生差错。其他的应用程序也可能出现差错
- 那怎么通知给发送端，是哪个应用程序出现了问题，即ICMP给发送端的谁呢。给cmd.exe？还是给哪个应用程序
  - 这就需要最后的那8字节了。里边有sourece Port。这就代表了发送端的哪个应用程序。

![image-20201223141152005](https://i.loli.net/2020/12/23/v6uYnrXyiQAMslk.png)

### 6.5tracert和pathping

- Ping命令并不能跟踪从源地址到目标地址沿途经过了哪些路由器， Windows操作系统中的tracert命令是路由跟踪实用程序，用于确定IP数据报访问目标地址路径，能够帮助我们发现到达目标网络到底是哪一条链路出现了故障。Tracert 命令就是ping命令的扩展，用 IP报文生存时间 （TTL）字段和 ICMP差错报告报文来确定沿途经过的路由器。
- Tracert工作原理如下图所示。
  - 即`ping www.baidu.com -i 1`
    - 到第一个路由器，第一个路由器就会给我返回一个ICMP差错报告。因为TTL耗尽了
  - `ping www.baidu.com -i 2`
    - 到第二个路由器，第二个路由器就会给我返回一个ICMP差错报告。因为TTL耗尽了
  - `ping www.baidu.com -i 3`
    - 到第三个路由器，第三个路由器就会给我返回一个ICMP差错报告。因为TTL耗尽了
  - ....一个一个的发送这种TTL只有 1,2,3....的包。
- tracert其实可以完全像上边这样一个一个地使用ping来代替。tracert就仅仅是自动地发送 -i 1   -i 2 ....而已
- ![image-20201223155925182](https://i.loli.net/2020/12/23/ipkXoYMr8QBmzE2.png)
- pathping
  - Pathping是一个基于TCP/IP的命令行工具，该命令不但可以跟踪数据包从源主机到目标主机所经过的路径，还可以统计计算机网络延时以及丢包率，帮助我们解决网络问题，跟踪数据包路径的原理和tracert命令一样。

### 6.6ARP协议

#### ARP简介--Address Resolution Protocol地址解析协议

- 以太网帧发送时需要封装上目标MAC和源MAC
  - **电脑只知道源MAC（就是自己的网卡），那么发数据时的目标MAC怎么知道的呢？**
  - TCP/IP协议里有一个arp协议，当A计算机ping B计算机时，A计算机会在网上发一个广播帧，**广播帧的目标MAC是全F，即FF-FF-FF-FF-FF-FF**，48位的1。这个广播就是用于解析对方的MAC地址的。解析到以后就会缓存到本机上。
    - 不论哪台计算机，一旦收到一个目标MAC地址是FFFFFFFFFF的以太网帧时，都应该视为是给自己的。应当接收并处理。
- ARP协议是为IP协议提供服务的
  - 因为需要ARP包去解析目标主机的MAC地址。
  - 你要是不知道目标主机的MAC地址，这没法发过去的。数据链路层必须需要这个信息
- **ARP协议的作用，将以太网中的计算机的IP地址解析成MAC地址。**
  - **点到点链路使用PPP协议，不需要ARP协议。**（因为点到点的链路，不需要知道目标MAC地址，发给谁就是谁）
- ![image-20201223175026537](https://i.loli.net/2020/12/23/dt2VYXJM8EoqbGx.png)
- ARP帧格式
  - ![image-20201223170837589](https://i.loli.net/2020/12/23/9YaJxiHDjfvzlon.png)

#### ARP举例

- ![image-20201223165945374](https://i.loli.net/2020/12/23/KWtvLTRzfVuZciO.png)
- 比如我ping林运检，发生了什么。我的ip是115.156.214.180。林运检IP是115.156.213.253。已知，我俩是交换机直连的。
- 这时候还只知道林运检的IP地址，不知道他的MAC地址
- 第一步
  - 杨亚东的PC机根据目标IP和自己的子网掩码一判断，目标主机跟我在同一网段，就不需要给网关了。直接给交换机上的所有主机发一个ARP广播，问，林运检（115.156.213.253）的MAC地址是多少
  - ![image-20201223171517672](https://i.loli.net/2020/12/23/eBGh9fFQR2l8wx5.png)
- 第二步
  - 所有交换机上的主机都收到了杨亚东发送的广播包。但是只有林运检的主机一看，这个ARP是询问它自己的。因此**林运检的主机给杨亚东主机发送了arp回复**。交换机上其他主机一看不是问自己的，那就不回复。
  - ![image-20201223172630008](https://i.loli.net/2020/12/23/pDe29PSI3BVantg.png)
- 第三步
  - 这时候杨亚东的主机收到arp回复了，知道林运检的MAC地址了。
  - 开始ICMP通信
  - ![image-20201223173843178](https://i.loli.net/2020/12/23/pivxJrLdfuSUYgM.png)

#### ARP欺骗

- ARP协议是建立在网络中各个主机互相信任的基础上的，计算机A发送ARP广播帧解析计算机C的MAC地址，同一个网段中的计算机都能够收到这个ARP请求消息，任何一个主机都可以给计算机A发送ARP应答消息，可以告诉计算机A一个错误的MAC地址，计算机A收到ARP应答报文时并不会检测该报文的真实性，就会将其记入本机ARP缓存，这就存在一个安全隐患--ARP欺骗。
- 网络执法官软件可以控制以太网中的计算机通信
  - ![image-20201223200535299](https://i.loli.net/2020/12/23/LnxQKHCl12k9NeE.png)
  - 比如计算机A想ping计算机C。那A就在局域网内发ARP广播，问计算机C（192.168.80.30）的MAC地址是多少。C收到广播了，肯定回复A计算机。正常情况下B计算机收到广播了，一看不是找自己的，那就不回复
    - 但是，ARP欺骗，就是计算机B收到广播了，一看A想问C的MAC地址。计算机B告诉计算机A了一个假的MAC地址。
    - 此时计算机A收到了C计算机回复了第一个MAC地址。没一会儿，又收到了一个号称是计算机C的MAC地址。计算机A以后来的为准。
    - 那么A跟C就通不了了。要是没有网络执法官来欺骗，是可以通的。网络执法官计算机B一欺骗，就不通了了。
  - 再比如不想让A访问internet，那就让A发ARP询问网关时，网络执法官告诉计算机A一个错误的网关MAC。

### 6.7IGMP协议

Internet 组管理协议称为IGMP协议（Internet Group Management Protocol），是因特网协议家族中的一个组播协议。**该协议运行在主机和组播路由器之间，IGMP协议是网络层协议**。

什么叫组管理。

每一个D类地址就标志一个多播组。

#### 什么是组播（多播）

要想搞明白IGMP协议的作用和用途，先要搞明白什么是组播通信，组播也称为多播。

- 点到点通信（服务器需要的带宽很高，不太好）
  - 比如说6台电脑同时访问流媒体服务器看视频
  - 流媒体服务器需要和每一台电脑建立连接，建立会话。
  - 对流媒体服务器的带宽要求非常高。并且对流媒体服务器性能也有要求。
  - ![image-20201223205659010](https://i.loli.net/2020/12/23/WwfmHruexhOApv9.png)
- 多播通信
  - 流媒体服务器只发一份视频。不再是给各个电脑都发一份了。
  - （比较像广播电台发收音机节目，我就发一份，谁愿意收谁收）
  - 你只发一份，让谁收呢。目标地址写谁呢？
    - 流媒体服务器发出的IP包，目标地址写多播地址。
    - **多播地址有点频道的意思**。**每个电脑的网卡IP都设置成这个多播IP**，就都可以接受这个多播IP的数据包了。
  - **流媒体服务器就像电视台，多播地址相当于不同的频道。流媒体服务器可以使用两个组播地址向网络中发送两个课程的视频。网络的中的计算机绑定哪个多播地址就能收到哪个视频课程。**
  - ![image-20201223205913107](https://i.loli.net/2020/12/23/EpesKb8T4PnCywV.png)

#### 广播与组播的区别

- **广播是局域网内，所有电脑都要收。**
- **组播是分组了，不是所有电脑都收，哪个电脑网卡绑了这个IP，哪个网卡就收。（其实不需要人手工修改网卡，比如在windows media player这个应用里设置一下，就可以捕获不同的多播IP包，不需要人工动网卡，软件会帮你处理）**

#### 组播IP地址（D类IP地址中的绝大部分都可以用作组播IP地址）

![image-20201223213522494](https://i.loli.net/2020/12/23/2xHfsIATtiuMS7N.png)

- D类IP地址
  - 网络地址的最高位是1110的地址为D类地址。D类地址第1部分的取值范围为224-239。即因此D类地址范围是224.0.0.0到239.255.255.255，是用于多播（也称为组播）的地址，**组播地址没有子网掩码。**
    - ![image.png](https://i.loli.net/2020/11/25/YFGfz2LQ4TaOq3A.png)
  - 我们就用每一个D类地址标志一个多播组。
  - **这种地址不能给计算机使用**，它没有子网掩码。**它只能用作数据包的目标地址**
  - 即，**多播地址只能用作目标地址，不能用作源地址**
- D类地址中有一些是不能随意使用的，因为有的地址己经被IANA指派为**永久组地址**了[RFC3330]。例如：
  - （即，**不是所有D类地址都可以被随意用来做多播地址，有一些被特殊指派了。**）
  - 224.0.0.0基地址（保留）
  - 224.0.0.1在本子网上的所有参加多播的主机和路由器
  - 224.0.0.2在本子网上的所有参加组播的路由器
  - 224.0.0.3未指派
  - 224.0.0.4 DVMRP路由器
  - …….
  - 224.0.1.0至238.255.255.255全球范围都可使用的组播地址
  - 239.0.0.0至239.255.255.255限制在一个组织的范围

#### 组播MAC地址

- 目标地址是组播IP地址的数据包到达以太网，就要使用组播MAC地址封装，组播MAC地址使用组播IP地址构造。
- 为了支持IP 组播，因特网号码指派管理局IANA已经**为 Ethernet的MAC地址保留了一个组播地址区间：01-00-5E-00-00-00 到 01-00-5E-7F-FF-FF**。如图所示，**组播MAC地址48位的MAC地址中的高25位是固定的**，还剩23位。为了映射一个IP 多播地址到MAC层的组播地址，IP多播地址的低23位可以直接映射为MAC层组播地址的低23位。即剩下的23位直接使用多播IP的后23位
  - ![image-20201223214818627](https://i.loli.net/2020/12/23/eJGB9cQM3fdatnl.png)
- 不同的组播的组播IP地址可能构造出相同的多播MAC地址
  - 比如组播IP地址224.128.64.32，如下图所示，使用上面的方法构造出的MAC地址为01-00-5E-00-40-20。
    - ![image-20201223215019543](https://i.loli.net/2020/12/23/vmwLso4EBqV7Xjd.png)
  - 组播IP地址224.0.64.32，如下图所示，使用上面的方法构造出的MAC地址也为01-00-5E-00-40-20。
    - ![image-20201223215032337](https://i.loli.net/2020/12/23/iTY4fr1Z5D6gGdL.png)
  - 不过这没有关系。对于俩节目，他们的多播IP不一样。MAC地址一样就一样呗。网络层可以区分。

#### 多播包传输使用的是UDP协议

- 记住，多播包，比如流媒体服务器给各个电脑发送的视频数据。是UDP协议
- IGMP是路由器用来管理多播包的，不是用来传输视频的。

#### 组播管理协议（IGMP）

- IGMP实现如下双向的功能：
  - 1.**主机通过IGMP通知路由器希望接收或离开某个特定组播组的信息。**
    - ![image-20201223222122486](https://i.loli.net/2020/12/23/EUWty9HuwSxf2ND.png)
    - 主机192.168.10.20通知路由器，它不再收看239.192.54.250频道了。
  - 2.**路由器通过IGMP周期性地查询局域网内的组播组成员是否处于活动状态，实现所连网段组成员关系的收集与维护。**
    - ![image-20201223222150913](https://i.loli.net/2020/12/23/iUkqJMyArXO3z27.png)
    - 路由器某个接口192.168.10.10询问，本网段中，是否还有收看239.192.24.97频道的用户。
- 换句话说，IGMP工作在路由器的接口，用来判断该路由器接口下的网段的计算机，都绑定了哪些多播地址。
  - 即IGMP是路由器发出的，判断每个接口网段下的计算机绑定了哪些多播地址，并记录在路由器上。
  - 查看某个路由器下，记录了哪些多播地址（记录在路由器上就说明有人在看这个频道，我需要上层路由器继续转发这些多播包）
    - ![image-20201223221009429](https://i.loli.net/2020/12/23/CVNX3YF75TnhB6K.png)
- ![image-20201223220117517](https://i.loli.net/2020/12/23/ZDY3WsdzPBX4N1C.png)

### 6.10总结

- 网络层首部

  - ![image-20201221170335495](https://i.loli.net/2020/12/21/v82pk6S3tGaUTVB.png)
- ICMP协议
  - 它是以IP协议为载体的。
    - ![image-20201222213800076](https://i.loli.net/2020/12/22/u8VcA5q1dDFzvKU.png)
  - ICMP报文格式
    - ![image-20201222155942462](https://i.loli.net/2020/12/22/68ufxhanRm45yCp.png)
  - ICMP共有三种
    - 1.请求报文
    - 2.响应报文
    - 3.差错报告报文
      - 差错报告又分为5大类，12小类
    - ![image-20201222211912238](https://i.loli.net/2020/12/22/IAyJQReKuDO3TCi.png)
  - ICMP差错报告报文的格式
    - ![image-20201222214305976](https://i.loli.net/2020/12/22/NL4e3AvfyXWE6KR.png)
- ARP协议

  - 以太网帧发送时需要封装上目标MAC和源MAC
    - **电脑只知道源MAC（就是自己的网卡），那么发数据时的目标MAC怎么知道的呢？**
    - TCP/IP协议里有一个arp协议，当A计算机ping B计算机时，A计算机会在网上发一个广播帧，**广播帧的目标MAC是全F，即FF-FF-FF-FF-FF-FF**，48位的1。这个广播就是用于解析对方的MAC地址的。解析到以后就会缓存到本机上。
      - 不论哪台计算机，一旦收到一个目标MAC地址是FFFFFFFFFF的以太网帧时，都应该视为是给自己的。应当接收并处理。
  - ARP协议是为IP协议提供服务的
    - 因为需要ARP包去解析目标主机的MAC地址。
    - 你要是不知道目标主机的MAC地址，这没法发过去的。数据链路层必须需要这个信息
  - **ARP协议的作用，将以太网中的计算机的IP地址解析成MAC地址。**
    - **点到点链路使用PPP协议，不需要ARP协议。**（因为点到点的链路，不需要知道目标MAC地址，发给谁就是谁）
- IGMP协议

  - 广播域多播的区别
    - **广播是局域网内，所有电脑都要收。**
    - **组播是分组了，不是所有电脑都收，哪个电脑网卡绑了这个IP，哪个网卡就收。（其实不需要人手工修改网卡，比如在windows media player这个应用里设置一下，就可以捕获不同的多播IP包，不需要人工动网卡，软件会帮你处理）**
  - 组播IP地址（D类IP地址中的绝大部分都可以用作组播IP地址）
    - **D类地址范围是224.0.0.0到239.255.255.255**，是用于多播（也称为组播）的地址，**组播地址没有子网掩码。**
    - **这种地址不能给计算机使用**，它没有子网掩码。**它只能用作数据包的目标地址**
    - 即，**多播地址只能用作目标地址，不能用作源地址**
  - 组播MAC地址
    - ![image-20201223214818627](https://i.loli.net/2020/12/23/eJGB9cQM3fdatnl.png)
  - **记住，多播包，比如流媒体服务器给各个电脑发送的视频数据。是UDP协议**
  - **IGMP是路由器用来管理多播包的，是用来查询成员的。或者是主机用IGMP告诉路由器我不看这个频道了。但永远不是用来传输视频的。**
  - IGMP实现如下双向的功能：
    - 1.**主机通过IGMP通知路由器希望接收或离开某个特定组播组的信息。**
      - ![image-20201223222122486](https://i.loli.net/2020/12/23/EUWty9HuwSxf2ND.png)
      - 主机192.168.10.20通知路由器，它不再收看239.192.54.250频道了。
    - 2.**路由器通过IGMP周期性地查询局域网内的组播组成员是否处于活动状态，实现所连网段组成员关系的收集与维护。**
      - ![image-20201223222150913](https://i.loli.net/2020/12/23/iUkqJMyArXO3z27.png)
      - 路由器某个接口192.168.10.10询问，本网段中，是否还有收看239.192.24.97频道的用户。
  - 换句话说，IGMP工作在路由器的接口，用来判断该路由器接口下的网段的计算机，都绑定了哪些多播地址。
    - 即IGMP是路由器发出的，判断每个接口网段下的计算机绑定了哪些多播地址，并记录在路由器上。
    - 查看某个路由器下，记录了哪些多播地址（记录在路由器上就说明有人在看这个频道，我需要上层路由器继续转发这些多播包）
      - ![image-20201223221009429](https://i.loli.net/2020/12/23/CVNX3YF75TnhB6K.png)

## 7.传输层协议

- 应用程序要传输的内容，放在缓存，然后分段来传。
- 每一段加上网络层的首部，然后封装成数据报
- 然后根据不同的数据链路层，把数据报封装成不同的帧
- 路由器负责实现数据报的路由和转发。也就是说网络层负责把数据报传到目的地。
- 传输层负责可靠传输.
  - 也就是说，如果网络层传的时候把数据报搞丢了，传输层得能够知道，并且把丢了的数据报重新发送，保证能到客户端。
  - 并且传输层还得能感知网络的状态， 比如现在发10个包就丢几个包，那就应当降低发送速率。即传输层能自动感知网络堵塞，调节发送速率。
  - 传输层还能够根据客户端的接受能力，来调节发送速率
  - 通信之前，服务端和客户端的传输层要建立连接。通信完了，要释放连接。通信过程中要有流量控制和可靠传输。

### 7.1传输层两个协议的应用场景

##### 网络中的计算机通信无外乎有以下两种情况：

- 1.要发送的内容多，需要将发送的内容分成多个数据包发送。
  - **TCP（Transmission Control Protocol 即传输控制协议）**
  - **TCP保证可靠传输，中间丢包了，TCP自己就会重传，无需应用操心。**
  - 应用场景：
    - 下载电影
    - QQ传文件
- 2.要发送的内容少，一个数据包就能发送全部内容。
  - **UDP（User Datagram Protocol即用户数据报协议）**。
  - **UDP不管你收到收不到，就发一次，中间丢包了也不管。**（如果有没收到再发这种特性，那是应用决定的，不是UDP自主的，是应用又发了好几次UDP）
    - **换句话说，UDP不保证可靠传输。中间丢包没传过去，它不管，它就发一次。想使用UDP，还保证对方能收到，那得是应用在操心。**
  - 应用场景：
    - DNS解析域名
    - QQ发消息（这次聊完指不定下一条消息啥时候发呢，没必要像TCP那样建立连接，就发一次就行了，没成功的话再发一次，这是应用做的。UDP本身可不会管你收到收不到，UDP不重传）
    - QQ电话。（虽然一个包传不完，但是必须按顺序发，不允许迟到，丢了就丢了呗，有一句话没听见，它也没给你重传，也不需要丢了重传，因为这是实时应用。）

##### 再总结一次

- TCP
  - 应用场景：
    - 要传输的内容需要分成多个数据包来传输
  - 在传输层需要 分段、编号。
    - 接收端收到以后，还得按照编号组装成完整的内容。
  - 传输过程中有流量控制、拥塞避免、保证可靠传输的特性
  - 客户端和服务端通信前需要建立TCP连接
    - 建立连接即需要协商参数：是否支持选择性确认、两端支持的最大报文是多少
  - 通信结束了，需要释放连接
- UDP
  - 应用场景：
    - 1.要传输的内容一个数据包就完成了。（比如DNS域名解析）
    - 2.传输实时的语音和视频，因为这个需求实时性。中间丢几句话没听见，也不重传。要求实时。
    - 3.多播
  - 不需要分段，不需要流量控制
  - **传输成功与否，完全由应用层判断，UDP本身不保证可靠传输。**
  - 通信时，不需要建立连接。
    - 不建立连接，服务器就比较省心。不需要始终跟客户机保持连接。节省服务器资源。
- yyd备注：
  - 卡了一会儿，数据还是来了，数据是完整的，那应该是TCP。TCP适合完整性要求高的。
    - 在线看腾讯视频
  - 卡了一会儿，数据丢了一些，那应该是UDP。UDP适合要求实时的。
    - 微信电话

### 7.2传输层协议和应用层协议之间的关系

- 应用层协议很多，传输层就两个协议，**如何使用传输层两个协议标识应用层协议呢？**
  - 应用层协议比如说访问网站http协议；访问ftp文件服务器使用ftp协议；发电子邮件使用SMTP；收电子邮件使用POP3协议；域名解析使用DNS.....
  - 传输层就俩协议：TCP和UDP
- 传输层协议加一个端口号来标识一个应用层协议，展示了传输层协议和应用层协议之间的关系。
  - ![image-20201224155820937](https://i.loli.net/2020/12/24/VKZX7RJedlUBHAG.png)
  - 即默认端口。
    - HTTP默认使用TCP的80端口标识。访问网站
      - 比如说我的网站就不使用80端口，我使用81端口。那也可以，那么在输入网址时就需要指明端口。你不指明，默认还按80，那就访问不了。
    - HTTPS默认使用TCP的443端口。安全的http协议
    - FTP默认使用TCP的21端口标识。ftp文件传输
    - SMTP默认使用TCP的25端口标识。发电子邮件
    - POP3默认使用TCP的110端口。收电子邮件
    - TELNET默认使用TCP的23端口。
    - RDP默认使用TCP的3389端口。远程桌面
    - 微软SQL默认使用TCP的1433端口。微软的SQL服务。
    - mySQL默认使用TCP的3306端口。mySQL数据库
    - windows访问共享文件夹（共享资源）=TCP+445端口。
    - **DNS默认使用UDP+53端口（偶尔是TCP+53端口，绝大多数是UDP）。域名解析**

### 7.3服务和端口的关系

- Windows和Linux操作系统
  - 有些服务为本地计算机提供服务
    - **为本地计算机提供服务的服务**，它不需要和网络中计算机通信，所以也就不需要什么TCP和端口
    - 比如：磁盘管理服务，我把virtual disk这个服务停止了，磁盘管理就打不开了
      - ![image-20201224174038108](https://i.loli.net/2020/12/24/xj5HNMAioEnfBdk.png)
      - ![image-20201224173958708](https://i.loli.net/2020/12/24/FJithu8INe4GH2o.png)
    - 把服务再启动，就可以使用磁盘管理了
      - ![image-20201224174248325](https://i.loli.net/2020/12/24/InAOfHUP2B3gWLh.png)
  - 有些服务**为网络中的计算机提供服务。**
    - 这种服务需要使用TCP或者UDP的某个端口侦听客户端的请求
    - 比如说：windows的远程连接默认端口TCP:3389
      - 在win7下输入netstat -an查看本地侦听的端口
      - ![image-20201224175144996](https://i.loli.net/2020/12/24/NFRqjXie36VBPIn.png)
      - 用win10去远程连接win7后，可以看到建立的连接
        - 在win7下输入netstat -n查看建立的TCP连接
        - ![image-20201224175700083](https://i.loli.net/2020/12/24/eGs4iI6ohp8Vb9u.png)
- 即，为网络中计算机提供服务的**服务，一旦启动就会使用TCP或UDP的某个端口侦听客户端的请求。**
  - 刚才就是win7上启动了远程连接服务，那么就开放了0.0.0.0:3389进行侦听。

### 7.4使用telnet和端口扫描工具扫描远程服务器打开的端口

#### telnet

```
PS C:\Users\admin> telnet 192.168.80.130 80
正在连接192.168.80.130...无法打开到主机的连接。 在端口 80: 连接失败
PS C:\Users\admin>
```

#### 端口扫描（就可以判断出来目标主机开了哪些服务）

- 在win7上netstat -an查看在侦听哪些端口
  - ![image-20201224200534672](https://i.loli.net/2020/12/24/JTyidIvWNDGH8pB.png)
- 在win10上用nmap来扫描win7（192.168.80.130）开放了哪些端口
  - ![image-20201224200507555](https://i.loli.net/2020/12/24/AdS9OKPLaBqycMH.png)

### 7.5服务和端口的关系

- Windows和Linux操作系统
  - 有些服务为本地计算机提供服务
  - 有些服务为网络中的计算机提供服务。
- 为网络中计算机提供服务的服务，一旦启动就会使用TCP或UDP的某个端口侦听客户端的请求。
- 客户端通过IP地址定位服务器，通过协议和端口号定位服务器上的服务。
  - ![image-20201224202904276](https://i.loli.net/2020/12/24/2sTzQMXgklBtDEa.png)
- 客户端软件可以同时访问多个服务器，客户端会为每个出去的流量分配一个唯一的源端口。
  - ![image-20201224202922897](https://i.loli.net/2020/12/24/YX3ldJk6LzHhcjW.png)
- 服务器上的服务侦听的端口不能冲突，否则将会造成服务启动失败。
  - 也就是说俩服务，得用俩端口，不能用同一个
- 应用层协议也可以不使用默认端口和客户端通信。
  - 如果不使用默认端口通信，客户端需要指明使用的端口。

### 7.6端口和网络安全（封端口基本等于封服务）

#### 在个人电脑上设置防火墙（个人电脑防火墙，保护自己电脑安全；也可以控制不允许个人电脑访问互联网上哪些服务，比如不允许个人电脑访问网页）

- 客户端和服务器之间的通信使用应用层协议，**应用层协议使用传输层协议+端口标识**，如果在网络设备**封掉TCP或UDP的某个端口**，就不能访问其对应的服务，**就可以实现网络安全**。
- 设置服务器网络安全，只开放必要的端口。
- 在Windows上可以通过设置TCP/IP筛选和Windows防火墙来实现。
  - ![image-20201227144559335](https://i.loli.net/2020/12/27/Cy6R5oABY9mqTwH.png)

#### 企业在路由器上设置防火墙（路由防火墙，保护内网电脑安全；也可以控制不允许内网访问互联网上哪些服务，比如不允许内网电脑访问网页）

- 在路由器上设置防火墙，可以控制整个内网（即企业内部的所有电脑）它们可以访问互联网上哪些服务
- ![image-20201227145256553](https://i.loli.net/2020/12/27/hJvbpjVGC9y7Hkw.png)

### 7.7防火墙示例（防火墙就是看护电脑端口的）

- 可以控制允许哪些端口流量从外边进入电脑
- 也可以控制允许哪些端口流量从按钮发到外边

windows防火墙

- 只拦截进来的流量，出去的流量不拦截，并且出去的流量还允许再进入。
- 以远程桌面服务为例
  - 1.目标主机要开启服务，侦听3389端口。
    - ![image-20201227153603461](https://i.loli.net/2020/12/27/KAI6NCnEkzSFiPu.png)

- 2.目标主机防火墙要允许3389端口通信（或者直接关闭防火墙也行）
  - ![image-20201227153528403](https://i.loli.net/2020/12/27/3DoNbc4Aru2Hk8x.png)
- 这样才能访问服务器上的远程桌面服务。

### 7.8UDP协议（（User Datagram Protocol即用户数据报协议））

#### 7.8.1 UDP协议的特点

- 1.**UDP是无连接的**，即发送数据之前不需要建立连接（当然发送数据结束时也没有连接可释放），因此减少了开销和发送数据之前的时延。
  - **UDP**直接写上地址就扔出去，**不在乎**对方在不在线，准备好没准备好，网络堵不堵，扔出去以后会不会丢包。
  - 与之相反，TCP需要建立连接，三个数据包：请求建立连接、确认建立连接、再次确认建立连接。然后再通信。
- 2.UDP使用尽最大努力交付，即不保证可靠交付，因此**主机不需要维持复杂的连接状态表**（这里面有许多参数），通信的两端不用保持连接，因此节省系统资源。
  - 因为UDP是无连接，也就不需要维持连接状态
- 3.UDP是面向报文的，发送方的UDP对应用程序交下来的报文，在添加首部后就向下交付给网络层。**UDP对应用层交下来的报文，既不合并，也不拆分，而是保留这些报文的边界。**
  - ![image-20201227173733198](https://i.loli.net/2020/12/27/L1mt7YCbQHzRDTF.png)
- 4.UDP没有拥塞控制，因此网络出现的拥塞不会使源主机的发送速率降低。这对某些实时应用是很重要的。
- 5.UDP支持一对一、一对多、多对一和多对多的交互通信。 
  - 因为UDP不合接收端建立会话，发出去就不管了。
  - 比如一对多：流媒体服务器的多播数据流。
- 6.UDP的首部开销小，只有8个字节，比TCP的20个字节的首部要短。
  - 网络层的所有协议，首部都一样
  - 但是运输层不同，TCP和UDP的首部是不一样的

#### 7.8.2 UDP协议的首部

- UDP的首部包括四个字段，源端口、目标端口、长度、校验和，每个字段的长度是两个字节。
- 伪首部包括：源地址、目的地址、UDP数据长度、协议类型（0x11，即十进制的17），协议类型就一个字节，但需要补一个字节的0x0，构成12个字节。
- ![image-20201227200555073](https://i.loli.net/2020/12/27/US4RjHGQ79CVdJt.png)
  - ![image-20201227200248225](https://i.loli.net/2020/12/27/b7UfO4eTntqGp5d.png)
- 长度：
  - 是指 固定的8字节UDP首部+UDP用户数据报的数据部分的 总长度
- 伪首部：
  - 它只是在计算校验和时临时添加在头部的。
  - 伪首部既不向下传输，也不向上递交，仅仅是为了计算校验和
- 计算校验和
  - 1）构造伪首部。使用IP层的源ip地址、目标IP地址、0、17、UDP长度，来构造12字节的伪首部
  - 2）接上UDP首部。里边的校验和先默认成0
  - 3）接上UDP数据部分。若用户数据长度不是偶数字节，那得补一个全0字节
  - 4）按二进制反码求和，然后将得出的结果求反码
    - 二进制反码求和：0和0相加是0，但要产生一个进位1，0和1相加是1，1和1相加是0。若最高位相加后产生进位，则最后得到的结果要加1。
  - ![image-20201227202624669](https://i.loli.net/2020/12/27/NjW9e3s1hFwTgoV.png)
    - 当接收方收到UDP包时，首先再自行算出12字节的伪首部（伪首部不会进行传输），然后加上UDP首部（此时的检验和不再是全0了。收到的是什么就是什么），加上UDP数据部分。按二进制反码运算求和，得到的结果应是全1。否则就是传输出现错误了。
  - UDP里的校验和与IP数据报首部的校验和非常类似。与IP数据报首部的校验和差别仅在于，UDP首部的校验和是用伪首部、首部、数据部分一起来算的，而IP数据报的首部校验和仅仅是使用IP数据报的首部，不涉及内容部分。

### 7.9 TCP协议特点（（Transmission Control Protocol 即传输控制协议））

- 1.TCP是面向连接的传输层协议。这就是说，应用程序在使用TCP协议之前，必须先建立TCP连接。在传送数据完毕后，必须释放已经建立的TCP连接。这就是说，应用进程之间的通信好像在“打电话”：通话前要先拨号建立连接，通话结束后要挂机释放连接。
  - 第一次握手：客户端向服务器发送TCP连接请求。
    - 这个请求里带着一些客户端的参数，客户端最大支持的数据报多少字节、支不支持选择性确认、客户端缓存最多多少字节。
    - 服务器要根据客户端的这些参数，来选择发送速度
  - 第二次握手：服务器向客户端发送TCP确认
    - 告诉客户端，服务器通信的一些设置。比如告诉客户端，我这个web服务器的最大缓存多大、支不支持选择性确认，这是再跟客户端协商。
  - 第三次握手：客户端收到服务器发送的TCP确认，再回给服务器一次确认
    - 确认第二次握手协商的事情。
  - 经过这3个数据包，就建立了一个客户端跟服务器的TCP连接。这个连接一旦建立了，就可以实现双向通信。
    - 这3个TCP数据包，没有数据部分，纯粹的3个TCP首部。
  - 双向通信中......
  - 在传送数据完毕后，必须释放已经建立的TCP连接。
- 2.每一条TCP连接只能有两个端点（endpoint），每一条**TCP连接只能是点对点的**（一对一）。
  - 只能是点到点，不能是多播（组播）
- 3.**TCP提供可靠交付的服务**。也就是说，通**过TCP连接传送的数据，无差错、不丢失、不重复、且按序发送。**
  - **TCP提供可靠传输**
  - TCP会对应用层数据分段、加编号然后各自传输。
- 4.**TCP提供全双工通信**。TCP允许通信双方的应用进程在任何时候都能发送数据。TCP连接的两端都设有发送缓存和接收缓存，用来临时存放双向通信的数据。在发送时，应用程序把数据传送给TCP的缓存后，就可以做自己的事，而TCP在合适的时候把数据发送出去。在接收时，TCP把收到的数据放入缓存，上层的应用进程在合适的时候读取缓存中的数据。
- 5.**面向字节流**。TCP中的“流”（steam）指的是流入到进程或从进程流出的字节序列。
  - 面向字节流是指，TCP在传输层，它跟应用层之间的数据传递，就是字节流。
  - 发送端，应用程序按字节流传递给传输层TCP。
  - 接收端，TCP负责无差错、不丢失、不重复、且按序排列各个数据包，然后按字节流向上传递给应用层。
  - TCP把多少字节分为一段，是会 动态调整的。但绝不是由发送端的上层应用程序决定，因为应用程序给它的是字节流，多少字节分为一段，由传输层TCP自己决定。
  - ![image-20201227213548503](https://i.loli.net/2020/12/27/ISpvQdMnauz2ODl.png)

### 7.10 TCP报文首部字段

TCP协议是能够实现数据分段传输、可靠传输、流量控制、网络拥塞避免等功能，因此TCP报文的首部要比UDP报文首部字段要多，并且首部长度不固定。

![image-20201227214443450](https://i.loli.net/2020/12/27/R8tCnJaDYojrOzZ.png)

#### 源端口和目的端口

源端口和目的端口各占2个字节，分别写入源端口号和目的端口号。和前面图所示的UDP的分用相似，TCP的分用功能也是通过端口实现的。

#### 序号和确认号

- 序号占4字节。序号范围是[0，232-1]，共232（即4 294 967 296）个序号。序号增加到232-1后，下一个序号就又回到0。TCP是面向字节流的。在一个TCP连接中传送的字节流中的每一个字节都按顺序编号
  - 序号里的信息是，发送方给接收方发到第多少字节了。
- **确认号  占4字节，是期望收到对方下一个报文段的第一个数据字节的序号。**
  - 确认号里信息是，发送方提醒接收方，该给自己（发送方）发第多少字节了。
  - 因为是双工通信，所以信息是交互的，两边互传数据。两边都同时作为一个发送方的角色和一个接收方的角色。
  - **TCP协议能够实现可靠传输，接收方收到几个数据包后，就会给发送方一个确认数据包，告诉发送方下一个数据包该发第多少个字节了。**
  - **若确认号是N，则表明：到序号N-1为止的所有数据都已正确收到。**
- ![image-20201227215223615](https://i.loli.net/2020/12/27/VdNGumShC5eXH69.png)
  - 其实A给B发的数据包里有序号，也有确认号。序号是A给B发的数据，发到第几个字节了。确认号是，A提醒B，B你该给我发第多少字节了
  - B给A发的数据包里有序号，也有确认号。序号是B给A发的数据，发到第几个字节了。确认号是，B提醒A，A你该给我发第多少字节了

#### 数据偏移（4bit，可以理解为TCP报文段的首部长度）

- 数据偏移  占4位，它指出TCP报文段的数据起始处距离TCP报文段的起始处有多远。**这个字段实际上是指出TCP报文段的首部长度。因为TCP首部长度不是固定的，所以必须得指出有首部多长**。由于首部中还有长度不确定的选项字段，因此数据偏移字段是必要的。但请注意，“数据偏移”的单位为4字节，由于4位二进制数能够表示的最大十进制数字是15，即15个32位字，**因此数据偏移的最大值是60字节，这也是TCP首部的最大长度，这也就意味着选项长度不能超过40字节。**

#### 保留字段（6bit）

保留  占6位，保留为今后使用，但目前应置为0。

#### 标记位（6bit）

- URG：紧急URG（URGent） 
  - 当URG=l 时，表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快传送（相当于高优先级的数据），而不要按原来的排队顺序来传送。
    - 在发送端传输数据时，是按序放到缓存里的。应用程序如果突然要发一个非常重要的命令或者指令，那就设置一下URG，让它紧急先发，不要按序发了。
  - 针对发送端，让发送端赶紧发。
- ACK：确认ACK（ACKnowlegment） 
  - 仅当ACK=1时，确认号字段才有效。当ACK=0时，确认号无效。TCP规定，在连接建立后所有传送的报文段都必须把ACK置1。
    - 确认号是指上一行的那32bit的确认号
- PSH：推送PSH（PuSH）
  - 当两个应用进程进行交互式的通信时，有时在一端的应用进程希望在键入一个命令后立即就能够收到对方的响应。
    - 接收端接受数据时，也是按接受顺序从缓存读的。PSH设置为1，让接收端立马执行这个数据包里的命令。别再按序从缓存读了
  - 针对接收端，让接收端赶紧读。
- RST：复位RST（ReSeT） 
  - 当RST=l时，表明TCP连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接。
- SYN：同步SYN（SYNchronization） 
  - 在连接建立时用来同步序号。当SYN=1而ACK=0时，表明这是一个连接请求报文段。对方若同意建立连接，则应在响应的报文段中使SYN=1和ACK=1。因此，SYN置为1就表示这是一个连接请求或连接接受报文。
  - 三次握手的前两次，SYN是1。最后一次SYN是0
- FIN：终止FIN（FINish意思是“完”、“终”） 
  - 用来释放一个连接。当FIN=1时，表明此报文段的发送方的数据己发送完毕，并要求释放传输连接。

#### 窗口（16bit）

- 窗口值是[0，216-1]之间的整数。TCP协议有流量控制功能，窗口值告诉对方：从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量（单位是字节）。
- **窗口值是接收方告诉发送方的**东西，接收方缓存不行了，动态的调整窗口，告诉发送方，你还能给我发多少字节过来。
  - 窗口就是TCP可以动态调整发送速率的本质。

#### 校验和（16bit）

- 检验和字段检验的范围包括首部和数据这两部分。和UDP用户数据报一样，在计算检验和时，要在TCP报文段的前面加上12字节的伪首部。
- 计算方法与UDP完全一样，伪首部、首部、数据部分，一起计算校验和

#### 紧急指针（16bit）

- 紧急指针仅在URG=1时才有意义，它指出本报文段中的紧急数据的字节数（紧急数据结束后就是普通数据）。因此紧急指针指出了紧急数据的末尾在报文段中的位置。
- 例如：
  - 紧急指针的值是10
  - 那意思就是数据部分的前10字节是紧急数据。后边是普通数据
- 再例如
  - 紧急指针的值是100
  - 那意思就是数据部分的前100字节是紧急数据。后边是普通数据

#### 选项（长度可变，最少0字节，最多40字节）

选项 长度可变，最长可达40个字节。当没有使用选项时，TCP的首部长度是20字节。TCP最初只规定了一种选项，即最大报文段长度MSS（Maximum Segment Size）。

![image-20210109192255902](https://i.loli.net/2021/01/09/n7QM1EHwPhvSGbO.png)

### 7.11可靠传输的实现（详见纸质版笔记）

#### 7.11.1 停止等待协议 与 连续ARQ协议和滑动窗口协议

- 停止等待协议（现代计算机通信并不采用）
  - ![image-20201228165735032](https://i.loli.net/2020/12/28/v1qpwNhEmCdu95n.png)
  - ![image-20201228165742011](https://i.loli.net/2020/12/28/jCKIHGvMYXDUnWi.png)
- 连续ARQ协议和滑动窗口协议（也就是改进的停止等待协议）
  - ![image-20201228170326893](https://i.loli.net/2020/12/28/SOoGcaiXFhvJHrg.png)
  - 停止等待协议是发一个数据，就得等待确认
  - 连续ARQ是发一个窗口的数据，然后再等待确认
- B计算机发给A的确认数据包里，其实是会动态设置窗口值的。与B计算机缓存剩余容量有关。

#### 7.11.2 详解以字节为单位的滑动窗口技术

- 比如说应用程序要发的数据一共有1200byte，那就以字节流的形式，流到发送端的传输层缓存。
- 传输层自己决定，按每100byte进行分段，或者叫做分组，然后编上号。
  - ![image-20201228173911645](https://i.loli.net/2020/12/28/lQnTu46kYzWRvsx.png)
- 详细过程
- ![图片1](https://i.loli.net/2020/12/28/oODgnzPwGQBA4vh.png)

#### 7.11.3 选择性确认SACk

- 改进的确认（ACk）-选择确认（SACK）
  - 它在建立TCP连接时，会进行协商
- 这个SACk的主要作用是：**当一个窗口的数据传输，中间丢了几个包时。不需要把这个窗口都重新再传了，发送方只重新传丢的就行**
- TCP通信时，如果发送序列中间某个数据包丢失，TCP会通过重传最后确认的分组后续的分组，这样原先已经正确传输的分组也可能重复发送，降低了TCP性能。为改善这种情况，发展出**SACK（Selective Acknowledgment，选择确认）技术，使TCP只重新发送丢失的包，不用发送后续所有的分组，而且提供相应机制使接收方能告诉发送方哪些数据丢失，哪些数据已经提前收到**等。
- 由于TCP首部选项最长40个字节，而指明一个边界需要用掉4个字节（因为序号有32位，需要使用4个字节表示），因此在T**CP选项中一次最多只能指明4个字节块的边界信息**。这是因为4个字节块有8个边界，一个边界占用4个字节，占用32个字节，另外还需要2个字节，一个字节用来指明是SACK选项，另一个字节指明这个选项占多少字节。
  - 左右边界是指收到的部分。
  - ![image-20201228195416180](https://i.loli.net/2020/12/28/285WJmtsgeK6xpu.png)

#### 7.11.4 超时重传时间的调整

- TCP的发送方在规定的时间内没有收到确认就要重传己发送的报文段。这种重传的概念是很简单的，但重传时间的选择却是TCP最复杂的问题之一。
- 传输层的超时计时器的超时重传时间究竟应设置为多大呢？TCP往返传输时间（RTT） 的测量可以采用两种方法：
  - TCP Timestamp选项
    - TCP时间戳选项可以用来精确的测量RTT。发送方在发送报文段时把当前时钟的时间值放入时间戳字段，接收方在确认该报文段时把时间戳字段值复制到时间戳回送回答字段。因此，发送方在收到确认报文后，可以准确地计算出RTT来。RTT=当前时间-数据包中Timestamp选项的回显时间。 
      - 即在选项里加上当前时钟。
  - 重传队列中数据包的TCP控制块
    - 在TCP发送窗口中保存着发送而未被确认的数据包，数据包skb中的TCP控制块包含着一个变量， tcp_skb_cb—>when，记录了该数据包的第一次发送时间，当收到该数据包确认，就可以计算RTT，RTT=当前时间-when。这就意味着发送端收到一个确认，就能计算新的RTT。

### 7.12流量控制、拥塞控制（详见纸质版和秋招版笔记）

### 7.13三次握手与四次挥手（详见纸质版和秋招版笔记）

### 7.20总结

- 一、传输层两个协议的应用场景
  - TCP
    - 应用场景：
      - 要传输的内容需要分成多个数据包来传输
    - 在传输层需要 分段、编号。
      - 接收端收到以后，还得按照编号组装成完整的内容。
    - 传输过程中有流量控制、拥塞避免、保证可靠传输的特性
    - 客户端和服务端通信前需要建立TCP连接
      - 建立连接即需要协商参数：是否支持选择性确认、两端支持的最大报文是多少
    - 通信结束了，需要释放连接
  - UDP
    - 应用场景：
      - 1.要传输的内容一个数据包就完成了。（比如DNS域名解析）
      - 2.传输实时的语音和视频，因为这个需求实时性。中间丢几句话没听见，也不重传。要求实时。
      - 3.多播
    - 不需要分段，不需要流量控制
    - **传输成功与否，完全由应用层判断，UDP本身不保证可靠传输。**
    - 通信时，不需要建立连接。
      - 不建立连接，服务器就比较省心。不需要始终跟客户机保持连接。节省服务器资源。
  - yyd备注：
    - 卡了一会儿，数据还是来了，数据是完整的，那应该是TCP。TCP适合完整性要求高的。
      - 例如在线看腾讯视频
    - 卡了一会儿，数据丢了一些，那应该是UDP。UDP适合要求实时的。
      - 例如微信电话
- 二、传输层协议和应用层协议之间的关系
  - 传输层协议加一个端口号来标识一个应用层协议，展示了传输层协议和应用层协议之间的关系。
    - ![image-20201224155820937](https://i.loli.net/2020/12/24/VKZX7RJedlUBHAG.png)
- 三、服务和端口的关系
  - 有些服务为本地计算机提供服务
    - **为本地计算机提供服务的服务**，它不需要和网络中计算机通信，所以也就不需要什么TCP和端口
    - 比如：磁盘管理服务，我把virtual disk这个服务停止了，磁盘管理就打不开了
  - 有些服务**为网络中的计算机提供服务。**
    - 这种服务需要使用TCP或者UDP的某个端口侦听客户端的请求
    - 比如说：windows的远程连接默认端口TCP:3389
    - 即，为网络中计算机提供服务的**服务，一旦启动就会使用TCP或UDP的某个端口侦听客户端的请求。**
  - 为网络中计算机提供服务的服务，一旦启动就会使用TCP或UDP的某个端口侦听客户端的请求。
  - 客户端通过IP地址定位服务器，通过协议和端口号定位服务器上的服务。
    - ![image-20201224202904276](https://i.loli.net/2020/12/24/2sTzQMXgklBtDEa.png)
  - 应用层协议也可以不使用默认端口和客户端通信。

    - 如果不使用默认端口通信，客户端需要指明使用的端口。
- 四、端口和网络安全
  - 封端口基本等于封服务。
  - 防火墙的原理也就是看守端口
- 五、

## 8.应用层协议

### 8.1域名系统-DNS（Domain Name System）

#### 8.1.1.什么是域名

- 如果你的公司在互联网上有一组服务器（邮件服务器、FTP服务器、Web服务器等），你需要为你的公司先申请一个域名，也就是向管理认证机构注册一个域名。
- 域名的注册遵循先申请先注册为原则，管理认证机构要确保每一个域名的注册都是独一无二、不可重复的。

#### 8.1.2 域名的结构

- 域名 51cto.com

- 主机名www、ftp、blog，甚至任意取。只是大家习惯上用www、blog等词汇

- 一个域名下可以有多个主机，域名全球唯一，主机名+域名肯定也是全球唯一的，**主机名+域名称为完全限定域名（FQDN）。**

  - 完全限定域名才可以使用DNS在Internet解析。

- FQDN是Fully Qualified Domain Name的缩写, 含义是完整的域名。

- ```
  例如，一台机器主机名（hostname）是www, 域名后缀（domain）是51cto.com, 那么该主机的完全限定域名FQDN应该是www.51cto.com.
  ```

- ![image-20201228205330826](https://i.loli.net/2020/12/28/hENCeonHQqzwp6R.png)

  - 一个完全限定域名可以对应多个IP地址。镜像站点，用于负载均衡
  - 多个完全限定域名也可以对应同1个IP地址。一台电脑开启多个服务

- ![image-20201228210833836](https://i.loli.net/2020/12/28/ZTlcxqhWyotP5Mp.png)

  - www.baidu.com这个域名就有两个IP地址。DNS解析时会随机分配，实现负载均衡

#### 8.1.3域名的层次结构

- ![image-20201228211607688](https://i.loli.net/2020/12/28/TyOril82ZnN1YGw.png)
- 企业或个人申请了域名后，可以在该域名下添加多个主机名，也可以根据需要创建子域名，子域名下面，亦可以有多个主机名，
  - ![image-20201228211629837](https://i.loli.net/2020/12/28/etNGFgiu4WCIAVn.png)
- 所有域名都是以.开始，不过我们在使用时，**域名最后的.经常被省去**，如图所示，在命令提示符下`ping www.91xueit.com.`和`ping www.91xueit.com`是一样的。

#### 8.1.4域名解析的过程

- DNS服务器的层次
  - ![image-20201228213900120](https://i.loli.net/2020/12/28/YRUTKfZv4knVs8c.png)
- 解析过程
  - ![image-20201228213522713](https://i.loli.net/2020/12/28/1L3GDwydT2kxtSl.png)
- 网关（路由器）也可以当DNS服务器。网关里只知道根的地址，所以你解析任何域名，网关它都去问根服务器。
  - 你解析www.baidu.com、www.cctv.cn，任何后缀、任何主机名，网关都去问根。

#### 8.1.5 查看计算机缓存的域名解析结果

- ```
  PS C:\Users\admin> ipconfig /displaydns
   查看计算机缓存的域名解析结果
  ```

  - ![image-20201228215624149](https://i.loli.net/2020/12/28/zGpZWxR17yhqbId.png)

- ```
  PS C:\Users\admin> ipconfig /flushdns
  清空DNS解析缓存
  ```

  - ![image-20201228215720853](https://i.loli.net/2020/12/28/nVfFAbDatwGRI1Z.png)

- ```
  PS C:\Users\admin> nslookup www.baidu.com
  ```

  - ![image-20201228220433623](https://i.loli.net/2020/12/28/VPMjr7sDYwypZA5.png)
  - 114.114.114.114没有直接找到，而是转身问根才得到的解析结果，这就是非权威应答。
  - 114.114.114.114直接找到的，没有问别人，自己解析给你的，那就是权威应答。





### 8.2动态主机配置协议-DHCP

#### 静态地址与动态地址

- 使用静态地址的情况
  - IP地址不经常更改的设备就使用静态地址。
    - 比如企业中服务器会单独在一个网段，很少更改IP地址或移动到到其他网段，这些服务器通常使用静态地址，使用静态地址还方便企业员工使用地址访问这些服务器。
    - 比如学校机房，都是台式机，很少移动，这些计算机最好也使用静态地址。
- 使用动态地址的情况：
  - 网络中的计算机不固定，就应该使用动态地址。
  - 无线设备最好也使用动态地址。
  - ADSL拨号上网通常也是使用自动获得IP地址。

#### DHCP地址租约

- 地址以租约的形式提供给客户端
- 如果到租约时间了，客户端都没有跟DHCP更新租约，那么DHCP服务器就单方面废除租约，收回分配的IP地址
  - 以防，笔记本电脑网线一拔，走了，IP地址一直被占用浪费的情况

#### 租约的生成过程

- DHCP客户端会在以下所列举的几种情况下，从DHCP服务器获取一个新的IP地址。
  - 该客户端计算机是第一次从DHCP服务器获取IP地址。
  - 该客户端计算机原先所租用的IP地址已经被DHCP服务器收回，而且已经又租给其他计算机了，因此该客户端需要重新从DHCP服务器租用一个新的IP地址。
  - 该客户端自己释放原先所租用的IP地址，并要求租用一个新的IP地址。
  - 客户端计算机更换了网卡。
  - 客户端计算机转移到另一个网段。
- 租约生成过程
  - 1.DHCPDISCOVER ：**DHCP客户端会先送出**DHCPDISCOVER的**广播**信息到网络，以便寻找一台能够提供IP地址的DHCP服务器。
    - 客户端发广播说我要上网，请DHCP服务器给我一个IP
  - 2.DHCPOFFER ：当网络中的**DHCP服务器收到DHCP客户端**的DHCPDISCOVER**请求信息**后，就会从IP地址池中，挑选一个尚未出租的IP地址，然后**利用广播的方式传送给DHCP客户端。**
    - DHCP服务器发送回应给客户端，说我这儿有可用的
  - 3.DHCPREQUEST ：当DHCP客户端挑选好第一个收到的DHCPOFFER信息后，它就利用广播的方式，响应一个DHCPREQUEST信息给DHCP服务器。
    - 这是指如果网络中有多个DHCP服务器，那客户端还得挑一个地址。挑收到的第一个，然后跟这个DHCP服务器说，我想用你给我分配的IP
  - 4.DHCPACK ：DHCP服务器收到DHCP客户端要求IP地址的DHCPREQUEST信息后，就会利用广播的方式送出DHCPACK确认信息给DHCP客户端。
    - DHCP说好的，同意你使用
  - ![image-20201229154611383](https://i.loli.net/2020/12/29/G9d7YcZ8FJKlyPg.png)

#### DHCP地址租约更新-更新时机

- （1）当租约时间过去一半时，客户机向DHCP服务器发送一个请求，请求更新和延长当前租约。客户机直接向DHCP服务器发请求，最多可重发三次，分别在4、8和16s时。
- （2）如果某台服务器应答一个DHCP Offer消息，以更新客户机的当前租约，客户机就用服务器提供的信息更新租约并继续工作。
- （3）如果租约终止而且没有连接到服务器，客户机必须立即停止使用其租约IP地址。然后，客户机执行与它初始启动期间相同的过程来获得新的IP地址租约。

#### DHCP地址租约更新-更新方法

- 方法一：自动更新
  - DHCP服务自动进行租约的更新，也就是前面部分描述的租约更新的过程，**当租约期达到租约期限50％时，DHCP客户端（电脑、手机）将自动开始尝试续租该租约**。每次DHCP客户端重新启动的时候也将尝试续租该租约。为了续租其租约，DHCP客户端为它提供租约的DHCP服务器发出一个DHCPREQUEST请求数据包。如果该DHCP服务器可用，它将续租该租约并向DHCP客户端提供一个包含新的租约期和任何需要更新的配置参数值的DHCPACK数据包。当客户端收到该确认数据包后更新自己的配置。如果DHCP服务器不可用，客户端将继续使用现有的配置。
  - 即
    - 租约时间达到50% 找原来的DHCP服务器续约
    - 租约时间达到75% 找原来的DHCP服务器续约，如果没有续约成功，发广播请求地址
    - 租约时间达到100% 释放地址，生成169.254.0.0网段的默认windows地址
    - 重启计算机时，电脑会自动ping网关，如果通，那么看租约是否应该更新。如果不通，那就发广播包直接请求新的地址
- 方法二：手动更新
  - 如果需要立即更新DHCP配置信息，可以手工对IP地址租约进行续租操作，例如：如果我们希望DHCP客户端立即从DHCP服务器上得到一台新安装的路由器的地址，只需简单地在客户端做续租操作就可以了。
  - 直接在客户机上的命令提示符下，执行命令：Ipconfig  /renew
  - 人工释放租约：ipconfig /release

### 8.3远程终端协议-Telnet协议（类似于ssh，可以远程到windows系统命令行，linux命令行，路由器命令行）

- **TELNET是一个简单的远程终端协议**，它也是因特网的正式标准。用户使用telnet客户端就可以连接到远程运行Telnet服务的设备（可以是网络设备比如路由器、交换机，也可以是操作系统，比如Windows或Linux），进行远程管理。
- TELNET能将用户的键盘指令传到远地主机，同时也能将远地主机的输出通过TCP连接返回到用户屏幕。这种服务是透明的，因为用户感觉到好像键盘和显示器是直接连在远地主机上。因此，TELNET又称为终端仿真协议。
- TELNET并不复杂，以前应用得很多。现在由于操作系统（Windows和Linux）功能越来越强，用户己较少使用TELNET了。不过配置Linux服务器和**网络设备还是需要TELNET来实现远程管理和配置**

### 8.4远程桌面协议RDP

windows的远程桌面，即TCP+3389端口

### 8.5超级文本传输协议HTTP

#### 8.5.1 超级文本

- HTTP协议是超级文本传输协议，先看看什么是超级文本。 
- 一个网站通常是由一组网页组成，其中一个网页是首页，通过首页的超链接可以访问到该网站的其他网页，超链接也可以链接到其他网站。
  - ![image-20201229165414002](https://i.loli.net/2020/12/29/plOJPxBwvLVoW8k.png)

#### 8.5.2 html文件结构

- ```
  HTML文件均以<html>标记开始，以</html>标记结束。
  ```

- ```
  <head>...</head>标记之间的内容用于描述页面的头部信息，如页面的标题、作者、摘要、关键词、版权、自动刷新等信息。
  ```

- ```
  在<body>...</body>标记之间的内容为页面的主体内容。
  ```

- HTML文件的整体结构及对应的预览效果如图所示。

  - ![image-20201229170741806](https://i.loli.net/2020/12/29/7aZgIAN3td6JxSu.png)

#### 8.5.3统一资源定位符URL

- 全球统一，想找到http下的一个网页，或者是ftp下的一个文件，或者是流媒体服务器下的一个视频，都应该是这样的写法

- 统一资源定位符URL（Uniform Resoure Locator）是用来表示从因特网上得到的资源位置和访问这些资源的方法。URL给资源的位置提供一种抽象的识别方法，并用这种方法给资源定位。只要能够对资源定位，系统就可以对资源进行各种操作，如存取、更新、替换和查找其属性。

- URL是与因特网相连的机器上的任何可访问对象的一个指针。由于访问不同对象所使用的协议不同，所以URL还指出读取某个对象时所使用的协议。URL的一般形式由以下四个部分组成：

  - ```
    <协议>://<主机>:<端口>/<路径>
    ```

  - **例如访问网站的url**

    - ![image-20201229172138734](https://i.loli.net/2020/12/29/gMizH2xOyrktaDF.png)

  - **例如访问ftp的url**

    - <img src="https://i.loli.net/2020/12/29/PyrbXR95nLZ7juM.png" alt="image-20201229173840299" style="zoom:200%;" />

  - **例如流媒体服务的url**

    - ```
      mms ://WEBSERVER/racecar_300.wmv
      ```
  
- HTTP的URL的一般格式是：

  - ```
    http://<主机>:<端口>/<路径>
    ```

  - 如果HTTP使用的是默认端口号是80，通常可省略。若再省略文件的＜路径＞项，则URL就指到该网站的根目录下的主页（homepage）。

  - 更复杂一点的URL是指向网站第二级或第三级目录的网页。

    - `http://edu.51cto.com/member/id-2_1.html`

-  FTP的URL的一般格式：

  - ```
    ftp:// <主机>:<端口>/<路径>
    ```

  - ```
    比如北京邮电FTP服务器，ftp://ftp.bupt.edu.cn。FTP的URL中还可以包括登录FTP服务器的账户和密码，比如ftp://stargate:sg1@61.155.39.141:9921，其中登录名为stargate，密码为sg1，FTP服务器IP地址61.155.39.141，端口为9921。
    ```

#### 8.5.4 html文件里的绝对路径和相对路径

- html文件里的绝对路径和相对路径

  - 在Internet上访问资源时使用URL，网页中的超级链接指向其他网站的资源时也需要使用URL，网页中的超链接如果指向的同一个网站下的其他网页，就可以使用相对路径或根路径。在网页中添加超级链接需要搞明白使用绝对路径、相对路径还是根路径，需要确定当前文档同站点根目录之间的相对路径关系。链接可以分为以下3种：

    - ```
      绝对路径，如http://www.webjx.com
      ```

    - ```
      相对路径，如news/default.htm
      ```

    - ```
      根路径，如/website/news/default.htm
      ```

#### 8.5.5 web服务器

- 将网页通过网站发布出去，网络中的用户才能访问。IIS、Apache、Tomcat都可以搭建Web服务器，IIS服务是Windows操作系统的一个组件，安装后就可以创建Web站点，将编辑好的网页发布出去。
- 同一台主机可以创建多个web站点
  - 可以使用不同网卡作区分（即不同IP）
  - 使用不同的端口作区分。（一个80，一个81）
  - 使用域名区分（此时网站就不可以使用IP访问了，仅支持域名访问）

#### 8.5.6HTTP协议的版本

- 设计HTTP最初的目的是为了提供一种发布和接收HTML页面的方法。HTTP协议有三个版本HTTP/0.9、 HTTP/1.0、HTTP/1.1，HTTP2.0 目前HTTP/1.0和1.1被广泛应用。
- HTTP 1.0与HTTP 1.1的比较：
  - 一个WEB站点每天可能要接收到上百万的用户请求，为了提高系统的效率，**HTTP 1.0规定**浏览器与服务器只保持短暂的连接，**浏览器的每次请求都需要与服务器建立一个TCP连接**，服务器完成请求处理后立即断开TCP连接，服务器不跟踪每个客户也不记录过去的请求。
    - HTTP 1.0非常明显的缺点：一个网页除了有html文件还有很多图片或者其他文件组成，每一个文件都要建立独立的TCP连接。建立连接次数太多。
  - 为了克服HTTP 1.0的这个缺陷， **HTTP 1.1支持持续连接**，持续连接就是Web服务器在发送响应后仍然在一段时间内保持这条连接，使同一个客户（浏览器）和该服务器可以继续在这条连接上传送后续的HTTP请求报文和响应报文。
    - 整个过程就只有1个TCP连接。不论有多少文件。
- HTTP1.1有两种方式
  - ![image-20201229194354953](https://i.loli.net/2020/12/29/Chj9nuZsbzKctPR.png)
  - 流水线方式效率更高。

#### 8.5.7 HTTP请求报文和响应报文

- HTTP有两类报文：
  - 请求报文-从客户端向服务器发送请求报文。
  - 响应报文-从服务器到客户端的应答。
- ![image-20201229200227586](https://i.loli.net/2020/12/29/nxTkFlVLcv8SeC1.png)

#### 8.5.8 HTTP请求报文-post和get

- get
  - 请求资源
- post
  - 比如账号密码登录
  - 比如发帖子
  - 浏览器都是使用post方法发给web服务器的

#### 8.5.9HTTP响应报文状态代码

- 状态码（Status-Code）都是三位数字的，分为5大类共33种，例如：
  - lxx表示通知信息的，如请求收到了或正在进行处理。
  - 2xx表示成功，如接受或知道了。
  - 3xx表示重定向，如要完成请求还必须采取进一步的行动。
  - 4xx 表示客户端错误，如请求中有错误的语法或不能完成。
  - 5xx表示服务器的差错，如服务器失效无法完成请求。
- 下面三种状态行在响应报文中是经常见到的。
  - HTTP/1.1  200  Success （成功）
  - HTTP/1.1  202  Accepted  （接受）
  - HTTP/1.1  400  Bad Request （错误的请求）
  - HTTP/1.1  404  Not Found  （找不到）

#### 8.5.10 记录用户身份-Cookie

- Cookie意为“甜饼”，是由W3C组织提出，最早由Netscape社区发展的一种机制。目前Cookie已经成为标准，所有的主流浏览器如IE、Netscape、Firefox、Opera等都支持Cookie。
- 由于HTTP是一种无状态的协议，服务器单从网络连接上无从知道客户身份。怎么办呢？就给客户端们颁发一个通行证吧，每人一个，无论谁访问都必须携带自己通行证。这样服务器就能从通行证上确认客户身份了。这就是Cookie的工作原理。
- Cookie可以导出导入。
- 示例：
  - 点记住密码时，web服务器就会生成一个文件，把用户这个身份存在客户端。（cookie是存放在用户本机的）
  - 第二天，用户再打开网站时，网站就会读用户电脑上的cookie文件，看cookie里有没有用户身份
- cookie就是网站放在客户机的一个文件，用来记录客户机的身份，以实现记住密码或记住购物车中的商品等功能

#### 8.5.11通过web代理访问网站(仅仅代理访问网站的流量)

- 代理服务器英文全称是（Proxy Server），其功能就是代理网络用户去取得网络信息。我们可以配置计算机通过Web代理服务器访问Web站点，而不直接访问网站。
  - ![image-20201229205403075](https://i.loli.net/2020/12/29/tYhopNxE35Dwcse.png)

#### 8.5.12web代理服务器应用场景

- 1.让所有内网计算机都通过web代理服务器上网，可以控制内网计算机对internet的访问
  - 类似于高级防火墙
  - 比如：让路由器只允许web代理服务器D上网。然后所有的内网计算机比如ABC都要通过web代理服务器才能上网，这样web代理服务器D就可以设置规则控制ABC电脑的上网权限。
- 2.通过web代理绕过防火墙的封锁
  - 翻墙软件
- 3.使用web代理节省内网的上网带宽
  - web代理服务器可以缓存一些请求和响应，省的内网计算机重复访问同一网站占用多倍带宽



### 8.6文件传输协议FTP

### 8.7电子邮件（发邮件SMTP、收邮件POP3和IMAP）

## 9.网络安全

### 9.1计算机网络上的通信面临以下的四种威胁：

- (1) 截获——从网络上窃听他人的通信内容。
  - 截获http报文
- (2) 中断——有意中断他人在网络上的通信。
  - 拒绝服务式攻击，即dos攻击（Denial of Service）
- (3) 篡改——故意篡改网络上传送的报文。
  - 比如篡改域名解析结果
- (4) 伪造——伪造信息在网络上传送。
  - 冒充局域网下别人的IP
  - 比如局域网服务器只允许某个IP访问，那我就冒用别人的IP也去访问这个服务器
- ![image-20201230155401220](https://i.loli.net/2020/12/30/4yPzUkRjMnmogKJ.png)
- 实现原理：
  - 截获：只能截获一个局域网下的数据包
    - 比如A跟我处在同一个交换机下，A想登陆淘宝网，一看目标IP跟他自己不是一个网段，那A就发arp广播询问网关，问网关的mac是多少，发给网关，让网关发给淘宝网。
    - 而我跟A是一个交换机下，我也能收到那个arp，我就冒充网关，回复给A，网关的mac地址是我的mac，让他把数据包发到我这儿来，这样就能捕获A登录淘宝网的账号密码了。
  - 篡改：也只能篡改局域网下的
    - 跟上边一个道理，局域网下别人想上网，都被我欺骗了，数据包都转到我这儿，我再替他们转出去。
    - 比如A想dns解析一个域名，那也得转发到我这儿，我替他发出去去找DNS服务器解析，然后DNS服务器返回结果给我的计算机。我篡改一下这个结果，回复给A一个假的IP地址，这就是DNS劫持了，篡改了结果。
  - 中断：
    - 有意中断他人在网络上的通信。
      - 比如arp欺骗，两头骗，骗网关和骗别人的主机，让别人的主机arp解析网关mac时解析成一个不存在的mac，那别人的主机就上不了网了
    - 再比如 dos攻击
      - 拒绝服务式攻击，即dos攻击（Denial of Service）。
      - 使用udp炸弹，给目标网站发送大量没用的数据包，目标网站主机带宽不够用，网站就卡了，没法给客服提供正常服务了。
    - 再比如 DDos攻击
      - 黑客在网上，找到很多台有漏洞的主机，这种有漏洞的主机也有公网IP，可以被黑客操纵
      - 黑客操纵互联网上很多台主机，同时对一个网站进行数据包轰炸，这就叫做 分布式拒绝服务攻击 DDos
      - 让你的网站带宽不够用，没法为客户提供服务，这就是拒绝服务式攻击。很多台主机一起发动攻击，这就是分布式攻击。所以合称分布式拒绝服务攻击DDos。
      - 这种攻击没法有效防范，因为带宽被吃没了，防火墙也无能为力，电脑关了都不行。唯一解决途径只能让网站租用特别高带宽的服务器，你再多主机攻击我带宽都够用，比如我的网站的服务器有10G带宽，你就算ddos有100台主机攻击我，你一个主机也就才10M，100台才1G，完全攻不摊我的服务器。

### 9.2恶意程序

- (1) 计算机病毒——会“传染”其他程序的程序，“传染”是通过修改其他程序来把自身或其变种复制进去完成的。
- (2) 计算机蠕虫——通过网络的通信功能将自身从一个结点发送到另一个结点并启动运行的程序。
  - 它一点一点的消耗资源，比如cpu、内存，系统越来越慢。
- (3) 特洛伊木马——一种程序，它执行的功能超出所声称的功能。
  - 盗号木马，远程控制木马（灰鸽子）
  - **木马的特点：敌通外国，从你的本机向外界偷偷发送一些消息，比如你的qq密码**
  - **病毒不一样：病毒主要是搞破坏，并且可传染。**
  - 查看会话netstat -n 可以查看是否有可疑会话
- (4) 逻辑炸弹——一种当运行环境满足某种特定条件时执行其他特殊功能的程序。 

### 9.3加密技术

- 对称加密
  - 加密秘钥与解密秘钥是相同的密码体制
  - 优点：
    - 效率高
  - 缺点：
    - 秘钥不适合在网上传输。
    - 并且秘钥维护比较麻烦。
  - 对称加密使用DES算法，DES的保密性仅取决于对于秘钥的保密，而算法是公开的。
    - 56位密钥破解 需要3.5或21分钟
    - 128位密钥破解 需要5.4*10 18次方年
- 非对称加密
  - 加密秘钥和解密秘钥是不同的，它是秘钥对，分为公钥和私钥
  - 用法1：公钥加密，私钥解密。
  - 用法2：私钥加密，公钥解密。
  - 特点：
    - 你知道公钥，也推算不出私钥。你知道私钥，也推算不出公钥。	
    - 加密时效率低
- 数字签名（使用非对称加密的一个应用）
  - 三个作用：
    - 防止抵赖
    - 能够检查签名之后是否被更改（如果被更改了，那么数字签名失效）
      - 比如有时候安装驱动时，会问你，数字签名已经失效了，问你还装不装。那就有可能是别人在驱动里又夹杂了病毒，更改过文件，那么数字签名就失效了
    - 无法伪造数字签名
  - ![image-20201230222412379](https://i.loli.net/2020/12/30/lhYajiLIVGHgxJ4.png)
  - 怎么实现上述3个功能
    - 1）这个加密摘要可是由A的私钥加密产生的，那A公司没法抵赖。
      - 这个私钥就跟章一样
    - 2）一旦签名后文件内容被篡改，那B接受到以后，计算出的摘要与解密出的摘要，就不匹配了。那就警告说，签名失效。
    - 3）无法伪造数字签名。数字签名由A的私钥加密产生，然后由A的公钥解密，无法伪造。

### 9.4认证中心（证书颁发机构CA）

- 每个CA有自己的公钥和私钥
- 每个CA给各个公司发数字证书，即颁发给各个公司专属的公钥和私钥。
  - 也就是说各个公司的公钥私钥不能自己造，那得是认证机构颁发的。

### 9.5签名邮件和加密邮件

- 签名邮件：邮件内容是明文。只是标识一下发送方是可靠的。
  - 发送签名邮件，只需要发送方有CA证书（就是一套可靠的公钥和私钥）即可，并且接收方要信任该CA
- 加密邮件：邮件内容加密的。发送方需要有接收方的公钥，然后接收方用私钥来解密查看，保证邮件内容不会被别人看到。
  - 发送加密邮件，那发送方必须得有接收方的公钥。



- A有证书，B没有
- A想给B发**加密邮件**，那A得有B的公钥。
  - 所以A不能给B发加密邮件。
- A想给B发**签名邮件**，那只需要A有证书。即A有有一套公钥私钥即可。
  - A给B发邮件时，会给B发送  明文邮件+明文邮件摘要的A私钥加密版+A的公钥
  - B收到以后用 A的私钥 去解析A私钥加密版摘要 与 明文邮件摘要做对比，来判断邮件是否被篡改。
- 然后此时，B有了A的公钥，B就可以给A发加密邮件
  - A收到以后，可以自信地认为，该邮件未被任何人读过。因为是经过加密的。没有A的私钥，谁也看不了。
  - A用私钥一解密，就能看内容了。
- 如果AB都有证书，
  - 那就可以互发 加密+签名的邮件。

### 9.6安全套接字SSL（Secure Socket Layer）

#### 概要

- ![image-20210103193038511](https://i.loli.net/2021/01/03/H2DjxPlX8Zdk9IW.png)
- 发送方在数据从应用层给运输层之前，加密
- 接收方在数据从运输层给应用层之前，解密
- 因此https非常安全，即使数据被别人捕获了，别人也无法解密。因为只有客户机与服务器才知道这个对称秘钥。

#### SSL三大功能

- 1.SSL 服务器鉴别。    允许用户证实服务器的身份。具有 SSL 功能的浏览器维持一个表，上面有一些可信赖的认证中心 CA 
  - 一个CA证书绑定一个域名网站。
  - 我访问一个网站，它就得出示证书。如果访问淘宝网站，输进去的也是www.taobao.com，结果被人DNS劫持了，进入了假冒网站，不过假冒网站是不可能出示权威CA证书的，我就知道，它是假的。
  - 这个很有用，浏览器会提醒你这是钓鱼网站。
- 2.加密SSL会话。  客户和服务器交互的所有数据都在发送方加密，在接收方解密。
  - 这即下边所论述的http与https的区别。数据是由对称秘钥加密的。
  - 这个也很有用，对应用层数据加密，防止别人捕获。
- 3.SSL 客户鉴别    允许服务器证实客户的身份。
  - 服务器网站可以设置有CA证的客户端才可以访问，没CA证的客户不能访问。
  - 这个功能用的比较少。

#### 加密SSL会话详细过程（https）

- 简洁版（非正确版，也可以粗略这样理解）
  - ![image-20210103200543911](https://i.loli.net/2021/01/03/vairY43xAh6ozP2.png)
- 详细版（正确版）
  - 区别在于。其实随机数密码Pre-master不是对称秘钥。对称秘钥是使用两边的随机数C、S以及这个随机数密码Pre-master同时计算得到的。
    - 即enc_key=Func(random_C,random_S,Pre-Master)
    - Func即哈希散列。
  - ![image-20210103201228174](https://i.loli.net/2021/01/03/FXwtfRQonVxHsA5.png)
  - 比如：
  - ![image-20210103203010095](https://i.loli.net/2021/01/03/IbO5zKJPmhFuZ49.png)
  - 5009489_yangyadong.site.pem。服务器的CA证书
    - 里面包含服务器的公钥、颁发机构、有效期等。
  - 5009489_yangyadong.site.key。服务器的私钥
    - 服务器B用私钥 解密 客户端 使用B公钥加密的随机数字Pre-master。
    - 解密出来Pre-master才能算出来对称秘钥。
    - 有了对称秘钥，才能解密http报文。

#### 总结https

- 1.纯对称加密（服务端和客户端用一把相同的钥匙）
  - 解释：即同一套秘钥，进行加密和解密
  - 即服务端和客户端使用同一把秘钥加密解密，在https中不可以这样做。因为秘钥也得在网上传输，被黑客截获了就不安全了。
- 2.纯非对称加密（只有服务端的一套公钥私钥）
  - 解释：公钥加密，私钥可以解密。私钥加密，公钥可以解密。
  - **一般来说，客户端没有自己的公钥和私钥，只有服务端才有自己的公钥和私钥。**
  - 所以，客户端会跟服务端要到服务端的公钥。然后客服端对信息用服务端公钥加密上传给服务端。
    - 客户端给服务端的上行数据很安全，因为上行数据是使用服务端公钥加密的。黑客即使拦获了这个加密数据，他没有服务端私钥那也是解不开的。
  - 但是，服务端给客户端发信息时，那可是只能用服务端私钥加密的，然后客户端用服务端公钥解密。但是这个公钥，黑客也可以获得，黑客也可以解开，所以服务端给客户端这个下行数据是不安全的。
    - 服务端给客户端这个下行数据是不安全的。因为下行数据是使用服务端私钥加密的，谁用公钥都能解开。
    - 除非你说客户端也有自己的一套公钥私钥，下行数据使用客户端的公钥加密，那就可以安全。但是不能这样设计，客户端想有自己的一套公钥私钥，是要花钱的。（并且啊，就算客户端也有一套公钥私钥，两边都互用对方公钥加密，用自己私钥解密，确实可以保证安全。但是这种两套公钥私钥的一个致命缺点是，效率低！！！非对称加密解密，相比对称加密解密，慢很多倍）
- 3.对称+非对称结合（粗糙版）
  - **如果可以肆意的，谁也可以自己产生一对公钥私钥。那就会有中间人问题。**
  - 中间人就类似于代理似的，它拦获了你所有的数据，并帮你转发给服务器。
  - 这个中间人有一套自己的公钥私钥。
  - 问题的核心：发送给你的公钥，你不知道是真的服务器的，还是中间人的。
- 4.解决中间人问题（使用CA证书）
  - 只有经过CA认证的公钥，才是权威公钥。别的公钥，那都不安全。
    - 服务端的公钥+服务端信息+CA机构信息
    - 对上述信息算一个CA签名（摘要），然后用CA机构的私钥加密一下，就得到了这个服务器专属的CA证书。即pem文件。
    - **所以CA证书里，即pem文件里，包含了，【服务端的公钥+服务端信息+CA机构信息+CA私钥加密的CA签名】**
      - CA签名即（服务端的公钥+服务端信息+CA机构信息）的摘要。但是签名是要被CA私钥加密的。
  - 客服端连接服务端时，不是请求服务端公钥了，客户端就要求你出示CA证书。然后客户端拿到CA证书后，用CA机构的公钥（这被写死在了操作系统里）解密那个加密的CA签名。
    - 客户端可以直接获取【服务端的公钥+服务端信息+CA机构信息】，客户端也算一遍签名。然后用CA公钥解密 【CA私钥加密的CA签名】。两个签名（摘要）一比对，一致，说明【服务端的公钥+服务端信息+CA机构信息】没有被篡改。签名不一致，说明【服务端的公钥+服务端信息+CA机构信息】被篡改了，有风险。
  - 如果此时还有中间人，黑客在第一阶段介入，那么中间人即黑客向客户端发过来的假CA证书，我客户端一检查，假证书，那就不可靠。黑客是不可能模仿出真正的淘宝网的CA证书的，因为CA证书上包含CA私钥加密的CA签名，这无法伪造。
    - 即使黑客也注册一个有效的CA证书，比如yadong.site的证书，那也不行。因为CA证书上是写了唯一对应的网站的，你访问淘宝网，给你发过来一个yadong.site的证书，这谁信啊。
  - 如果黑客在第二阶段介入，那么拦获的信息是由客服端和服务端商定的临时对称秘钥加密的，这个对称秘钥使用服务端公钥加密的，黑客没有服务端的私钥，无法解密这个对称秘钥，也就无法解密报文了。
- 5.CA证书+非对称+对称来保证https安全，举个例子
  - ![image-20210103201228174](https://i.loli.net/2021/01/03/FXwtfRQonVxHsA5.png)
- 比如访问百度
  - C即client，S即server
  - 1.C->S     发送Client支持的SSL版本、支持的非对称算法、随机数random_C
  - 2.S->C    就用SSL1.0版本吧、我们以后用某某非对称算法、Hash算法、随机数random_S
    - S的证书也放里边
  - 3.Client端对S的证书进行检查。
    - 检查合法，才往下进行。检查不合法，会弹出警告。
  - 4.C->S    Pre-master、 





